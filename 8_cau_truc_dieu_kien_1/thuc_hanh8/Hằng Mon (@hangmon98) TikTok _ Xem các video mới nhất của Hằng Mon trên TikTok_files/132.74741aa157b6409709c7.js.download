(window.webpackJsonp_N_E=window.webpackJsonp_N_E||[]).push([[132],{"2//O":function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var o=n("3bRY"),r=n("A4rN");t.DelayFactory=function(e,t){var n=function(e){if(!e.delayFirstAttempt)return new o.SkipFirstDelay(e);return new r.AlwaysDelay(e)}(e);return n.setAttemptNumber(t),n}},"3bRY":function(e,t,n){"use strict";var o=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function o(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),r=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(r,s){function i(e){try{c(o.next(e))}catch(t){s(t)}}function a(e){try{c(o.throw(e))}catch(t){s(t)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,a)}c((o=o.apply(e,t||[])).next())}))},s=this&&this.__generator||function(e,t){var n,o,r,s,i={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return s={next:a(0),throw:a(1),return:a(2)},"function"===typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(s){return function(a){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;i;)try{if(n=1,o&&(r=2&s[0]?o.return:s[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,s[1])).done)return r;switch(o=0,r&&(s=[2&s[0],r.value]),s[0]){case 0:case 1:r=s;break;case 4:return i.label++,{value:s[1],done:!1};case 5:i.label++,o=s[1],s=[0];continue;case 7:s=i.ops.pop(),i.trys.pop();continue;default:if(!(r=(r=i.trys).length>0&&r[r.length-1])&&(6===s[0]||2===s[0])){i=0;continue}if(3===s[0]&&(!r||s[1]>r[0]&&s[1]<r[3])){i.label=s[1];break}if(6===s[0]&&i.label<r[1]){i.label=r[1],r=s;break}if(r&&i.label<r[2]){i.label=r[2],i.ops.push(s);break}r[2]&&i.ops.pop(),i.trys.pop();continue}s=t.call(e,i)}catch(a){s=[6,a],o=0}finally{n=r=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,a])}}};Object.defineProperty(t,"__esModule",{value:!0});var i=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return o(t,e),t.prototype.apply=function(){return r(this,void 0,void 0,(function(){return s(this,(function(t){return[2,!!this.isFirstAttempt||e.prototype.apply.call(this)]}))}))},Object.defineProperty(t.prototype,"isFirstAttempt",{get:function(){return 0===this.attempt},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"numOfDelayedAttempts",{get:function(){return this.attempt-1},enumerable:!0,configurable:!0}),t}(n("VZoR").Delay);t.SkipFirstDelay=i},A4rN:function(e,t,n){"use strict";var o=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function o(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}();Object.defineProperty(t,"__esModule",{value:!0});var r=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return o(t,e),t}(n("VZoR").Delay);t.AlwaysDelay=r},CK8W:function(e,t,n){"use strict";n.r(t),n.d(t,"BytedIM",(function(){return R})),n.d(t,"SdkConsts",(function(){return i.l})),n.d(t,"WebSocketLevel",(function(){return i.q})),n.d(t,"InfoKeys",(function(){return i.h})),n.d(t,"ServerMessageStatus",(function(){return i.n})),n.d(t,"ConversationType",(function(){return i.b})),n.d(t,"ConversationStatus",(function(){return i.a})),n.d(t,"StickTopState",(function(){return i.p})),n.d(t,"MuteState",(function(){return i.k})),n.d(t,"FavoriteState",(function(){return i.e})),n.d(t,"InitResult",(function(){return i.i})),n.d(t,"MessageSource",(function(){return i.j})),n.d(t,"IMEvent",(function(){return i.g})),n.d(t,"ErrorType",(function(){return i.d})),n.d(t,"FlightStatus",(function(){return i.f})),n.d(t,"StatusCodeMap",(function(){return i.o})),n.d(t,"SendMessageStatusCode",(function(){return i.m})),n.d(t,"CreateConvertsationStatusCode",(function(){return i.c})),n.d(t,"Conversation",(function(){return y.a})),n.d(t,"ConversationCoreInfo",(function(){return A.a})),n.d(t,"ConversationSettingInfo",(function(){return N.a})),n.d(t,"PropertyStatus",(function(){return h.b})),n.d(t,"Message",(function(){return h.a})),n.d(t,"BaseError",(function(){return p.a})),n.d(t,"MessageManager",(function(){return k.a})),n.d(t,"ConversationManager",(function(){return S.a})),n.d(t,"Monitor",(function(){return T.a})),n.d(t,"Logger",(function(){return a.a})),n.d(t,"LoggerLevel",(function(){return a.b})),n.d(t,"BasePlugin",(function(){return q.a})),n.d(t,"BaseApiManager",(function(){return c.a})),n.d(t,"DbProxy",(function(){return P})),n.d(t,"EventBus",(function(){return v.a})),n.d(t,"Subject",(function(){return b.a})),n.d(t,"Subscription",(function(){return b.b})),n.d(t,"Context",(function(){return l.a})),n.d(t,"BaseProcessor",(function(){return j.a})),n.d(t,"Version",(function(){return D.a})),n.d(t,"im_proto",(function(){return s.a})),n.d(t,"serialize",(function(){return _.c})),n.d(t,"deserialize",(function(){return _.a})),n.d(t,"serializeFrame",(function(){return _.d})),n.d(t,"deserializeFrame",(function(){return _.b})),n.d(t,"Long",(function(){return o}));var o=n("1277"),r=n("Ai7W"),s=n("ba9d"),i=n("VXtF"),a=n("7af5"),c=n("xQJc"),d=function(e,t,n,o){return new(n||(n=Promise))((function(r,s){function i(e){try{c(o.next(e))}catch(t){s(t)}}function a(e){try{c(o.throw(e))}catch(t){s(t)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,a)}c((o=o.apply(e,t||[])).next())}))};class u extends c.a{SendMessage(e){return d(this,void 0,void 0,(function*(){const t=s.a.RequestBody.create({send_message_body:{conversation_id:e.conversationId,conversation_short_id:e.conversationShortId,conversation_type:e.conversationType,content:e.content,mentioned_users:e.mentionedUsers,client_message_id:e.clientId,ticket:e.ticket,message_type:e.messageType,ext:e.ext}});return(yield this.send(t,s.a.IMCMD.SEND_MESSAGE,{inboxType:e.inboxType})).send_message_body}))}GetMessagesByUser(e){return d(this,void 0,void 0,(function*(){const t=s.a.RequestBody.create({messages_per_user_body:{cursor:e.cursor,limit:e.limit}});try{return(yield this.send(t,s.a.IMCMD.GET_MESSAGES_BY_USER,{inboxType:e.inboxType,maxRetryTimes:1})).messages_per_user_body}catch(n){return a.a.Instance.warn(`pull user error:${n}, ignore`),s.a.MessagesPerUserResponseBody.create({next_cursor:e.cursor,has_more:!1,messages:[]})}}))}GetMessagesByUserInitV2(e){return d(this,void 0,void 0,(function*(){const t=s.a.RequestBody.create({messages_per_user_init_v2_body:{cursor:e.cursor}});return(yield this.send(t,s.a.IMCMD.GET_MESSAGES_BY_USER_INIT_V2,{inboxType:e.inboxType,forceHttp:!0,maxRetryTimes:10})).messages_per_user_init_v2_body}))}GetMessagesByConversation(e){return d(this,void 0,void 0,(function*(){const t=s.a.RequestBody.create({messages_in_conversation_body:{conversation_id:e.conversationId,conversation_short_id:e.conversationShortId,conversation_type:e.conversationType,anchor_index:e.anchorIndex,limit:e.limit,direction:e.direction}});return(yield this.send(t,s.a.IMCMD.GET_MESSAGES_BY_CONVERSATION,{inboxType:e.inboxType,forceHttp:!0})).messages_in_conversation_body}))}CreateConversationV2(e){return d(this,void 0,void 0,(function*(){const t=s.a.RequestBody.create({create_conversation_v2_body:{conversation_type:e.type,participants:e.participants,persistent:e.persistent,idempotent_id:e.idempotentId,name:e.name,avatar_url:e.avatarUrl,description:e.desc,biz_ext:e.bizExt}});return(yield this.send(t,s.a.IMCMD.CREATE_CONVERSATION_V2,{inboxType:e.inboxType})).create_conversation_v2_body}))}GetConversationInfoListV2(e){return d(this,void 0,void 0,(function*(){const t=s.a.RequestBody.create({get_conversation_info_list_v2_body:{conversation_info_list:e.conversations.map(e=>({conversation_id:e.conversationId,conversation_short_id:e.conversationShortId,conversation_type:e.conversationType}))}});return(yield this.send(t,s.a.IMCMD.GET_CONVERSATION_INFO_LIST_V2,{inboxType:e.inboxType})).get_conversation_info_list_v2_body}))}MarkConversationReadV3(e){return d(this,void 0,void 0,(function*(){const t=s.a.RequestBody.create({mark_conversation_read_body:{conversation_id:e.conversationId,conversation_short_id:e.conversationShortId,conversation_type:e.conversationType,read_message_index:e.readIndex,conv_unread_count:e.unreadCount,total_unread_count:e.totalUnreadCount}});return this.send(t,s.a.IMCMD.MARK_CONVERSATION_READ_V3,{inboxType:e.inboxType})}))}RecallMessage(e){return d(this,void 0,void 0,(function*(){const t=s.a.RequestBody.create({recall_message_body:{conversation_id:e.conversationId,conversation_short_id:e.conversationShortId,conversation_type:e.conversationType,server_message_id:e.serverId}});return this.send(t,s.a.IMCMD.RECALL_MESSAGE,{inboxType:e.inboxType})}))}GetConversationCoreInfo(e){return d(this,void 0,void 0,(function*(){const t=s.a.RequestBody.create({get_conversation_core_info_body:{conversation_id:e.conversationId,conversation_short_id:e.conversationShortId,conversation_type:e.conversationType}});return this.send(t,s.a.IMCMD.GET_CONVERSATION_CORE_INFO,{inboxType:e.inboxType})}))}GetTicket(e){return d(this,void 0,void 0,(function*(){const t=s.a.RequestBody.create({get_ticket_body:{ticket_type:i.l.ticketType,conversation_type:e.conversationType,conversation_short_id:e.shortId,to_id:e.toId,ext:e.ext}});return(yield this.send(t,s.a.IMCMD.GET_TICKET)).get_ticket_body}))}}var l=n("+ZTy"),p=n("39GT"),v=n("YnhK"),y=n("r7qN"),h=n("VYFf"),f=n("CeZg"),g=n("suZz"),I=n("mEaV"),b=n("UMnf");function m(e,t,n,o){let r=n=n||0,s=o=o||e.length-n,i=0;for(r=n,s=o,i=0;r<s;){const n=e[r++];let o=n>>4;if(o>0){let n=o+240;for(;255===n;)n=e[r++],o+=n;const a=r+o;for(;r<a;)t[i++]=e[r++];if(r===s)return i}const a=e[r++]|e[r++]<<8;if(0===a||a>i)return-(r-2);let c=15&n,d=c+240;for(;255===d;)d=e[r++],c+=d;let u=i-a;const l=i+c+4;for(;i<l;)t[i++]=t[u++]}return i}Math.imul||(Math.imul=function(e,t){const n=65535&e,o=65535&t;return n*o+((e>>>16)*o+n*(t>>>16)<<16)|0});var _=n("4yet");const w={[s.a.IMCMD.SEND_MESSAGE]:"v1/message/send",200:"v1/message/get_by_user",203:"v2/message/get_by_user_init",300:"v1/conversation/get_list",301:"v1/message/get_by_conversation",400:"v1/account/online",401:"v1/account/offline",410:"v1/client/user_action",411:"v1/client/input_status",603:"v1/conversation/delete",608:"v2/conversation/get_info",609:"v2/conversation/create",610:"v2/conversation/get_info_list",611:"v2/conversation/get_by_favorite",612:"v2/conversation/get_by_top",614:"v1/conversation/dissolve",605:"v1/conversation/participants_list",650:"v1/conversation/add_participants",651:"v1/conversation/remove_participants",652:"v1/conversation/leave",655:"v1/conversation/update_participant",701:"v1/message/delete",702:"v1/message/recall",705:"v1/message/set_property",902:"v1/conversation/set_core_info",904:"v1/conversation/upsert_core_ext_info",921:"v1/conversation/set_setting_info",922:"v1/conversation/upsert_settings_ext",1001:"v1/stranger/get_conversation_list",1002:"v1/stranger/get_messages",1003:"v1/stranger/delete_message",1004:"v1/stranger/delete_conversation",1005:"v1/stranger/delete_all_conversations",1006:"v1/stranger/mark_read_conversation",1007:"v1/stranger/mark_read_all_conversations",2e3:"v3/conversation/get_read_index",2001:"v3/conversation/get_min_index",2002:"v3/conversation/mark_read",2003:"v1/media/get_upload_token",2004:"v1/media/get_urls",2006:"v1/conversation/list",2007:"v1/broadcast/send_message",2008:"v1/broadcast/recv_message",2009:"v1/broadcast/user_counter",2010:"v1/client/ack",2011:"v1/voip/create",2012:"v1/voip/call",2013:"v1/voip/update",2014:"v1/channel/heartbeat",2015:"v1/profile/get_info",2016:"v1/client/report_metrics",2017:"v1/config/get",[s.a.IMCMD.MODIFY_MESSAGE_EXT]:"v1/message/modify_ext",[s.a.IMCMD.UNREAD_COUNT_REPORT]:"/v1/client/unread_count",[s.a.IMCMD.SEND_MESSAGE_P2P]:"/v1/send_message/p2p",[s.a.IMCMD.GET_BLOCKLIST]:"/v1/blacklist/get",[s.a.IMCMD.SET_BLOCKLIST]:"/v1/blacklist/set",[s.a.IMCMD.CHECK_IN_BLOCKLIST]:"/v1/blacklist/check"};function x(e){var t;return null!==(t=w[e])&&void 0!==t?t:""}var T=n("EbSe"),C=function(e,t,n,o){return new(n||(n=Promise))((function(r,s){function i(e){try{c(o.next(e))}catch(t){s(t)}}function a(e){try{c(o.throw(e))}catch(t){s(t)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,a)}c((o=o.apply(e,t||[])).next())}))};class M{constructor(e,t){var n;this.onMessage=new b.a,this.reqMap=new Map,this.manuallyClosed=!1,this.getSeqId=(()=>{let e=1e4;return()=>(e+=1,e)})(),this.http=null!==e&&void 0!==e?e:Object(f.d)(l.a.Instance.option),(null===(n=l.a.Instance.option)||void 0===n?void 0:n.webSocketLevel)!==i.q.Disable&&(this.ws=null!==t&&void 0!==t?t:Object(f.e)(l.a.Instance.option),this.ws.onMessage.subscribe(e=>this.receiveRaw(e)),this.ws.onClose.subscribe(()=>this.onWsClose()))}refreshToken(){var e;return C(this,void 0,void 0,(function*(){if("function"===typeof l.a.Instance.option.token){const e=T.a.performanceNow();let n=null;try{const e=l.a.Instance.option.token();n=e instanceof Promise?yield e:e}catch(t){throw new p.a({msg:"failed while fetch token",type:i.d.TokenFuncError,sender:this})}if(null!==n)return l.a.Instance.cachedToken=n,T.a.Instance.emitCounter(T.b.BizRefreshToken),T.a.Instance.emitDuration(T.b.BizRefreshToken,e),a.a.Instance.debug("token cached from function: ",l.a.Instance.cachedToken),n;throw new p.a({msg:"token is null",type:i.d.TokenFuncError,sender:this})}return l.a.Instance.cachedToken=l.a.Instance.option.token,a.a.Instance.debug("token cached from const: ",l.a.Instance.cachedToken),null===(e=l.a.Instance.option)||void 0===e?void 0:e.token}))}createReq(e){var t,n,r,a,c,d,u;return C(this,void 0,void 0,(function*(){const v=null===(t=l.a.Instance.option)||void 0===t?void 0:t.inboxType;if(void 0!==e.inboxType&&e.inboxType<0||void 0===v&&void 0===e.inboxType||Array.isArray(v)&&v.length>2&&void 0===e.inboxType)throw new p.a({msg:"no available inboxType is provided",type:i.d.InvalidInboxType,sender:this});const y=l.a.Instance.cachedToken;let h;h=void 0!==e.inboxType?e.inboxType:Array.isArray(v)?v[0]:void 0!==v?v:0;let f=s.a.Request.create({body:e.body,cmd:e.cmd,sequence_id:o.fromNumber(e.seqId),refer:i.l.refer,token:y,headers:l.a.Instance.option.headers,device_id:l.a.Instance.option.deviceId,sdk_version:i.l.sdkVersion,build_number:i.l.buildNumber,inbox_type:h,device_platform:null===(n=l.a.Instance.option)||void 0===n?void 0:n.devicePlatform,channel:null===(r=l.a.Instance.option)||void 0===r?void 0:r.channel,device_type:null===(a=l.a.Instance.option)||void 0===a?void 0:a.deviceType,os_version:null===(c=l.a.Instance.option)||void 0===c?void 0:c.osVersion,version_code:null===(d=l.a.Instance.option)||void 0===d?void 0:d.versionCode,auth_type:null===(u=l.a.Instance.option)||void 0===u?void 0:u.authType});for(const e of l.a.Instance.plguins)f=yield e.sendPacket(f);return f}))}sendByBeacon({body:e,cmd:t,inboxType:n,seqId:o}){var r;return C(this,void 0,void 0,(function*(){const s=yield this.createReq({body:e,cmd:t,inboxType:n,seqId:o});let i=x(t);i||a.a.Instance.warn(`no url found for cmd: ${t}, using fallback`),(null===(r=l.a.Instance.option)||void 0===r?void 0:r.apiUrl.endsWith("/"))||(i="/"+i),a.a.Instance.debug("Beacon Request SeqId -> "+s.sequence_id,s),this.http.sendBeacon(l.a.Instance.option.apiUrl+i,s)}))}sendByHttp({body:e,cmd:t,inboxType:n,seqId:o}){var r;return C(this,void 0,void 0,(function*(){const s=T.a.performanceNow(),c=yield this.createReq({body:e,cmd:t,inboxType:n,seqId:o});let d=x(t);d||a.a.Instance.warn(`no url found for cmd: ${t}, using fallback`),(null===(r=l.a.Instance.option)||void 0===r?void 0:r.apiUrl.endsWith("/"))||(d="/"+d),a.a.Instance.debug("Http Request SeqId -> "+c.sequence_id,c);try{const e=yield this.http.sendRequest(l.a.Instance.option.apiUrl+d,c);return a.a.Instance.debug("Http Response SeqId -> "+e.sequence_id,e),{startTime:s,req:c,res:e}}catch(u){throw new p.a({msg:"network error",type:i.d.NetworkError,innerError:u,allowRetry:!0,sender:this,ignoreEvent:!0})}}))}sendByWs({body:e,cmd:t,inboxType:n,seqId:r}){return C(this,void 0,void 0,(function*(){const c=T.a.performanceNow(),d=yield this.createReq({body:e,cmd:t,inboxType:n,seqId:r}),u=Object(_.c)(d),v=s.a.Frame.create({service:l.a.Instance.option.service,method:l.a.Instance.option.method,headers:Object.entries(l.a.Instance.option.headers).map(([e,t])=>({key:e,value:t})),seqid:o.fromNumber(r),logid:o.fromNumber(Date.now()),payload_type:"pb",payload:u});a.a.Instance.debug("WS Request SeqId -> "+d.sequence_id,d);try{this.ws.send(Object(_.d)(v))}catch(f){throw new p.a({msg:"network error",type:i.d.NetworkError,innerError:f,allowRetry:!0,sender:this})}const y={startTime:c,req:d},h=new Promise((e,t)=>{y.wsPromise={resolve:e,reject:t},this.reqMap.set(r,y)});return yield h}))}receiveRaw(e){try{const n=Object(_.b)(e);if(n.service!==l.a.Instance.option.service&&!l.a.Instance.option.acceptIncorrectFrame)return a.a.Instance.warn(`WS Response dropped, local serviceId=${l.a.Instance.option.service}, message=${n.service}`),void v.a.Instance.emit(i.g.WebSocketReceiveUnexpectedFrame,this,n);let o=n.payload;if(void 0===o||null===o)return void a.a.Instance.warn("payload undefined or null");if("__lz4"===n.payload_encoding){let e=new Uint8Array(4*o.length),t=0;if(t=m(o,e),(t<0||t>e.length||t<o.length)&&(a.a.Instance.debug("WS response with lz4 compress, but first time decompressed failed, try second time"),e=new Uint8Array(1024e3),t=m(o,e),t<0||t>e.length||t<o.length))return void a.a.Instance.warn("WS response with lz4 compress, try second time fail.");o=e.slice(0,t)}try{const e=Object(_.a)(o),t=s.a.Response.create(e),n=l.a.Instance.option.inboxType;let r=[];if(r=Array.isArray(n)?n:void 0!==n?[n]:[0],-1===r.indexOf(t.inbox_type)&&!l.a.Instance.option.acceptIncorrectInboxType)return void a.a.Instance.warn(`WS Response dropped, local inboxType=${l.a.Instance.option.inboxType}, message=${t.inbox_type}`,"resp:",t);const i=t.sequence_id.toNumber(),c=this.reqMap.get(i);c?(a.a.Instance.debug("WS Response SeqId -> "+t.sequence_id,t),c.res=t,c.wsPromise.resolve(c),this.reqMap.delete(i)):t.sequence_id.eq(0)?(a.a.Instance.debug("WS Push",t),this.receive(t)):a.a.Instance.warn("WS Response dropped, no handler",t)}catch(t){a.a.Instance.warn("WS Response dropped, IM Response deserialize fail, hex dump:",t,"frame:",n)}}catch(n){a.a.Instance.warn("WS Response dropped, Frame deserialize fail, hex dump: ",n)}}send(e,t,n={}){var o,r;return C(this,void 0,void 0,(function*(){const c=this.getSeqId();if(n.useBeacon)return yield this.sendByBeacon({body:e,cmd:t,seqId:c,inboxType:n.inboxType}),s.a.Response.create({});const d=0===n.maxWsRetryTimes?0:3;let u=0===d?null!==(o=n.maxHttpRetryTimes)&&void 0!==o?o:3:null!==(r=n.maxHttpRetryTimes)&&void 0!==r?r:1;0===u&&(u=1);let v=0,y=0;return Object(g.backOff)(()=>{let o=!1;const r=new Promise((e,n)=>{const r=setTimeout(()=>{if(clearTimeout(r),!o)return T.a.Instance.emitCounter(T.b.NetworkTimeout,1,{cmd:s.a.IMCMD[t]}),this.reqMap.delete(c),void n(new p.a({msg:"request timeout",type:i.d.NetworkError,allowRetry:!0,ignoreEvent:!0,sender:this}))},l.a.Instance.option.timeout)});return Promise.race([r,(()=>C(this,void 0,void 0,(function*(){let r,l=!1;if(v<d&&void 0!==this.ws&&this.ws.isOpen()&&(l=!0),0!==d&&v>=d&&0===y&&void 0!==this.ws&&(a.a.Instance.warn("fallback to http"),this.closeWs(!0),l=!1),y>=u)throw new p.a({msg:"max retry times limit exceeded, stop requesting",type:i.d.NetworkError,sender:this});l&&void 0!==this.ws?(v++,r=this.sendByWs({body:e,cmd:t,inboxType:n.inboxType,seqId:c})):(y++,r=this.sendByHttp({body:e,cmd:t,inboxType:n.inboxType,seqId:c}));try{const{startTime:e,req:n,res:a}=yield r;if(T.a.Instance.emitNetwork(n,a),500===a.status_code&&(a.error_desc.includes("i/o timeout")||a.error_desc.includes("rpc timeout")||a.error_desc.includes("RPC timeout"))||a.error_desc.includes("connection timeout")||a.error_desc.includes("request timeout"))throw T.a.Instance.emitCounter(T.b.NetworkTimeout),this.reqMap.delete(c),new p.a({msg:"request timeout",type:i.d.NetworkError,allowRetry:!0,ignoreEvent:!0,sender:this});return o=!0,T.a.Instance.emitDuration(T.b.NetworkSuccess,e,{cmd:s.a.IMCMD[t],method:l?"ws":"http"}),T.a.Instance.emitCounter(T.b.NetworkSuccess,1,{cmd:s.a.IMCMD[t],method:l?"ws":"http"}),a}catch(h){throw h.type?h:(T.a.Instance.emitCounter(T.b.NetworkError),new p.a({msg:"request error",type:i.d.NetworkError,allowRetry:h.allowRetry,innerError:h,sender:this}))}})))()])},{maxDelay:3e3,jitter:I.JitterTypes.Full,numOfAttempts:11,retry:(e,t)=>(a.a.Instance.warn(`req ${c} failed, retrying @ attempt ${t}, inner err:`,e),!!e.allowRetry),startingDelay:500,timeMultiple:1.5})}))}sendByHttpTo(e,t,n){return C(this,void 0,void 0,(function*(){return"undefined"!==typeof fetch?(yield fetch(e)).arrayBuffer():this.http.send(e,t,n)}))}receive(e){T.a.Instance.emitNetwork(null,e),this.onMessage.next(e,this)}onWsClose(){var e,t;return C(this,void 0,void 0,(function*(){a.a.Instance.debug("ws closed"),v.a.Instance.emit(i.g.WebSocketDisconnected,this,this.ws),T.a.Instance.emitCounter(T.b.WebSocketDisconnect),null===(e=this.ws)||void 0===e||e.onClose.unsubscribe(this.closeHandler),null===(t=this.ws)||void 0===t||t.onError.unsubscribe(this.errorHandler)}))}closeWs(e){var t;(null===(t=l.a.Instance.option)||void 0===t?void 0:t.webSocketLevel)!==i.q.Disable&&(this.ws&&this.ws.close(),this.manuallyClosed=!e)}connectWs(e){var t,n,o,r;return C(this,void 0,void 0,(function*(){if((null===(t=l.a.Instance.option)||void 0===t?void 0:t.webSocketLevel)!==i.q.Disable){if(!this.manuallyClosed||!e)return null===(n=this.ws)||void 0===n||n.dispose(),null===(o=this.ws)||void 0===o||o.onClose.unsubscribe(this.closeHandler),null===(r=this.ws)||void 0===r||r.onError.unsubscribe(this.errorHandler),this.closeWs(!0),this.ws=Object(f.e)(l.a.Instance.option),this.ws.onMessage.subscribe(e=>this.receiveRaw(e)),this.closeHandler=this.ws.onClose.subscribe(()=>this.onWsClose()),this.errorHandler=this.ws.onError.subscribe(()=>this.onWsClose()),this.ws.onOpen.subscribe(()=>{a.a.Instance.debug("ws connected"),v.a.Instance.emit(i.g.WebSocketConnected,this,this.ws),T.a.Instance.emitCounter(T.b.WebSocketConnect),this.manuallyClosed=!1}),this.ws.open();a.a.Instance.debug("ignore connect since manually closed")}}))}}var S=n("Fjbr"),k=n("Hd7d"),O=n("dOJp"),E=function(e,t,n,o){return new(n||(n=Promise))((function(r,s){function i(e){try{c(o.next(e))}catch(t){s(t)}}function a(e){try{c(o.throw(e))}catch(t){s(t)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,a)}c((o=o.apply(e,t||[])).next())}))};class R{constructor(e,t){this.disposed=!1,this.plugins=[],this.innerCursor=[],this.tickerInterval=null,this.tickerIntervalHandler=null,this.isProcessing=!1,r.util.Long=o,r.configure(),e.headers||(e.headers={}),e.extended||(e.extended={}),e.boe?("string"===typeof(e=function(e){const t={appId:0,token:"",deviceId:"",userId:"",apiUrl:"",frontierUrl:"",authType:s.a.AuthType.TOKEN_AUTH,inboxType:[0],timeout:2e3,headers:{},fpId:89,appKey:"e0f82475ab9dbf5717d18b4a9c0d7fd0",service:2,method:1,debug:!0,pullInterval:3e4,throttle:1e3};return Object.assign(t,e),t.pullInterval&&t.pullInterval<3e4&&t.pullInterval<=0&&(t.pullInterval=3e4),t}(e)).boe&&(e.headers[i.l.envKey]=e.boe,e.headers[i.l.boeHeaderKey]="1"),"boolean"===typeof e.boe&&(e.headers[i.l.boeHeaderKey]="1")):"string"===typeof(e=function(e){const t={appId:0,token:"",deviceId:"",userId:"",apiUrl:"",frontierUrl:"",authType:s.a.AuthType.TOKEN_AUTH,inboxType:[0],timeout:2e3,headers:{},fpId:89,appKey:"e0f82475ab9dbf5717d18b4a9c0d7fd0",service:2,method:1,pullInterval:3e4,throttle:1e3};return Object.assign(t,e),t.pullInterval&&t.pullInterval<3e4&&t.pullInterval<=0&&(t.pullInterval=3e4),t}(e)).ppe?(e.headers[i.l.envKey]=e.ppe,e.headers[i.l.ppeHeaderKey]="1"):e.canary&&(e.headers[i.l.envKey]="canary"),l.a.Instance=new l.a,T.a.Instance=new T.a,a.a.Instance=new a.a,v.a.Instance=new v.a,S.a.Instance=new S.a,k.a.Instance=new k.a,l.a.Instance.option=e,l.a.Instance.userId=e.userId,function(e){"number"!==typeof e.appId&&a.a.Instance.error("opt.appId is not a number! did you pass a string?"),"string"!==typeof e.deviceId&&a.a.Instance.error("opt.deviceId is not a string! did you pass a number?"),"string"!==typeof e.userId&&a.a.Instance.error("opt.userId is not a string! did you pass a number?"),"string"===typeof e.apiUrl&&0!==e.apiUrl.length||a.a.Instance.error("opt.apiUrl invalid"),"string"===typeof e.frontierUrl&&0!==e.frontierUrl.length||a.a.Instance.error("opt.frontierUrl invalid")}(e);const n=new M,c=new u(n);this.api=c,this.network=n,l.a.Instance.api=c;const d={instance:this,netManager:n,convManager:S.a.Instance,msgManager:k.a.Instance,eventBus:v.a.Instance,context:l.a.Instance,logger:a.a.Instance,montior:T.a.Instance};if(e.debug){let t="undefined"!==typeof window?window:e.injectContext,n="ctx";if("object"===typeof e.injectContext&&(t=e.injectContext,e.injectContext=!0),"string"===typeof e.injectContext&&(n=e.injectContext,e.injectContext=!0),"undefined"===typeof e.injectContext&&(e.injectContext=!0),"boolean"===typeof e.injectContext&&e.injectContext)try{Object.defineProperty(t,n,{enumerable:!1,configurable:!0,get:()=>d})}catch(p){a.a.Instance.debug("inject ctx:",d,`with name: ${n} to`,t,"failed: ",p)}}Array.isArray(t)&&t.forEach(e=>{const t=new e;t.preInstall(this,d),t.install(),this.plugins.push(t)}),l.a.Instance.plguins=this.plugins,a.a.Instance.debug("loaded plugin:",this.plugins),e.boe?a.a.Instance.debug("using boe env: "+(!0===e.boe?"default":e.boe)):e.ppe&&a.a.Instance.debug("using ppe env: "+e.ppe),this.network.onMessage.subscribe(e=>this.receivePacket(e)),Object.freeze&&Object.freeze(d),Object.seal&&(Object.seal(this),Object.seal(R.prototype))}get initResult(){return l.a.Instance.initResult}set initResult(e){l.a.Instance.initResult=e}get event(){return v.a.Instance}getUserCursor(e){var t;return null!==(t=this.innerCursor[null!==e&&void 0!==e?e:this.getPriorityDefaultInboxType()])&&void 0!==t?t:o.ZERO}setUserCursor(e,t){var n;if(e.eq(o.ZERO))return;const r=null!==t&&void 0!==t?t:this.getPriorityDefaultInboxType(),s=this.innerCursor[r];s&&!s.lt(e)||(a.a.Instance.debug(`update cursor from ${null===s||void 0===s?void 0:s.toString()} to ${e.toString()}`),this.innerCursor[r]=e,null===(n=l.a.Instance.dbProxy)||void 0===n||n.saveUserCursor(r,e))}init(){var e,t,n,r,s;return E(this,void 0,void 0,(function*(){const c=T.a.performanceNow();if(this.initResult=i.i.Start,yield this.network.refreshToken(),(null===(e=l.a.Instance.option)||void 0===e?void 0:e.webSocketLevel)!==i.q.Disable)try{yield this.network.connectWs(!0)}catch(u){a.a.Instance.warn("skip websocket, init open fail:",u)}let d=!1;if(d=!l.a.Instance.dbProxy||(yield l.a.Instance.dbProxy.init(l.a.Instance.userId)),!(null===(t=l.a.Instance.option)||void 0===t?void 0:t.disableInitPull)&&d)try{for(const e of this.getInboxTypeArray()){let t=!0,n=o.ZERO;for(;t;){const o=yield this.getMessagesByUserInit({inboxType:e,cursor:n});t=o.hasMore,n=o.cursor,v.a.Instance.emitEmpty(i.g.InitLoadPage,this)}}yield S.a.Instance.refreshLocal(),v.a.Instance.emitEmpty(i.g.ConversationChange,this)}catch(u){return this.initResult=i.i.Error,a.a.Instance.error("init history error:",u),this.initResult}else{a.a.Instance.debug("skip history init for disable config:",null===(n=l.a.Instance.option)||void 0===n?void 0:n.disableInitPull,"dbProxy needInit:",d);try{for(const e of this.getInboxTypeArray())yield this.getMessagesByUserInit({inboxType:e,cursor:o.ZERO,skipStorage:!0})}catch(u){this.initResult=i.i.Error,a.a.Instance.error("init history error:",u,"will use fallback cursor 0")}for(const e of this.getInboxTypeArray())this.getUserCursor(e).neq(o.ZERO)?yield this.getMessagesByUser({inboxType:e}):a.a.Instance.warn(`inbox: ${e} cursor is 0, skip pull`);v.a.Instance.emitEmpty(i.g.ConversationChange,this)}try{for(const e of this.plugins)yield e.init()}catch(u){return this.initResult=i.i.Error,a.a.Instance.error("init plugin error:",u),this.initResult}return this.initResult=i.i.Succeeded,(null===(r=l.a.Instance.option)||void 0===r?void 0:r.pullInterval)&&(this.tickerInterval=this.intervalFunc(()=>E(this,void 0,void 0,(function*(){yield this.ticker()})),null===(s=l.a.Instance.option)||void 0===s?void 0:s.pullInterval),this.tickerInterval()),T.a.Instance.emitDuration(T.b.BizSdkInit,c),v.a.Instance.emit(i.g.InitFinish,this,this.initResult),this.initResult}))}getMessagesByUserInit(e={}){var t,n,r;return E(this,void 0,void 0,(function*(){void 0===e.inboxType&&(e.inboxType=this.getPriorityDefaultInboxType()),void 0===e.cursor&&(e.cursor=o.ZERO);const s=yield this.api.GetMessagesByUserInitV2({cursor:o.fromValue(e.cursor),inboxType:e.inboxType});return e.skipStorage||(s.conversations&&(T.a.Instance.emitCounter(T.b.BizConversationFromInit,s.conversations.length),s.conversations.map(e=>y.a.fromServerConversation(e)).forEach(e=>S.a.Instance.upsert(e))),s.messages&&(T.a.Instance.emitCounter(T.b.BizMessageFromInit,s.messages.length),yield k.a.Instance.processNewMessagesFromPull(s.messages,i.j.Init))),this.getUserCursor(e.inboxType).neq(o.ZERO)&&(null===(t=this.getUserCursor(e.inboxType))||void 0===t?void 0:t.neq(null===s||void 0===s?void 0:s.per_user_cursor))&&(a.a.Instance.debug(`cursor not match: before:${null===(n=this.getUserCursor(e.inboxType))||void 0===n?void 0:n.toString()}, after:${null===(r=null===s||void 0===s?void 0:s.per_user_cursor)||void 0===r?void 0:r.toString()}, pull user`),yield this.getMessagesByUser({inboxType:e.inboxType})),this.setUserCursor(null===s||void 0===s?void 0:s.per_user_cursor,e.inboxType),{hasMore:s.has_more,cursor:s.next_cursor}}))}getMessagesByUser(e={}){var t,n;return E(this,void 0,void 0,(function*(){if(!0===(null===(t=l.a.Instance.option)||void 0===t?void 0:t.disableInitPull)&&0===this.getConversationList().length&&this.getUserCursor(e.inboxType).eq(o.ZERO))return void a.a.Instance.warn("try to pull history from 0, preventing");let r=!0,s=e.cursor?o.fromValue(e.cursor):this.getUserCursor(e.inboxType);for(;r;){const t=yield this.api.GetMessagesByUser({cursor:s,limit:null!==(n=e.limit)&&void 0!==n?n:50});r=null===t||void 0===t?void 0:t.has_more,s=null===t||void 0===t?void 0:t.next_cursor,T.a.Instance.emitCounter(T.b.BizMessageFromUser,null===t||void 0===t?void 0:t.messages.length),yield k.a.Instance.processNewMessagesFromPull(t.messages,i.j.UserInbox),yield S.a.Instance.refreshLocal()}this.setUserCursor(s,e.inboxType)}))}getMessagesByConversation(e){var t;return E(this,void 0,void 0,(function*(){let n=e.cursor;n instanceof h.a&&(n=n.indexInConversation),void 0===n&&(n=e.conversation.firstMessageIndex);const r=yield this.api.GetMessagesByConversation({conversationId:e.conversation.id,conversationShortId:o.fromString(e.conversation.shortId),conversationType:e.conversation.type,anchorIndex:o.fromValue(n),direction:s.a.MessageDirection.OLDER,limit:null!==(t=e.limit)&&void 0!==t?t:20,inboxType:e.conversation.inboxType});return{messages:yield k.a.Instance.processNewMessagesFromPull(r.messages,i.j.LoadMore),hasMore:null===r||void 0===r?void 0:r.has_more,cursor:null===r||void 0===r?void 0:r.next_cursor}}))}markConversationRead(e){var t,n;return E(this,void 0,void 0,(function*(){if(0===e.conversation.unreadCount)return;let r,s,i=e.readIndex;i instanceof h.a&&(i=i.indexInConversation),void 0===i&&(i=e.conversation.lastMessageIndex),(null===i||void 0===i?void 0:i.toString())!==(null===(t=e.conversation.readIndex)||void 0===t?void 0:t.toString())&&((null===(n=l.a.Instance.option)||void 0===n?void 0:n.unreadCountReport)&&(s=0,r=e.conversation.unreadCount,this.getConversationList().forEach(e=>s+=e.unreadCount)),S.a.Instance.markRead(e.conversation.id,o.fromValue(i)),this.api.MarkConversationReadV3({conversationId:e.conversation.id,conversationShortId:o.fromString(e.conversation.shortId),conversationType:e.conversation.type,readIndex:o.fromValue(i),inboxType:e.conversation.inboxType,unreadCount:r?o.fromValue(r):void 0,totalUnreadCount:s?o.fromValue(s):void 0}))}))}recallMessage(e){return E(this,void 0,void 0,(function*(){if(!e.message.serverId)throw new p.a({type:i.d.MessageNotReady,msg:`message ${e.message} is not ready`,sender:this});yield this.api.RecallMessage({conversationId:e.message.conversationId,conversationShortId:o.fromString(e.message.conversationShortId),conversationType:e.message.conversationType,serverId:o.fromString(e.message.serverId)}),k.a.Instance.markRecalled(e.message.conversationId,e.message.serverId)}))}createConversation(e){return E(this,void 0,void 0,(function*(){let t=[];if(void 0===e.type&&(Array.isArray(e.participants)?e.participants.length<=1?e.type=s.a.ConversationType.ONE_TO_ONE_CHAT:e.type=s.a.ConversationType.GROUP_CHAT:e.type=s.a.ConversationType.ONE_TO_ONE_CHAT),t=Array.isArray(e.participants)?-1===e.participants.indexOf(l.a.Instance.userId)?e.participants.concat(l.a.Instance.userId):e.participants:[e.participants,l.a.Instance.userId],t.length>2&&e.type===s.a.ConversationType.ONE_TO_ONE_CHAT)throw new p.a({type:i.d.InvalidParam,msg:"one to one chat can only has 2 participants",sender:this});const n=yield this.api.CreateConversationV2({type:e.type,participants:t.map(e=>o.fromValue(e)),persistent:e.persistent,idempotentId:e.idempotentId,name:e.name,avatarUrl:e.avatarUrl,desc:e.desc,bizExt:e.bizExt,inboxType:e.inboxType});if(0!==(null===n||void 0===n?void 0:n.status))return{success:!1,payload:null,checkCode:n.check_code,checkMsg:n.check_message,statusCode:n.status,statusMsg:n.extra_info};const r=y.a.fromServerConversation(null===n||void 0===n?void 0:n.conversation);return S.a.Instance.upsert(r),yield S.a.Instance.refresh([r]),{success:!0,payload:r,checkCode:n.check_code,checkMsg:n.check_message,statusCode:n.status,statusMsg:n.extra_info}}))}getConversation(e){return S.a.Instance.get(e.conversationId)}getConversationOnline(e){return E(this,void 0,void 0,(function*(){return S.a.Instance.getWithOnline(e.conversationId,e.shortId,e.type)}))}getConversationList(e={}){return S.a.Instance.getConversationArray(e.filter)}getConversationListOnline(e={}){return E(this,void 0,void 0,(function*(){return yield S.a.Instance.refreshLocal(),this.getConversationList({filter:e.filter})}))}createMessage(e){return E(this,void 0,void 0,(function*(){void 0===e.insert&&(e.insert=!0);const t=h.a.createClientMessage({type:e.type,content:e.content,ext:e.ext,id:Object(O.a)(),conversationId:e.conversation.id,mentionedUsers:e.mentionedUsers||[],conversationShortId:e.conversation.shortId,conversationType:e.conversation.type});return t.flightStatus=i.f.Created,t.sendFunc=this.__internal_sendMessageObject.bind(this),t.indexInConversation=e.conversation.lastMessageIndex.add(1),t.orderInConversation=e.conversation.lastMessageOrder.add(1),e.insert&&(yield k.a.Instance.processNewMessage(t,i.j.Offline)),t}))}createTextMessage(e){return E(this,void 0,void 0,(function*(){return this.createMessage({conversation:e.conversation,content:e.content,ext:e.ext,type:s.a.MessageType.MESSAGE_TYPE_TEXT})}))}sendMessage(e){return E(this,void 0,void 0,(function*(){const t=yield e.message.sendFunc(e.message);return v.a.Instance.emit(i.g.MessageSend,this,e.message),t}))}fetchConversation(e){return E(this,void 0,void 0,(function*(){let t=null;if(void 0!==e.shortId){const t=S.a.Instance.getWithShortIdRaw(e.shortId);if(null!==t&&!t.isOffline)return t}let n=this.getPriorityDefaultInboxType();if(void 0!==e.inboxType&&(n=e.inboxType),void 0!==e.idempotentId&&void 0===e.participantId){const o=yield this.createConversation({type:s.a.ConversationType.GROUP_CHAT,participants:[],inboxType:n,idempotentId:e.idempotentId});o.success&&(t=o.payload,null!==t&&(yield this.getConversationOnline({conversationId:t.id,shortId:t.shortId,type:s.a.ConversationType.ONE_TO_ONE_CHAT})))}else if(void 0!==e.participantId){const o=yield this.createConversation({type:s.a.ConversationType.ONE_TO_ONE_CHAT,participants:e.participantId,inboxType:n});o.success&&(t=o.payload,null!==t&&(yield S.a.Instance.upsertOnline(t)))}else{if(void 0===e.shortId)throw new p.a({type:i.d.InvalidParam,msg:"no valid param provided",reachServer:!1,sender:this});t=yield this.getConversationOnline({conversationId:e.shortId,shortId:e.shortId,type:s.a.ConversationType.GROUP_CHAT})}if(null===t||t.isOffline)throw new p.a({type:i.d.ConversationNotExistError,msg:"fetch failed, conv is null or offline",reachServer:!1,sender:this});return yield this.getMessagesByConversation({conversation:t}),t}))}dispose(){var e;v.a.Instance.unsubscribeAll(),clearInterval(this.tickerIntervalHandler),this.network.closeWs(),null===(e=this.network.ws)||void 0===e||e.dispose(),this.network.onMessage.unsubscribeAll();for(const t of this.plugins)t.dispose();this.plugins=[],S.a.Instance.dispose(),k.a.Instance.dispose(),l.a.Instance.option.monitor=void 0,l.a.Instance.option.aspectBefore=()=>(a.a.Instance.error("do not invoke a disposed instance"),!1),this.disposed=!0,a.a.Instance.warn("sdk unloaded, do not invoke this instance")}ticker(){var e,t;return E(this,void 0,void 0,(function*(){if((yield Object(f.c)())!==f.a.Disconnected&&this.initResult===i.i.Succeeded&&!this.isProcessing){if((null===(e=l.a.Instance.option)||void 0===e?void 0:e.webSocketLevel)!==i.q.Disable)try{(yield Object(f.c)())===f.a.Disconnected?a.a.Instance.warn("network disconnected, skip ws check"):(null===(t=this.network.ws)||void 0===t?void 0:t.isOpen())||(yield this.network.connectWs(!0))}catch(n){a.a.Instance.warn("ws check err:",n)}for(const e of this.getInboxTypeArray())yield this.getMessagesByUser({inboxType:e});for(const e of this.plugins)yield e.ticker()}}))}__internal_sendMessageObject(e){var t,n;return E(this,void 0,void 0,(function*(){const r={success:!1,payload:e};if(e.serverId)return r;const a=S.a.Instance.getRaw(e.conversationId);if(void 0===a)return r;e.flightStatus=i.f.Inflight,yield k.a.Instance.processNewMessage(e,i.j.Offline),a.ticket||(yield S.a.Instance.refreshTicket(a.id));try{const c=yield this.api.SendMessage({conversationType:a.type,conversationId:a.id,conversationShortId:o.fromString(a.shortId),content:e.content,ticket:a.ticket,ext:e.ext,messageType:e.type,clientId:e.clientId,mentionedUsers:e.mentionedUsers.map(e=>o.fromString(e))});if(e.ext[i.h.SendResponseCheckCode]=null!==(t=null===c||void 0===c?void 0:c.check_code.toString())&&void 0!==t?t:"",e.ext[i.h.SendResponseCheckMessage]=null===c||void 0===c?void 0:c.check_message,e.ext[i.h.SendResponseExtraInfo]=null===c||void 0===c?void 0:c.extra_info,e.ext[i.h.SendResponseStatus]=null!==(n=null===c||void 0===c?void 0:c.status.toString())&&void 0!==n?n:"",k.a.Instance.upsert(e),r.body=c,r.checkCode=c.check_code,r.checkMsg=c.check_message,r.statusCode=c.status,r.statusMsg=c.extra_info,0===c.status){const t=c.server_message_id.toString();e.serverId=t,e.flightStatus=i.f.Succeeded,yield k.a.Instance.processNewMessage(e,i.j.Offline),r.success=!0}else e.flightStatus!==i.f.Received?(e.flightStatus=i.f.Rejected,c.status===s.a.SendMessageStatus.CHECK_MSG_NOT_PASS_BUT_SELF_VISIBLE&&(e.flightStatus=i.f.SelfVisible)):r.success=!0}catch(c){e.flightStatus!==i.f.Received&&(e.flightStatus=i.f.Failed),r.innerError=c}return r}))}intervalFunc(e,t){return()=>{const n=this;this.tickerIntervalHandler=setInterval(()=>{e.apply(n)},t)}}receivePacket(e){var t,n;return E(this,void 0,void 0,(function*(){this.isProcessing=!0;let r=!1;const c=this.getUserCursor(e.inbox_type);if(e.cmd===s.a.IMCMD.NEW_MSG_NOTIFY){T.a.Instance.emitCounter(T.b.BizReceiveMessage);const c=e.body.has_new_message_notify,d=c.message;if(d){const e=null===(t=d.create_time)||void 0===t?void 0:t.toNumber();e&&T.a.Instance.emitLatencyDuration(T.b.BizMessageLatency,e)}this.getUserCursor(e.inbox_type).gt(o.ZERO)&&(c.previous_cursor.eq(this.getUserCursor(e.inbox_type))&&!(null===(n=c.previous_cursor)||void 0===n?void 0:n.eq(o.ZERO))||(r=!0,a.a.Instance.debug("previous cursor is 0, trigger force pull")));const u=h.a.fromServerMessage(c.message);u.type>=s.a.MessageType.MESSAGE_TYPE_COMMAND?T.a.Instance.emitCounter(T.b.BizReceiveCmdMessage):T.a.Instance.emitCounter(T.b.BizReceiveTextMessage),u.ext||(u.ext={}),u.ext[i.h.MessageLogid]=e.log_id,e.start_time_stamp&&(u.ext[i.h.MessageStartTimestamp]=e.start_time_stamp.toString()),yield k.a.Instance.processNewMessage(u,i.j.Online),this.setUserCursor(c.next_cursor,e.inbox_type),yield S.a.Instance.refreshLocal()}for(const t of this.plugins)yield t.receivePacket(e);r&&(yield this.getMessagesByUser({inboxType:e.inbox_type,cursor:c})),this.isProcessing=!1}))}getPriorityDefaultInboxType(){var e;const t=null===(e=l.a.Instance.option)||void 0===e?void 0:e.inboxType;return Array.isArray(t)?t[0]:void 0!==t?t:0}getInboxTypeArray(){var e;const t=null===(e=l.a.Instance.option)||void 0===e?void 0:e.inboxType;return Array.isArray(t)?t:void 0!==t?[t]:[0]}}var A=n("xIz2"),N=n("q8ia"),q=n("g98E");class P{}var j=n("4tOJ"),D=n("Lmh7")},Rt85:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.noJitter=function(e){return e}},VZoR:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var o=n("l8xX"),r=function(){function e(e){this.options=e,this.attempt=0}return e.prototype.apply=function(){var e=this;return new Promise((function(t){return setTimeout(t,e.jitteredDelay)}))},e.prototype.setAttemptNumber=function(e){this.attempt=e},Object.defineProperty(e.prototype,"jitteredDelay",{get:function(){return o.JitterFactory(this.options)(this.delay)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"delay",{get:function(){var e=this.options.startingDelay,t=this.options.timeMultiple,n=this.numOfDelayedAttempts,o=e*Math.pow(t,n);return Math.min(o,this.options.maxDelay)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"numOfDelayedAttempts",{get:function(){return this.attempt},enumerable:!0,configurable:!0}),e}();t.Delay=r},l6bA:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.fullJitter=function(e){var t=Math.random()*e;return Math.round(t)}},l8xX:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var o=n("mEaV"),r=n("l6bA"),s=n("Rt85");t.JitterFactory=function(e){switch(e.jitter){case o.JitterTypes.Full:return r.fullJitter;case o.JitterTypes.None:default:return s.noJitter}}},mEaV:function(e,t,n){"use strict";var o,r=this&&this.__assign||function(){return(r=Object.assign||function(e){for(var t,n=1,o=arguments.length;n<o;n++)for(var r in t=arguments[n])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e}).apply(this,arguments)};Object.defineProperty(t,"__esModule",{value:!0}),function(e){e.None="none",e.Full="full"}(o=t.JitterTypes||(t.JitterTypes={}));var s={delayFirstAttempt:!1,jitter:o.None,maxDelay:1/0,numOfAttempts:10,retry:function(){return!0},startingDelay:100,timeMultiple:2};t.getSanitizedOptions=function(e){var t=r(r({},s),e);return t.numOfAttempts<1&&(t.numOfAttempts=1),t}},suZz:function(e,t,n){"use strict";var o=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(r,s){function i(e){try{c(o.next(e))}catch(t){s(t)}}function a(e){try{c(o.throw(e))}catch(t){s(t)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,a)}c((o=o.apply(e,t||[])).next())}))},r=this&&this.__generator||function(e,t){var n,o,r,s,i={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return s={next:a(0),throw:a(1),return:a(2)},"function"===typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(s){return function(a){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;i;)try{if(n=1,o&&(r=2&s[0]?o.return:s[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,s[1])).done)return r;switch(o=0,r&&(s=[2&s[0],r.value]),s[0]){case 0:case 1:r=s;break;case 4:return i.label++,{value:s[1],done:!1};case 5:i.label++,o=s[1],s=[0];continue;case 7:s=i.ops.pop(),i.trys.pop();continue;default:if(!(r=(r=i.trys).length>0&&r[r.length-1])&&(6===s[0]||2===s[0])){i=0;continue}if(3===s[0]&&(!r||s[1]>r[0]&&s[1]<r[3])){i.label=s[1];break}if(6===s[0]&&i.label<r[1]){i.label=r[1],r=s;break}if(r&&i.label<r[2]){i.label=r[2],i.ops.push(s);break}r[2]&&i.ops.pop(),i.trys.pop();continue}s=t.call(e,i)}catch(a){s=[6,a],o=0}finally{n=r=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,a])}}};Object.defineProperty(t,"__esModule",{value:!0});var s=n("mEaV"),i=n("2//O");t.backOff=function(e,t){return void 0===t&&(t={}),o(this,void 0,void 0,(function(){var n;return r(this,(function(o){switch(o.label){case 0:return n=s.getSanitizedOptions(t),[4,new a(e,n).execute()];case 1:return[2,o.sent()]}}))}))};var a=function(){function e(e,t){this.request=e,this.options=t,this.attemptNumber=0}return e.prototype.execute=function(){return o(this,void 0,void 0,(function(){var e;return r(this,(function(t){switch(t.label){case 0:if(this.attemptLimitReached)return[3,6];t.label=1;case 1:return t.trys.push([1,4,,5]),[4,this.applyDelay()];case 2:return t.sent(),[4,this.request()];case 3:return[2,t.sent()];case 4:if(e=t.sent(),this.attemptNumber++,!this.options.retry(e,this.attemptNumber)||this.attemptLimitReached)throw e;return[3,5];case 5:return[3,0];case 6:throw new Error("Something went wrong.")}}))}))},Object.defineProperty(e.prototype,"attemptLimitReached",{get:function(){return this.attemptNumber>=this.options.numOfAttempts},enumerable:!0,configurable:!0}),e.prototype.applyDelay=function(){return o(this,void 0,void 0,(function(){return r(this,(function(e){switch(e.label){case 0:return[4,i.DelayFactory(this.options,this.attemptNumber).apply()];case 1:return e.sent(),[2]}}))}))},e}()}}]);