(window.webpackJsonp_N_E=window.webpackJsonp_N_E||[]).push([[136],{HV4y:function(e,t,n){"use strict";n.r(t),n.d(t,"ExtensionPlugin",(function(){return k})),n.d(t,"Participant",(function(){return f})),n.d(t,"MessagePropertyUtils",(function(){return b.b})),n.d(t,"MessageProperty",(function(){return b.a}));var o=n("1277"),s=n("VXtF"),i=n("+ZTy"),r=n("39GT"),a=n("YnhK"),c=n("7af5"),d=n("r7qN"),v=n("VYFf"),u=n("CeZg"),p=n("g98E"),h=n("Fjbr"),l=n("Hd7d"),_=n("ba9d"),I=n("xQJc"),y=function(e,t,n,o){return new(n||(n=Promise))((function(s,i){function r(e){try{c(o.next(e))}catch(t){i(t)}}function a(e){try{c(o.throw(e))}catch(t){i(t)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(r,a)}c((o=o.apply(e,t||[])).next())}))};class g extends I.a{LeaveConversation(e){return y(this,void 0,void 0,(function*(){const t=_.a.RequestBody.create({leave_conversation_body:{conversation_id:e.conversationId,conversation_short_id:e.conversationShortId,conversation_type:e.conversationType}});return this.send(t,_.a.IMCMD.LEAVE_CONVERSATION,{inboxType:e.inboxType})}))}DeleteMessage(e){return y(this,void 0,void 0,(function*(){const t=_.a.RequestBody.create({delete_message_body:{conversation_id:e.conversationId,conversation_short_id:e.conversationShortId,conversation_type:e.conversationType,message_id:e.serverId}});return this.send(t,_.a.IMCMD.DELETE_MESSAGE,{inboxType:e.inboxType})}))}MarkConversationDelete(e){return y(this,void 0,void 0,(function*(){const t=_.a.RequestBody.create({delete_conversation_body:{conversation_id:e.conversationId,conversation_short_id:e.conversationShortId,conversation_type:e.conversationType,last_message_index:e.lastPullIndex}});return this.send(t,_.a.IMCMD.MARK_CONVERSATION_DELETE,{inboxType:e.inboxType})}))}AddConversationParticipants(e){return y(this,void 0,void 0,(function*(){const t=_.a.RequestBody.create({conversation_add_participants_body:{conversation_id:e.conversationId,conversation_short_id:e.conversationShortId,conversation_type:e.conversationType,participants:e.participants,biz_ext:e.bizExt}});return(yield this.send(t,_.a.IMCMD.ADD_CONVERSATION_PARTICIPANTS,{inboxType:e.inboxType})).conversation_add_participants_body}))}GetConversationInfoListByFavoriteV2(e){return y(this,void 0,void 0,(function*(){const t=_.a.RequestBody.create({get_conversation_info_list_by_favorite_v2_body:{cursor:e.cursor,limit:e.limit}});return(yield this.send(t,_.a.IMCMD.GET_CONVERSATION_INFO_LIST_BY_FAVORITE_V2,{inboxType:e.inboxType})).get_conversation_info_list_by_favorite_v2_body}))}GetConversationInfoListByTopV2(e){return y(this,void 0,void 0,(function*(){const t=_.a.RequestBody.create({get_conversation_info_list_by_top_v2_body:{cursor:e.cursor,limit:e.limit}});return(yield this.send(t,_.a.IMCMD.GET_CONVERSATION_INFO_LIST_BY_TOP_V2,{inboxType:e.inboxType})).get_conversation_info_list_by_top_v2_body}))}UpdateConversationParticipant(e){return y(this,void 0,void 0,(function*(){const t=_.a.RequestBody.create({update_conversation_participant_body:{conversation_id:e.conversationId,conversation_short_id:e.conversationShortId,conversation_type:e.conversationType,user_id:e.userId,role:e.role,alias:e.alias,biz_ext:e.bizExt}});return(yield this.send(t,_.a.IMCMD.UPDATE_CONVERSATION_PARTICIPANT,{inboxType:e.inboxType})).update_conversation_participant_body}))}SetConversationCoreInfo(e){return y(this,void 0,void 0,(function*(){const t=_.a.RequestBody.create({set_conversation_core_info_body:{conversation_id:e.conversationId,conversation_short_id:e.conversationShortId,conversation_type:e.conversationType,name:e.name,desc:e.desc,icon:e.icon,notice:e.notice}});return(yield this.send(t,_.a.IMCMD.SET_CONVERSATION_CORE_INFO,{inboxType:e.inboxType})).set_conversation_core_info_body}))}RemoveConversationParticipants(e){return y(this,void 0,void 0,(function*(){const t=_.a.RequestBody.create({conversation_remove_participants_body:{conversation_id:e.conversationId,conversation_short_id:e.conversationShortId,conversation_type:e.conversationType,participants:e.participants,biz_ext:e.bizExt}});return(yield this.send(t,_.a.IMCMD.REMOVE_CONVERSATION_PARTICIPANTS,{inboxType:e.inboxType})).conversation_remove_participants_body}))}UpsertConversationCoreExtInfo(e){return y(this,void 0,void 0,(function*(){const t=_.a.RequestBody.create({upsert_conversation_core_ext_info_body:{conversation_id:e.conversationId,conversation_short_id:e.conversationShortId,conversation_type:e.conversationType,ext:e.ext}});return(yield this.send(t,_.a.IMCMD.UPSERT_CONVERSATION_CORE_EXT_INFO,{inboxType:e.inboxType})).upsert_conversation_core_ext_info_body}))}SetConversationSettingInfo(e){return y(this,void 0,void 0,(function*(){const t=_.a.RequestBody.create({set_conversation_setting_info_body:{conversation_id:e.conversationId,conversation_short_id:e.conversationShortId,conversation_type:e.conversationType,set_stick_on_top:e.stickOnTop,set_mute:e.mute,set_favorite:e.favorite}});return(yield this.send(t,_.a.IMCMD.SET_CONVERSATION_SETTING_INFO,{inboxType:e.inboxType})).set_conversation_setting_info_body}))}UpsertConversationSettingExtInfo(e){return y(this,void 0,void 0,(function*(){const t=_.a.RequestBody.create({upsert_conversation_setting_ext_info_body:{conversation_id:e.conversationId,conversation_short_id:e.conversationShortId,conversation_type:e.conversationType,ext:e.ext}});return(yield this.send(t,_.a.IMCMD.UPSERT_CONVERSATION_SETTING_EXT_INFO,{inboxType:e.inboxType})).upsert_conversation_setting_ext_info_body}))}GetConversationParticipantsReadIndexV3(e){return y(this,void 0,void 0,(function*(){const t=_.a.RequestBody.create({participants_read_index_body:{conversation_id:e.conversationId,conversation_short_id:e.conversationShortId,conversation_type:e.conversationType}});return(yield this.send(t,_.a.IMCMD.GET_CONVERSATION_PARTICIPANTS_READ_INDEX_V3,{inboxType:e.inboxType})).participants_read_index_body}))}GetConversationParticipantsMinIndexV3(e){return y(this,void 0,void 0,(function*(){const t=_.a.RequestBody.create({participants_min_index_body:{conversation_id:e.conversationId,conversation_short_id:e.conversationShortId,conversation_type:e.conversationType}});return(yield this.send(t,_.a.IMCMD.GET_CONVERSATION_PARTICIPANTS_MIN_INDEX_V3,{inboxType:e.inboxType})).participants_min_index_body}))}GetConversationParticipantsList(e){return y(this,void 0,void 0,(function*(){const t=_.a.RequestBody.create({conversation_participants_body:{conversation_id:e.conversationId,conversation_short_id:e.conversationShortId,conversation_type:e.conversationType,cursor:e.cursor,limit:e.limit}});return(yield this.send(t,_.a.IMCMD.CONVERSATION_PARTICIPANTS_LIST,{inboxType:e.inboxType})).conversation_participants_body}))}SendUserAction(e){return y(this,void 0,void 0,(function*(){const t=_.a.RequestBody.create({send_user_action_body:{conversation_id:e.conversationId,conversation_short_id:e.conversationShortId,conversation_type:e.conversationType,action_type:e.actionType,extra:e.extra}});return this.send(t,_.a.IMCMD.SEND_USER_ACTION,{inboxType:e.inboxType})}))}SendInputStatus(e){return y(this,void 0,void 0,(function*(){const t=_.a.RequestBody.create({send_input_status_body:{conversation_id:e.conversationId,conversation_short_id:e.conversationShortId,conversation_type:e.conversationType,status:e.status,extra:e.extra}});return this.send(t,_.a.IMCMD.SEND_INPUT_STATUS,{inboxType:e.inboxType})}))}ClientAck(e){return y(this,void 0,void 0,(function*(){try{const t=_.a.RequestBody.create({client_ack_body:{start_time_stamp:e.startTimeStamp,cmd:e.cmd,network_type:e.NetworkType,logid:e.logid,client_time_stamp:e.clientTimeStamp}});yield this.send(t,_.a.IMCMD.CLIENT_ACK,{useBeacon:!0})}catch(t){c.a.Instance.warn(`send ack error: ${t}, ignore`)}}))}DissolveConversation(e){return y(this,void 0,void 0,(function*(){const t=_.a.RequestBody.create({dissolve_conversation_body:{conversation_id:e.conversationId,conversation_short_id:e.conversationShortId,conversation_type:e.conversationType}});return this.send(t,_.a.IMCMD.DISSOLVE_CONVERSATION)}))}ModifyMessageExt(e){return y(this,void 0,void 0,(function*(){const t=_.a.RequestBody.create({modify_message_ext_body:{conversation_short_id:e.conversationShortId,message_id:e.messageId,ticket:e.ticket,ext:e.ext}});return this.send(t,_.a.IMCMD.MODIFY_MESSAGE_EXT)}))}GetUserConversationList(e){return y(this,void 0,void 0,(function*(){const t=_.a.RequestBody.create({get_conversation_list_body:{con_type:e.type,cursor:e.cursor,limit:e.limit}});return(yield this.send(t,_.a.IMCMD.GET_USER_CONVERSATION_LIST)).get_conversation_list_body}))}UnreadCountReport(e){return y(this,void 0,void 0,(function*(){const t=_.a.RequestBody.create({unread_count_report_body:{conv_unread_count:e.conv.map(e=>({conv_short_id:e.shortId,conversation_type:e.type,unread_count:e.count})),total_unread_count:e.total}});return this.send(t,_.a.IMCMD.UNREAD_COUNT_REPORT)}))}BlockConversation(e){return y(this,void 0,void 0,(function*(){const t=_.a.RequestBody.create({block_conversation_body:{conversation_id:e.conversationId,conv_short_id:e.conversationShortId,conversation_type:e.conversationType,block_status:e.status,block_normal_only:e.normalOnly}});return this.send(t,_.a.IMCMD.BLOCK_CONVERSATION)}))}BlockMember(e){return y(this,void 0,void 0,(function*(){const t=_.a.RequestBody.create({block_members_body:{conversation_id:e.conversationId,conv_short_id:e.conversationShortId,conversation_type:e.conversationType,block_time:e.time,block_status:e.status,biz_ext:e.bizExt}});return(yield this.send(t,_.a.IMCMD.BLOCK_MEMBERS)).block_members_body}))}GetBlockList(e){return y(this,void 0,void 0,(function*(){const t=_.a.RequestBody.create({get_blocklist_body:{cursor:e.cursor,limit:e.limit}});return(yield this.send(t,_.a.IMCMD.GET_BLOCKLIST)).get_blocklist_body}))}SetBlockList(e){return y(this,void 0,void 0,(function*(){const t=_.a.RequestBody.create({set_blocklist_body:{set_block_list:e.applySet,blocklist:e.blocklist}});return this.send(t,_.a.IMCMD.SET_BLOCKLIST)}))}CheckInBlockList(e){return y(this,void 0,void 0,(function*(){const t=_.a.RequestBody.create({check_in_blocklist_body:{user_to_check:e.userToCheck}});return(yield this.send(t,_.a.IMCMD.CHECK_IN_BLOCKLIST)).check_in_blocklist_body}))}BroadcastSendMessage(e){return y(this,void 0,void 0,(function*(){const t=_.a.RequestBody.create({broadcast_send_message_body:{conversation_id:e.conversationId,conversation_short_id:e.conversationShortId,conversation_type:e.conversationType,ticket:e.ticket,message_type:e.type,content:e.content,client_message_id:e.clientId,mentioned_users:e.mentionedUsers,ext:e.ext}});return(yield this.send(t,_.a.IMCMD.BROADCAST_SEND_MESSAGE)).broadcast_send_message_body}))}BroadcastReceiveMessage(e){return y(this,void 0,void 0,(function*(){const t=_.a.RequestBody.create({broadcast_recv_message_body:{conversation_id:e.conversationId,conversation_short_id:e.conversationShortId,conversation_type:e.conversationType,cursor:e.cursor,limit:e.limit,reverse:e.reverse}});return(yield this.send(t,_.a.IMCMD.BROADCAST_RECV_MESSAGE)).broadcast_recv_message_body}))}BroadcastUserCounter(e){return y(this,void 0,void 0,(function*(){const t=_.a.RequestBody.create({broadcast_user_counter_body:{conversations:e.conversations.map(e=>({conversation_short_id:e.shortId,conversation_type:e.type}))}});return(yield this.send(t,_.a.IMCMD.BROADCAST_USER_COUNTER)).broadcast_user_counter_body}))}SendP2PMessage(e){return y(this,void 0,void 0,(function*(){const t=_.a.RequestBody.create({send_message_p2p_body:{conversation_id:e.conversationId,conversation_short_id:e.conversationShortId,conversation_type:e.conversationType,send_type:e.sendType,message_type:e.msgType,content:e.content,client_message_id:e.clientId,ext:e.ext,visible_user:e.visibleUser,invisible_user:e.invisibleUser}});return this.send(t,_.a.IMCMD.SEND_MESSAGE_P2P)}))}ModifyMessageProperty(e){return y(this,void 0,void 0,(function*(){const t=_.a.RequestBody.create({modify_message_property_body:{property_list:{conversation_id:e.conversationId,conversation_short_id:e.conversationShortId,conversation_type:e.conversationType,server_message_id:e.serverId,client_message_id:e.clientId,modify_property_content:e.modifyContent.map(e=>({operation:e.operation,key:e.key,value:e.value,idempotent_id:e.idempotentId}))},ticket:e.ticket}});return(yield this.send(t,_.a.IMCMD.SET_MESSAGE_PROPERTY)).modify_message_property_body}))}GetUnreadCount(e){return y(this,void 0,void 0,(function*(){const t=_.a.RequestBody.create({get_unread_count_body:{get_total:e.total,conv_short_id:e.shortIds}});return(yield this.send(t,_.a.IMCMD.GET_UNREAD_COUNT)).get_unread_count_body}))}}class f{constructor(){this.minIndex=o.ZERO,this._readIndex=o.ZERO,this._readOrder=o.ZERO}get readIndex(){return this._readIndex}set readIndex(e){e&&e.gt(this._readIndex)&&(this._readIndex=e)}get readOrder(){return this._readOrder}set readOrder(e){e&&e.gt(this._readOrder)&&(this._readOrder=e)}get isSelf(){return this.userId===i.a.Instance.userId}static featLocalParticipant(e,t){return e.userId!==t.userId||(e.secUid=t.secUid,e.role=t.role,e.alias=t.alias,e.sortOrder=t.sortOrder,e.blocked=t.blocked,e.leftBlockTime=t.leftBlockTime,e.readIndex=t.readIndex,e.readOrder=t.readOrder),e}static fromServerParticipant(e,t){var n,o,s,i;const r=new f;return r.userId=e.user_id.toString(),r.secUid=e.sec_uid,r.role=null!==(n=e.role)&&void 0!==n?n:void 0,r.alias=null!==(o=e.alias)&&void 0!==o?o:void 0,r.sortOrder=null!==(s=e.sort_order)&&void 0!==s?s:void 0,r.blocked=e.blocked===_.a.BlockStatus.BLOCK,r.leftBlockTime=null!==(i=e.left_block_time)&&void 0!==i?i:void 0,r.conversationId=t.id,r.conversationType=t.type,r}}class m{constructor(){this.participants=new Map}applyLocal(e){e.forEach(e=>{this.upsert(e.conversationId,e)})}upsert(e,t){let n=this.participants.get(e);return n||(n=new Map),n.has(t.userId)?n.set(t.userId,f.featLocalParticipant(n.get(t.userId),t)):n.set(t.userId,t),this.participants.set(e,n),Array.from(n.values())}upsertBatch(e,t){let n=this.participants.get(e);return n||(n=new Map),t.forEach(e=>{n.has(e.userId)?n.set(e.userId,f.featLocalParticipant(n.get(e.userId),e)):n.set(e.userId,e)}),this.participants.set(e,n),Array.from(n.values())}get(e){const t=this.participants.get(e);if(t)return Array.from(t.values());throw new r.a({type:s.d.ConversationNotExistError,msg:`conversation ${e} participants is not loaded`,sender:this})}getMap(e){const t=this.participants.get(e);if(t)return t;throw new r.a({type:s.d.ConversationNotExistError,msg:`conversation ${e} participants is not loaded`,sender:this})}getRaw(e){const t=this.participants.get(e);return t?Array.from(t.values()):[]}getByUserIdRaw(e,t){const n=this.participants.get(e);if(n){return n.get(t)}}dispose(){this.participants.clear()}}m.Instance=new m;var C=n("dOJp"),b=n("GSkw"),T=n("4tOJ"),S=function(e,t,n,o){return new(n||(n=Promise))((function(s,i){function r(e){try{c(o.next(e))}catch(t){i(t)}}function a(e){try{c(o.throw(e))}catch(t){i(t)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(r,a)}c((o=o.apply(e,t||[])).next())}))};class x extends T.a{process(e){return S(this,void 0,void 0,(function*(){return e.data.type===_.a.MessageType.MESSAGE_TYPE_UPDATE_MESSAGE_PROPERTY&&(e.needContinue=!1,yield this.handlePropertyCmd(e.data)),e}))}handlePropertyCmd(e){return S(this,void 0,void 0,(function*(){const t=l.a.Instance.getRaw(e.conversationId,e.clientId);t?(t.version=e.version,c.a.Instance.debug("merge property, local:",t.property,"server:",e.property),t.property=b.b.mergeProperty(e.property,t.property),l.a.Instance.upsert(t),a.a.Instance.emit(s.g.MessagePropertyUpsert,this,t),a.a.Instance.emitEmpty(s.g.ConversationChange,this)):c.a.Instance.debug("modify property cmd msg not exist in local",e)}))}}var M=function(e,t,n,o){return new(n||(n=Promise))((function(s,i){function r(e){try{c(o.next(e))}catch(t){i(t)}}function a(e){try{c(o.throw(e))}catch(t){i(t)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(r,a)}c((o=o.apply(e,t||[])).next())}))};class k extends p.a{leaveConversation(e){return M(this,void 0,void 0,(function*(){yield this.api.LeaveConversation({conversationId:e.conversation.id,conversationShortId:o.fromString(e.conversation.shortId),conversationType:e.conversation.type,inboxType:e.conversation.inboxType}),h.a.Instance.delete(e.conversation.id)}))}deleteMessage(e){return M(this,void 0,void 0,(function*(){if(!e.message.serverId)throw new r.a({type:s.d.MessageNotReady,msg:`message ${e.message} is not ready`,sender:this});yield this.api.DeleteMessage({conversationId:e.message.conversationId,conversationShortId:o.fromString(e.message.conversationShortId),conversationType:e.message.conversationType,serverId:o.fromString(e.message.serverId)}),l.a.Instance.delete(e.message.conversationId,e.message.serverId)}))}deleteConversation(e){return M(this,void 0,void 0,(function*(){h.a.Instance.delete(e.conversation.id);try{const t=e.conversation.lastMessageIndex;this.api.MarkConversationDelete({conversationId:e.conversation.id,conversationShortId:o.fromString(e.conversation.shortId),conversationType:e.conversation.type,lastPullIndex:t})}catch(t){c.a.Instance.warn("delete conversation error, may lost server operation",t)}}))}getConversationListByTop(e){var t,n;return M(this,void 0,void 0,(function*(){let s=[];const i=yield this.api.GetConversationInfoListByTopV2({cursor:o.fromValue(null!==(t=e.cursor)&&void 0!==t?t:"0"),limit:null!==(n=e.limit)&&void 0!==n?n:10,inboxType:e.inboxType}),r=(null===i||void 0===i?void 0:i.conversation_info_list).map(e=>d.a.fromServerConversation(e)).map(e=>h.a.Instance.upsert(e));return s=s.concat(r),{conversation:s,hasMore:null===i||void 0===i?void 0:i.has_more,cursor:null===i||void 0===i?void 0:i.next_cursor}}))}getConversationListByFavorite(e){var t,n;return M(this,void 0,void 0,(function*(){let s=[];const i=yield this.api.GetConversationInfoListByFavoriteV2({cursor:o.fromValue(null!==(t=e.cursor)&&void 0!==t?t:"0"),limit:null!==(n=e.limit)&&void 0!==n?n:10,inboxType:e.inboxType}),r=(null===i||void 0===i?void 0:i.conversation_info_list).map(e=>d.a.fromServerConversation(e)).map(e=>h.a.Instance.upsert(e));return s=s.concat(r),{conversation:s,hasMore:null===i||void 0===i?void 0:i.has_more,cursor:null===i||void 0===i?void 0:i.next_cursor}}))}addParticipants(e){return M(this,void 0,void 0,(function*(){const t=Array.isArray(e.participant)?e.participant:[e.participant],n=yield this.api.AddConversationParticipants({conversationId:e.conversation.id,conversationShortId:o.fromString(e.conversation.shortId),conversationType:e.conversation.type,participants:t.map(e=>o.fromValue(e)),bizExt:e.bizExt});return 0!==(null===n||void 0===n?void 0:n.status)?{success:!1,payload:e.conversation,checkCode:n.check_code,checkMsg:n.check_message,statusCode:n.status,statusMsg:n.extra_info}:(yield this.getConversationParticipants({conversation:e.conversation}),{success:!0,payload:e.conversation,checkCode:n.check_code,checkMsg:n.check_message,statusCode:n.status,statusMsg:n.extra_info})}))}removeParticipants(e){return M(this,void 0,void 0,(function*(){const t=yield this.api.RemoveConversationParticipants({conversationId:e.conversation.id,conversationShortId:o.fromString(e.conversation.shortId),conversationType:e.conversation.type,participants:e.participant.map(e=>o.fromString(e.userId)),bizExt:e.bizExt});return 0!==(null===t||void 0===t?void 0:t.status)?{success:!1,payload:e.conversation,checkCode:t.check_code,checkMsg:t.check_message,statusCode:t.status,statusMsg:t.extra_info}:(yield this.getConversationParticipants({conversation:e.conversation}),{success:!0,payload:e.conversation,checkCode:t.check_code,checkMsg:t.check_message,statusCode:t.status,statusMsg:t.extra_info})}))}setConversationSettingInfo(e){return M(this,void 0,void 0,(function*(){const t=yield this.api.SetConversationSettingInfo({conversationId:e.conversation.id,conversationShortId:o.fromString(e.conversation.shortId),conversationType:e.conversation.type,stickOnTop:e.stickOnTop,mute:e.mute,favorite:e.favorite});return 0!==(null===t||void 0===t?void 0:t.status)?{success:!1,payload:e.conversation,checkCode:t.check_code,checkMsg:t.check_message,statusCode:t.status,statusMsg:t.extra_info}:(e.conversation=yield h.a.Instance.upsertOnline(e.conversation),{success:!0,payload:e.conversation,checkCode:t.check_code,checkMsg:t.check_message,statusCode:t.status,statusMsg:t.extra_info})}))}setConversationCoreInfo(e){return M(this,void 0,void 0,(function*(){const t=yield this.api.SetConversationCoreInfo({conversationId:e.conversation.id,conversationShortId:o.fromString(e.conversation.shortId),conversationType:e.conversation.type,name:e.name,desc:e.desc,icon:e.icon,notice:e.notice});return 0!==(null===t||void 0===t?void 0:t.status)?{success:!1,payload:e.conversation,checkCode:t.check_code,checkMsg:t.check_message,statusCode:t.status,statusMsg:t.extra_info}:(e.conversation=yield h.a.Instance.upsertOnline(e.conversation),{success:!0,payload:e.conversation,checkCode:t.check_code,checkMsg:t.check_message,statusCode:t.status,statusMsg:t.extra_info})}))}upsertConversationSettingExtInfo(e){return M(this,void 0,void 0,(function*(){const t=yield this.api.UpsertConversationSettingExtInfo({conversationId:e.conversation.id,conversationShortId:o.fromString(e.conversation.shortId),conversationType:e.conversation.type,ext:e.ext});return 0!==(null===t||void 0===t?void 0:t.status)?{success:!1,payload:e.conversation,checkCode:t.check_code,checkMsg:t.check_message,statusCode:t.status,statusMsg:t.extra_info}:(e.conversation=yield h.a.Instance.upsertOnline(e.conversation),{success:!0,payload:e.conversation,checkCode:t.check_code,checkMsg:t.check_message,statusCode:t.status,statusMsg:t.extra_info})}))}upsertConversationCoreExtInfo(e){return M(this,void 0,void 0,(function*(){const t=yield this.api.UpsertConversationCoreExtInfo({conversationId:e.conversation.id,conversationShortId:o.fromString(e.conversation.shortId),conversationType:e.conversation.type,ext:e.ext});return 0!==(null===t||void 0===t?void 0:t.status)?{success:!1,payload:e.conversation,checkCode:t.check_code,checkMsg:t.check_message,statusCode:t.status,statusMsg:t.extra_info}:(e.conversation=yield h.a.Instance.upsertOnline(e.conversation),{success:!0,payload:e.conversation,checkCode:t.check_code,checkMsg:t.check_message,statusCode:t.status,statusMsg:t.extra_info})}))}getMessageReadReceipt(e){return M(this,void 0,void 0,(function*(){if(e.message.isRecalled||!e.message.isFromMe||e.message.isOffline)return{finishedParticipantIds:[],expectedParticipantIds:[]};const t=h.a.Instance.get(e.message.conversationId);let n=m.Instance.getRaw(t.id);if((e.syncFromServer||0===n.length)&&(t.type===_.a.ConversationType.ONE_TO_ONE_CHAT&&0===n.length&&(yield this.getConversationParticipants({conversation:t})),t.type===_.a.ConversationType.GROUP_CHAT&&(0===n.length?yield this.getConversationParticipants({conversation:t}):this.getConversationParticipants({conversation:t})),yield this.updateConversationReadReceipt({conversation:t})),n=m.Instance.getRaw(t.id),0===n.length)return{finishedParticipantIds:[],expectedParticipantIds:[]};if(!e.message.indexInConversation)return{finishedParticipantIds:[],expectedParticipantIds:n.filter(e=>e.userId!==i.a.Instance.userId).map(e=>e.userId)};const o=[],s=[];return n.forEach(t=>{t.minIndex.gt(e.message.indexInConversation)||(t.userId!==i.a.Instance.userId&&s.push(t.userId.toString()),(t.readOrder.gte(e.message.orderInConversation)||t.readIndex.gte(e.message.indexInConversation))&&t.userId!==i.a.Instance.userId&&o.push(t.userId.toString()))}),{finishedParticipantIds:o,expectedParticipantIds:s}}))}getConversationParticipants(e){return M(this,void 0,void 0,(function*(){let t=!0,n=o.ZERO;for(;t;){const o=yield this.getConversationParticipantsByPage({conversation:e.conversation,cursor:n});t=o.hasMore,n=o.cursor}return m.Instance.get(e.conversation.id)}))}getConversationParticipantsByPage(e){var t;return M(this,void 0,void 0,(function*(){const n=[];if(e.conversation.type===_.a.ConversationType.ONE_TO_ONE_CHAT){const t=m.Instance.getRaw(e.conversation.id);if(0===t.length){if(e.conversation.firstPageParticipant&&Array.isArray(e.conversation.firstPageParticipant.participants)&&e.conversation.firstPageParticipant.participants.length>0)e.conversation.firstPageParticipant.participants.forEach(t=>{n.push(f.fromServerParticipant(t,e.conversation))});else{c.a.Instance.debug("no first page participant found, fallback to local");[e.conversation.toParticipantUserId,i.a.Instance.userId].forEach(t=>{const s=new f;s.conversationId=e.conversation.id,s.conversationType=e.conversation.type,s.readIndex=o.ZERO,s.minIndex=o.ZERO,s.userId=t,n.push(s)})}return m.Instance.upsertBatch(e.conversation.id,n),{participant:n,hasMore:!1,cursor:o.ZERO}}return{participant:t,hasMore:!1,cursor:o.ZERO}}const s=(yield this.api.GetConversationParticipantsList({conversationId:e.conversation.id,conversationShortId:o.fromString(e.conversation.shortId),conversationType:e.conversation.type,cursor:e.cursor?o.fromValue(e.cursor):o.ZERO,limit:null!==(t=e.limit)&&void 0!==t?t:50})).participants_page;s.participants.forEach(t=>{n.push(f.fromServerParticipant(t,e.conversation))}),m.Instance.upsertBatch(e.conversation.id,n);const r=m.Instance.get(e.conversation.id);return e.conversation.participants=r,h.a.Instance.upsert(e.conversation),{participant:r,hasMore:s.has_more,cursor:s.cursor}}))}updateConversationReadReceipt(e){return M(this,void 0,void 0,(function*(){const t=yield this.api.GetConversationParticipantsReadIndexV3({conversationId:e.conversation.id,conversationShortId:o.fromString(e.conversation.shortId),conversationType:e.conversation.type}),n=m.Instance.getRaw(e.conversation.id);null===t||void 0===t||t.indexes.forEach(e=>{const t=n.filter(t=>t.userId===e.user_id.toString())[0];t&&(t.readIndex=e.index)});(yield this.api.GetConversationParticipantsMinIndexV3({conversationId:e.conversation.id,conversationShortId:o.fromString(e.conversation.shortId),conversationType:e.conversation.type})).indexes.forEach(e=>{const t=n.filter(t=>t.userId===e.user_id.toString())[0];t&&(t.minIndex=e.index)})}))}sendUserAction(e){return M(this,void 0,void 0,(function*(){yield this.api.SendUserAction({conversationId:e.conversation.id,conversationShortId:o.fromString(e.conversation.shortId),conversationType:e.conversation.type,extra:e.ext,actionType:e.actionType,inboxType:e.conversation.inboxType})}))}sendInputStatus(e){return M(this,void 0,void 0,(function*(){yield this.api.SendInputStatus({conversationId:e.conversation.id,conversationShortId:o.fromString(e.conversation.shortId),conversationType:e.conversation.type,extra:e.ext,status:e.status,inboxType:e.conversation.inboxType})}))}sendP2PMessage(e){var t,n,s,i,r;return M(this,void 0,void 0,(function*(){yield this.api.SendP2PMessage({conversationId:e.conversation.id,conversationShortId:o.fromValue(e.conversation.shortId),conversationType:e.conversation.type,sendType:e.sendType,msgType:e.msgType,content:e.content,clientId:Object(C.a)(),ext:null!==(t=e.ext)&&void 0!==t?t:{},visibleUser:null!==(s=null===(n=e.visibleUser)||void 0===n?void 0:n.map(e=>o.fromValue(e)))&&void 0!==s?s:[],invisibleUser:null!==(r=null===(i=e.invisibleUser)||void 0===i?void 0:i.map(e=>o.fromValue(e)))&&void 0!==r?r:[]})}))}dissolveConversation(e){return M(this,void 0,void 0,(function*(){yield this.api.DissolveConversation({conversationId:e.conversation.id,conversationShortId:o.fromString(e.conversation.shortId),conversationType:e.conversation.type}),h.a.Instance.delete(e.conversation.id),a.a.Instance.emit(s.g.ConversationDissolve,this,e.conversation),a.a.Instance.emitEmpty(s.g.ConversationChange,this)}))}upsertMessageExt(e){return M(this,void 0,void 0,(function*(){if(!e.message.serverId)throw new r.a({type:s.d.MessageOffline,msg:"message is offline",reachServer:!1,allowRetry:!1,sender:this});for(const n of Object.keys(e.ext))n.startsWith("s:")&&delete e.ext[n];const t=h.a.Instance.get(e.message.conversationId);return yield this.api.ModifyMessageExt({conversationShortId:o.fromValue(e.message.conversationShortId),messageId:o.fromValue(e.message.serverId),ext:e.ext,ticket:t.ticket}),e.message.ext=Object.assign(e.message.ext,e.ext),l.a.Instance.upsert(e.message),e.message}))}getUserConversationList(e){return M(this,void 0,void 0,(function*(){const t=yield this.api.GetUserConversationList({type:e.type,cursor:e.cursor?o.fromValue(e.cursor):o.ZERO,limit:e.limit?o.fromValue(e.limit):o.fromNumber(20)}),n=t.list.map(d.a.fromServerConversation);return n.forEach(e=>h.a.Instance.upsert(e)),{conversation:n,hasMore:null===t||void 0===t?void 0:t.has_more,cursor:null===t||void 0===t?void 0:t.next_cursor}}))}unreadCountReport(){var e;return M(this,void 0,void 0,(function*(){if(!(null===(e=i.a.Instance.option)||void 0===e?void 0:e.unreadCountReport))throw new r.a({msg:"unread count report not enabled",sender:this,type:s.d.InvalidParam,reachServer:!1});const t=h.a.Instance.getConversationArray(),n=[];let a=0;t.forEach(e=>{const t=e.unreadCount;a+=t,n.push({shortId:o.fromString(e.shortId),count:o.fromNumber(t),type:e.type})});const c=(e,t)=>e.length>t?[e.slice(0,t),...c(e.slice(t),t)]:[e],d=c(n,30);for(const e of d)this.api.UnreadCountReport({total:o.fromValue(a),conv:e})}))}getServerUnreadCount(e){return M(this,void 0,void 0,(function*(){const t=e.conversation.map(e=>o.fromString(e.shortId));void 0===e.getTotal&&(e.getTotal=!1);const n=new Map(e.conversation.map(e=>[e.shortId,e])),s=yield this.api.GetUnreadCount({total:e.getTotal,shortIds:t}),i=new Map;for(const[e,a]of Object.entries(s.conv_unread_count)){const t=(r=e,o.fromNumber(r.charCodeAt(0)).add(o.fromNumber(r.charCodeAt(1)).shiftLeft(8)).add(o.fromNumber(r.charCodeAt(2)).shiftLeft(16)).add(o.fromNumber(r.charCodeAt(3)).shiftLeft(24)).add(o.fromNumber(r.charCodeAt(4)).shiftLeft(32)).add(o.fromNumber(r.charCodeAt(5)).shiftLeft(40)).add(o.fromNumber(r.charCodeAt(6)).shiftLeft(48)).add(o.fromNumber(r.charCodeAt(7)).shiftLeft(56)).toString());n.has(t)&&i.set(n.get(t),a.toNumber())}var r;return{total:s.total_unread_count.toNumber(),unreadCount:i}}))}blockConversation(e){return M(this,void 0,void 0,(function*(){return void 0===e.normalOnly&&(e.normalOnly=!1),yield this.api.BlockConversation({conversationId:e.conversation.id,conversationShortId:o.fromValue(e.conversation.shortId),conversationType:e.conversation.type,status:e.block?_.a.BlockStatus.BLOCK:_.a.BlockStatus.UNBLOCK,normalOnly:e.normalOnly}),yield h.a.Instance.upsertOnline(e.conversation),e.conversation}))}blockMember(e){var t,n;return M(this,void 0,void 0,(function*(){const s={};e.block&&void 0!==e.blockDuration&&Object.keys(e.blockDuration).forEach((e,t)=>{s[e]=o.fromValue(t)});const i=yield this.api.BlockMember({conversationId:e.conversation.id,conversationShortId:o.fromValue(e.conversation.shortId),conversationType:e.conversation.type,status:e.block?_.a.BlockStatus.BLOCK:_.a.BlockStatus.UNBLOCK,time:s,bizExt:null!==(t=e.bizExt)&&void 0!==t?t:{}}),r=m.Instance.getMap(e.conversation.id);for(const t of e.participant)if(!(null===(n=null===i||void 0===i?void 0:i.failed_members)||void 0===n?void 0:n.includes(o.fromValue(t.userId)))&&void 0!==r.get(t.userId)){const n=r.get(t.userId);n.blocked=e.block,m.Instance.upsert(e.conversation.id,n)}return e.conversation}))}getBlockList(e){var t;return M(this,void 0,void 0,(function*(){const n=yield this.api.GetBlockList({cursor:e.cursor?o.fromValue(e.cursor):o.ZERO,limit:null!==(t=e.limit)&&void 0!==t?t:20});return{blockList:n.user_info.map(e=>({userId:e.user_id.toString(),createTime:e.create_time.toString()})),hasMore:null===n||void 0===n?void 0:n.has_more,cursor:null===n||void 0===n?void 0:n.next_cursor}}))}setBlockList(e){return M(this,void 0,void 0,(function*(){yield this.api.SetBlockList({applySet:e.value,blocklist:e.userId.map(o.fromValue)})}))}checkInBlockList(e){return M(this,void 0,void 0,(function*(){return(yield this.api.CheckInBlockList({userToCheck:o.fromValue(e.userId)})).in_blocklist}))}broadcastCreateMessage(e){return M(this,void 0,void 0,(function*(){const t=yield this.instance.createMessage(Object.assign(Object.assign({},e),{insert:!1}));return t.sendFunc=this.broadcastSendMessage.bind(this),t}))}broadcastReceiveMessage(e){var t,n;return M(this,void 0,void 0,(function*(){const i=yield this.api.BroadcastReceiveMessage({conversationId:e.conversation.id,conversationShortId:o.fromString(e.conversation.shortId),conversationType:e.conversation.type,cursor:e.cursor?o.fromValue(e.cursor):o.ZERO,limit:e.limit?o.fromValue(e.limit):o.fromNumber(20),reverse:null!==(t=e.reverse)&&void 0!==t&&t}),r=null===(n=i.messages)||void 0===n?void 0:n.map(v.a.fromServerMessage);for(const e of r){if(!l.a.Instance.getRaw(e.conversationId,e.clientId)){l.a.Instance.upsert(e);const t=l.a.Instance.getRaw(e.conversationId,e.clientId);a.a.Instance.emit(s.g.ReceiveBroadcastNewMessage,this,t)}}return{msgs:r,hasMore:i.has_more,cursor:i.next_cursor}}))}broadcastUserCounter(e){return M(this,void 0,void 0,(function*(){const t=e.conversation.map(e=>({shortId:o.fromString(e.shortId),type:e.type})),n=yield this.api.BroadcastUserCounter({conversations:t});return new Map(n.infos.map(e=>[e.conversation_short_id.toString(),e.counter]))}))}modifyMessageProperty(e){var t,n,r,c;return M(this,void 0,void 0,(function*(){const d={success:!1,payload:e.message},u=h.a.Instance.getRaw(e.message.conversationId);if(!u)return d;for(const o of e.modifyContent){const s=null!==(n=null===(t=e.message.property[o.key])||void 0===t?void 0:t.findIndex(e=>{var t;return e.idempotentId===(null!==(t=o.idempotentId)&&void 0!==t?t:i.a.Instance.userId)}))&&void 0!==n?n:-1;o.operation||(o.operation=-1===s?_.a.OPERATION_TYPE.ADD_PROPERTY_ITEM:_.a.OPERATION_TYPE.REMOVE_PROPERTY_ITEM)}const p=e.modifyContent.map(e=>{var t;return Object.assign(Object.assign({},e),{idempotentId:null!==(t=e.idempotentId)&&void 0!==t?t:i.a.Instance.userId,operation:e.operation})});let I;b.b.mergeOperationToCurrent(e.message,p),l.a.Instance.upsert(e.message),a.a.Instance.emit(s.g.MessagePropertyUpsert,this,e.message);try{I=yield this.api.ModifyMessageProperty({conversationId:u.id,conversationShortId:o.fromValue(u.shortId),conversationType:u.type,serverId:o.fromValue(e.message.serverId),clientId:e.message.clientId,ticket:u.ticket,modifyContent:p})}catch(y){d.success=!1,d.statusCode=I.status,d.statusMsg=y.msg,d.body=I;for(const t of e.modifyContent){const n=null!==(c=null===(r=e.message.property[t.key])||void 0===r?void 0:r.findIndex(e=>{var n;return e.idempotentId===(null!==(n=t.idempotentId)&&void 0!==n?n:i.a.Instance.userId)}))&&void 0!==c?c:-1;-1!==n&&(e.message.property[t.key][n].status=v.b.Failed)}return l.a.Instance.upsert(e.message),a.a.Instance.emit(s.g.MessagePropertyUpsert,this,e.message),d}return[_.a.ModifyMessagePropertyStatus.MODIFY_PROPERTY_SUCCESS,_.a.ModifyMessagePropertyStatus.MODIFY_PROPERTY_REPEAT_REQUEST].includes(null===I||void 0===I?void 0:I.status)&&(d.success=!0),e.message.version=null===I||void 0===I?void 0:I.version,l.a.Instance.upsert(e.message),a.a.Instance.emit(s.g.MessagePropertyUpsert,this,e.message),d.checkCode=o.ZERO,d.checkMsg="",d.statusCode=I.status,d.statusMsg="",d.body=I,d}))}clientAck(e,t){return M(this,void 0,void 0,(function*(){if(e&&e.ext&&e.ext[s.h.MessageStartTimestamp]&&e.ext[s.h.MessageLogid]){let n;switch(yield Object(u.f)()){case u.b.Cellular_2G:n=_.a.NetworkType.MOBILE_2G;break;case u.b.Cellular_3G:n=_.a.NetworkType.MOBILE_3G;break;case u.b.Cellular_4G:n=_.a.NetworkType.MOBILE_4G;break;case u.b.Cellular_5G:n=_.a.NetworkType.MOBILE_5G;break;case u.b.Wifi:n=_.a.NetworkType.WIFI;break;default:n=_.a.NetworkType.UNKNOWN}this.api.ClientAck({startTimeStamp:o.fromString(e.ext[s.h.MessageStartTimestamp]),cmd:_.a.IMCMD.NEW_MSG_NOTIFY,NetworkType:n,logid:e.ext[s.h.MessageLogid],clientTimeStamp:o.fromNumber(Math.round((new Date).getTime())),inboxType:t})}}))}install(){var e;this.api=new g(this.coreContext.netManager),m.Instance=new m,this.coreContext.parManager=m.Instance,this.instance.deleteConversation=this.extendFunc(this.deleteConversation),this.instance.deleteMessage=this.extendFunc(this.deleteMessage),this.instance.leaveConversation=this.extendFunc(this.leaveConversation),this.instance.getMessageReadReceipt=this.extendFunc(this.getMessageReadReceipt),this.instance.getConversationListByTop=this.extendFunc(this.getConversationListByTop),this.instance.getConversationListByFavorite=this.extendFunc(this.getConversationListByFavorite),this.instance.addParticipants=this.extendFunc(this.addParticipants),this.instance.removeParticipants=this.extendFunc(this.removeParticipants),this.instance.setConversationSettingInfo=this.extendFunc(this.setConversationSettingInfo),this.instance.setConversationCoreInfo=this.extendFunc(this.setConversationCoreInfo),this.instance.upsertConversationSettingExtInfo=this.extendFunc(this.upsertConversationSettingExtInfo),this.instance.upsertConversationCoreExtInfo=this.extendFunc(this.upsertConversationCoreExtInfo),this.instance.getConversationParticipants=this.extendFunc(this.getConversationParticipants),this.instance.getConversationParticipantsByPage=this.extendFunc(this.getConversationParticipantsByPage),this.instance.updateConversationReadReceipt=this.extendFunc(this.updateConversationReadReceipt),this.instance.sendUserAction=this.extendFunc(this.sendUserAction),this.instance.sendInputStatus=this.extendFunc(this.sendInputStatus),this.instance.upsertMessageExt=this.extendFunc(this.upsertMessageExt),this.instance.dissolveConversation=this.extendFunc(this.dissolveConversation),this.instance.modifyMessageProperty=this.extendFunc(this.modifyMessageProperty),this.instance.unreadCountReport=this.extendFunc(this.unreadCountReport),this.instance.getServerUnreadCount=this.extendFunc(this.getServerUnreadCount),this.instance.getUserConversationList=this.extendFunc(this.getUserConversationList),this.instance.blockConversation=this.extendFunc(this.blockConversation),this.instance.blockMember=this.extendFunc(this.blockMember),this.instance.sendP2PMessage=this.extendFunc(this.sendP2PMessage),this.instance.setBlockList=this.extendFunc(this.setBlockList),this.instance.getBlockList=this.extendFunc(this.getBlockList),this.instance.checkInBlockList=this.extendFunc(this.checkInBlockList),this.instance.broadcastCreateMessage=this.extendFunc(this.broadcastCreateMessage),this.instance.broadcastReceiveMessage=this.extendFunc(this.broadcastReceiveMessage),this.instance.broadcastUserCounter=this.extendFunc(this.broadcastUserCounter),this.addEventHandler(),l.a.Instance.injectProcessor(new x),void 0===(null===(e=i.a.Instance.option)||void 0===e?void 0:e.autoReadIndex)&&(i.a.Instance.option.autoReadIndex=!0)}receivePacket(e){return M(this,void 0,void 0,(function*(){if(e.cmd===_.a.IMCMD.NEW_MSG_NOTIFY){const t=e.body.has_new_message_notify,n=l.a.Instance.getRaw(t.message.conversation_id,t.message.ext[s.h.ClientMessageId]);if(!n)return;const o=h.a.Instance.get(t.message.conversation_id);if(yield this.clientAck(n,o.inboxType),n.type===_.a.MessageType.MESSAGE_TYPE_BLOCK_COMMAND){const e=JSON.parse(n.content),t=e.block_status;if(1===e.type){const n=e.userID;if(null===n||void 0===n||0===n.length)return;const s=m.Instance.getMap(o.id);for(const e of n)s.get(e).blocked=t,m.Instance.upsert(o.id,s.get(e))}else 2===e.type?(o.block=t,o.blockNormalOnly=!!t,h.a.Instance.upsert(o)):3===e.type&&(o.block=t,h.a.Instance.upsert(o))}}else if(e.cmd===_.a.IMCMD.NEW_BROADCAST_MSG_NOTIFY){const t=e.body.has_new_message_notify.message,n=t.ext[s.h.ClientMessageId];if(!l.a.Instance.getRaw(t.conversation_id,n)){const e=v.a.fromServerMessage(t);l.a.Instance.upsert(e);const o=l.a.Instance.getRaw(e.conversationId,n);a.a.Instance.emit(s.g.ReceiveBroadcastNewMessage,this,o)}}}))}dispose(){return M(this,void 0,void 0,(function*(){m.Instance.dispose()}))}addEventHandler(){var e;a.a.Instance.subscribe(s.g.ParticipantUpdate,e=>M(this,void 0,void 0,(function*(){if(i.a.Instance.initResult===s.i.Start)return void c.a.Instance.debug("ignore cmd participant updated:",e);const t=h.a.Instance.get(e.conversationId);yield this.updateConversationReadReceipt({conversation:t})}))),(null===(e=i.a.Instance.option)||void 0===e?void 0:e.autoReadIndex)&&a.a.Instance.subscribe(s.g.MessageUpsert,e=>M(this,void 0,void 0,(function*(){if(e.flightStatus===s.f.Inflight)return;const t=h.a.Instance.getRaw(e.conversationId);if(!t)return;if(0===m.Instance.getRaw(t.id).length)return;const n=m.Instance.getByUserIdRaw(t.id,e.sender);n&&(n.readIndex=e.indexInConversation,n.readOrder=e.orderInConversation,m.Instance.upsert(t.id,n),c.a.Instance.debug(`auto readindex with read:${n.readIndex.toString()} & order:${n.readOrder.toString()}`))})))}broadcastSendMessage(e){return M(this,void 0,void 0,(function*(){const t=h.a.Instance.get(e.conversationId),n={success:!1,payload:e};e.flightStatus=s.f.Inflight,t.ticket||(yield h.a.Instance.refreshTicket(t.id));try{const i=yield this.api.BroadcastSendMessage({conversationId:e.conversationId,conversationShortId:o.fromString(e.conversationShortId),conversationType:e.conversationType,clientId:e.clientId,content:e.content,ticket:t.ticket,ext:e.ext,type:e.type,mentionedUsers:e.mentionedUsers.map(e=>o.fromString(e))});if(n.body=i,n.checkCode=i.check_code,n.checkMsg=i.check_message,n.statusCode=i.status,n.statusMsg=i.extra_info,0===i.status){const t=i.server_message_id.toString();e.serverId=t,e.flightStatus=s.f.Succeeded,n.success=!0}else e.flightStatus=s.f.Rejected,i.status===_.a.SendMessageStatus.CHECK_MSG_NOT_PASS_BUT_SELF_VISIBLE&&(e.flightStatus=s.f.SelfVisible)}catch(i){e.flightStatus=s.f.Failed}return n}))}}}}]);