(window.webpackJsonp_N_E=window.webpackJsonp_N_E||[]).push([[130],{"+ZTy":function(e,t,n){"use strict";n.d(t,"a",(function(){return i}));var r=n("VXtF");class i{constructor(){this.userId="",this.initResult=r.i.NotAvailable,this.cachedToken=null}}i.Instance=new i},1277:function(e,t){e.exports=r;var n=null;try{n=new WebAssembly.Instance(new WebAssembly.Module(new Uint8Array([0,97,115,109,1,0,0,0,1,13,2,96,0,1,127,96,4,127,127,127,127,1,127,3,7,6,0,1,1,1,1,1,6,6,1,127,1,65,0,11,7,50,6,3,109,117,108,0,1,5,100,105,118,95,115,0,2,5,100,105,118,95,117,0,3,5,114,101,109,95,115,0,4,5,114,101,109,95,117,0,5,8,103,101,116,95,104,105,103,104,0,0,10,191,1,6,4,0,35,0,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,126,34,4,66,32,135,167,36,0,32,4,167,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,127,34,4,66,32,135,167,36,0,32,4,167,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,128,34,4,66,32,135,167,36,0,32,4,167,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,129,34,4,66,32,135,167,36,0,32,4,167,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,130,34,4,66,32,135,167,36,0,32,4,167,11])),{}).exports}catch(w){}function r(e,t,n){this.low=0|e,this.high=0|t,this.unsigned=!!n}function i(e){return!0===(e&&e.__isLong__)}r.prototype.__isLong__,Object.defineProperty(r.prototype,"__isLong__",{value:!0}),r.isLong=i;var s={},o={};function a(e,t){var n,r,i;return t?(i=0<=(e>>>=0)&&e<256)&&(r=o[e])?r:(n=u(e,(0|e)<0?-1:0,!0),i&&(o[e]=n),n):(i=-128<=(e|=0)&&e<128)&&(r=s[e])?r:(n=u(e,e<0?-1:0,!1),i&&(s[e]=n),n)}function c(e,t){if(isNaN(e))return t?I:m;if(t){if(e<0)return I;if(e>=g)return E}else{if(e<=-v)return _;if(e+1>=v)return b}return e<0?c(-e,t).neg():u(e%f|0,e/f|0,t)}function u(e,t,n){return new r(e,t,n)}r.fromInt=a,r.fromNumber=c,r.fromBits=u;var d=Math.pow;function h(e,t,n){if(0===e.length)throw Error("empty string");if("NaN"===e||"Infinity"===e||"+Infinity"===e||"-Infinity"===e)return m;if("number"===typeof t?(n=t,t=!1):t=!!t,(n=n||10)<2||36<n)throw RangeError("radix");var r;if((r=e.indexOf("-"))>0)throw Error("interior hyphen");if(0===r)return h(e.substring(1),t,n).neg();for(var i=c(d(n,8)),s=m,o=0;o<e.length;o+=8){var a=Math.min(8,e.length-o),u=parseInt(e.substring(o,o+a),n);if(a<8){var l=c(d(n,a));s=s.mul(l).add(c(u))}else s=(s=s.mul(i)).add(c(u))}return s.unsigned=t,s}function l(e,t){return"number"===typeof e?c(e,t):"string"===typeof e?h(e,t):u(e.low,e.high,"boolean"===typeof t?t:e.unsigned)}r.fromString=h,r.fromValue=l;var f=4294967296,g=f*f,v=g/2,p=a(1<<24),m=a(0);r.ZERO=m;var I=a(0,!0);r.UZERO=I;var y=a(1);r.ONE=y;var C=a(1,!0);r.UONE=C;var S=a(-1);r.NEG_ONE=S;var b=u(-1,2147483647,!1);r.MAX_VALUE=b;var E=u(-1,-1,!0);r.MAX_UNSIGNED_VALUE=E;var _=u(0,-2147483648,!1);r.MIN_VALUE=_;var x=r.prototype;x.toInt=function(){return this.unsigned?this.low>>>0:this.low},x.toNumber=function(){return this.unsigned?(this.high>>>0)*f+(this.low>>>0):this.high*f+(this.low>>>0)},x.toString=function(e){if((e=e||10)<2||36<e)throw RangeError("radix");if(this.isZero())return"0";if(this.isNegative()){if(this.eq(_)){var t=c(e),n=this.div(t),r=n.mul(t).sub(this);return n.toString(e)+r.toInt().toString(e)}return"-"+this.neg().toString(e)}for(var i=c(d(e,6),this.unsigned),s=this,o="";;){var a=s.div(i),u=(s.sub(a.mul(i)).toInt()>>>0).toString(e);if((s=a).isZero())return u+o;for(;u.length<6;)u="0"+u;o=""+u+o}},x.getHighBits=function(){return this.high},x.getHighBitsUnsigned=function(){return this.high>>>0},x.getLowBits=function(){return this.low},x.getLowBitsUnsigned=function(){return this.low>>>0},x.getNumBitsAbs=function(){if(this.isNegative())return this.eq(_)?64:this.neg().getNumBitsAbs();for(var e=0!=this.high?this.high:this.low,t=31;t>0&&0==(e&1<<t);t--);return 0!=this.high?t+33:t+1},x.isZero=function(){return 0===this.high&&0===this.low},x.eqz=x.isZero,x.isNegative=function(){return!this.unsigned&&this.high<0},x.isPositive=function(){return this.unsigned||this.high>=0},x.isOdd=function(){return 1===(1&this.low)},x.isEven=function(){return 0===(1&this.low)},x.equals=function(e){return i(e)||(e=l(e)),(this.unsigned===e.unsigned||this.high>>>31!==1||e.high>>>31!==1)&&(this.high===e.high&&this.low===e.low)},x.eq=x.equals,x.notEquals=function(e){return!this.eq(e)},x.neq=x.notEquals,x.ne=x.notEquals,x.lessThan=function(e){return this.comp(e)<0},x.lt=x.lessThan,x.lessThanOrEqual=function(e){return this.comp(e)<=0},x.lte=x.lessThanOrEqual,x.le=x.lessThanOrEqual,x.greaterThan=function(e){return this.comp(e)>0},x.gt=x.greaterThan,x.greaterThanOrEqual=function(e){return this.comp(e)>=0},x.gte=x.greaterThanOrEqual,x.ge=x.greaterThanOrEqual,x.compare=function(e){if(i(e)||(e=l(e)),this.eq(e))return 0;var t=this.isNegative(),n=e.isNegative();return t&&!n?-1:!t&&n?1:this.unsigned?e.high>>>0>this.high>>>0||e.high===this.high&&e.low>>>0>this.low>>>0?-1:1:this.sub(e).isNegative()?-1:1},x.comp=x.compare,x.negate=function(){return!this.unsigned&&this.eq(_)?_:this.not().add(y)},x.neg=x.negate,x.add=function(e){i(e)||(e=l(e));var t=this.high>>>16,n=65535&this.high,r=this.low>>>16,s=65535&this.low,o=e.high>>>16,a=65535&e.high,c=e.low>>>16,d=0,h=0,f=0,g=0;return f+=(g+=s+(65535&e.low))>>>16,h+=(f+=r+c)>>>16,d+=(h+=n+a)>>>16,d+=t+o,u((f&=65535)<<16|(g&=65535),(d&=65535)<<16|(h&=65535),this.unsigned)},x.subtract=function(e){return i(e)||(e=l(e)),this.add(e.neg())},x.sub=x.subtract,x.multiply=function(e){if(this.isZero())return m;if(i(e)||(e=l(e)),n)return u(n.mul(this.low,this.high,e.low,e.high),n.get_high(),this.unsigned);if(e.isZero())return m;if(this.eq(_))return e.isOdd()?_:m;if(e.eq(_))return this.isOdd()?_:m;if(this.isNegative())return e.isNegative()?this.neg().mul(e.neg()):this.neg().mul(e).neg();if(e.isNegative())return this.mul(e.neg()).neg();if(this.lt(p)&&e.lt(p))return c(this.toNumber()*e.toNumber(),this.unsigned);var t=this.high>>>16,r=65535&this.high,s=this.low>>>16,o=65535&this.low,a=e.high>>>16,d=65535&e.high,h=e.low>>>16,f=65535&e.low,g=0,v=0,I=0,y=0;return I+=(y+=o*f)>>>16,v+=(I+=s*f)>>>16,I&=65535,v+=(I+=o*h)>>>16,g+=(v+=r*f)>>>16,v&=65535,g+=(v+=s*h)>>>16,v&=65535,g+=(v+=o*d)>>>16,g+=t*f+r*h+s*d+o*a,u((I&=65535)<<16|(y&=65535),(g&=65535)<<16|(v&=65535),this.unsigned)},x.mul=x.multiply,x.divide=function(e){if(i(e)||(e=l(e)),e.isZero())throw Error("division by zero");var t,r,s;if(n)return this.unsigned||-2147483648!==this.high||-1!==e.low||-1!==e.high?u((this.unsigned?n.div_u:n.div_s)(this.low,this.high,e.low,e.high),n.get_high(),this.unsigned):this;if(this.isZero())return this.unsigned?I:m;if(this.unsigned){if(e.unsigned||(e=e.toUnsigned()),e.gt(this))return I;if(e.gt(this.shru(1)))return C;s=I}else{if(this.eq(_))return e.eq(y)||e.eq(S)?_:e.eq(_)?y:(t=this.shr(1).div(e).shl(1)).eq(m)?e.isNegative()?y:S:(r=this.sub(e.mul(t)),s=t.add(r.div(e)));if(e.eq(_))return this.unsigned?I:m;if(this.isNegative())return e.isNegative()?this.neg().div(e.neg()):this.neg().div(e).neg();if(e.isNegative())return this.div(e.neg()).neg();s=m}for(r=this;r.gte(e);){t=Math.max(1,Math.floor(r.toNumber()/e.toNumber()));for(var o=Math.ceil(Math.log(t)/Math.LN2),a=o<=48?1:d(2,o-48),h=c(t),f=h.mul(e);f.isNegative()||f.gt(r);)f=(h=c(t-=a,this.unsigned)).mul(e);h.isZero()&&(h=y),s=s.add(h),r=r.sub(f)}return s},x.div=x.divide,x.modulo=function(e){return i(e)||(e=l(e)),n?u((this.unsigned?n.rem_u:n.rem_s)(this.low,this.high,e.low,e.high),n.get_high(),this.unsigned):this.sub(this.div(e).mul(e))},x.mod=x.modulo,x.rem=x.modulo,x.not=function(){return u(~this.low,~this.high,this.unsigned)},x.and=function(e){return i(e)||(e=l(e)),u(this.low&e.low,this.high&e.high,this.unsigned)},x.or=function(e){return i(e)||(e=l(e)),u(this.low|e.low,this.high|e.high,this.unsigned)},x.xor=function(e){return i(e)||(e=l(e)),u(this.low^e.low,this.high^e.high,this.unsigned)},x.shiftLeft=function(e){return i(e)&&(e=e.toInt()),0===(e&=63)?this:e<32?u(this.low<<e,this.high<<e|this.low>>>32-e,this.unsigned):u(0,this.low<<e-32,this.unsigned)},x.shl=x.shiftLeft,x.shiftRight=function(e){return i(e)&&(e=e.toInt()),0===(e&=63)?this:e<32?u(this.low>>>e|this.high<<32-e,this.high>>e,this.unsigned):u(this.high>>e-32,this.high>=0?0:-1,this.unsigned)},x.shr=x.shiftRight,x.shiftRightUnsigned=function(e){if(i(e)&&(e=e.toInt()),0===(e&=63))return this;var t=this.high;return e<32?u(this.low>>>e|t<<32-e,t>>>e,this.unsigned):u(32===e?t:t>>>e-32,0,this.unsigned)},x.shru=x.shiftRightUnsigned,x.shr_u=x.shiftRightUnsigned,x.toSigned=function(){return this.unsigned?u(this.low,this.high,!1):this},x.toUnsigned=function(){return this.unsigned?this:u(this.low,this.high,!0)},x.toBytes=function(e){return e?this.toBytesLE():this.toBytesBE()},x.toBytesLE=function(){var e=this.high,t=this.low;return[255&t,t>>>8&255,t>>>16&255,t>>>24,255&e,e>>>8&255,e>>>16&255,e>>>24]},x.toBytesBE=function(){var e=this.high,t=this.low;return[e>>>24,e>>>16&255,e>>>8&255,255&e,t>>>24,t>>>16&255,t>>>8&255,255&t]},r.fromBytes=function(e,t,n){return n?r.fromBytesLE(e,t):r.fromBytesBE(e,t)},r.fromBytesLE=function(e,t){return new r(e[0]|e[1]<<8|e[2]<<16|e[3]<<24,e[4]|e[5]<<8|e[6]<<16|e[7]<<24,t)},r.fromBytesBE=function(e,t){return new r(e[4]<<24|e[5]<<16|e[6]<<8|e[7],e[0]<<24|e[1]<<16|e[2]<<8|e[3],t)}},"39GT":function(e,t,n){"use strict";n.d(t,"a",(function(){return o}));var r=n("VXtF"),i=n("YnhK"),s=n("EbSe");class o extends Error{constructor(e){var t,n;super(`${e&&e.msg?'message: "'+e.msg+'"':""}${e&&e.innerError?`, inner error: "${e.innerError}"`:""}`),Object.assign(this,e),Object.setPrototypeOf(this,o.prototype),e.ignoreEvent||i.a.Instance.emit(r.g.Error,e.sender,this),s.a.Instance.emitError(this),s.a.Instance.emitCounter(s.b.BizSdkError,1,{error:null!==(n=null===(t=e.type)||void 0===t?void 0:t.toString())&&void 0!==n?n:"unknown"})}}},"4tOJ":function(e,t,n){"use strict";n.d(t,"a",(function(){return i}));var r=function(e,t,n,r){return new(n||(n=Promise))((function(i,s){function o(e){try{c(r.next(e))}catch(t){s(t)}}function a(e){try{c(r.throw(e))}catch(t){s(t)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))};class i{execute(e){return r(this,void 0,void 0,(function*(){let t=e;return t=yield this.before(t),t=yield this.process(t),t=yield this.after(t),t}))}before(e){return r(this,void 0,void 0,(function*(){return e}))}after(e){return r(this,void 0,void 0,(function*(){return e}))}}},"5dHo":function(e,t,n){"use strict";n.r(t),n.d(t,"StrangerPlugin",(function(){return S})),n.d(t,"StrangerConversation",(function(){return v}));var r=n("1277"),i=n("g98E"),s=n("Fjbr"),o=n("VYFf"),a=n("Hd7d"),c=n("VXtF"),u=n("YnhK"),d=n("ba9d"),h=n("xQJc"),l=function(e,t,n,r){return new(n||(n=Promise))((function(i,s){function o(e){try{c(r.next(e))}catch(t){s(t)}}function a(e){try{c(r.throw(e))}catch(t){s(t)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))};class f extends h.a{GetStrangerConversationList(e){return l(this,void 0,void 0,(function*(){const t=d.a.RequestBody.create({get_stranger_conversation_body:{cursor:e.cursor,count:r.fromValue(e.limit),show_total_unread:!0}});return(yield this.send(t,d.a.IMCMD.GET_STRANGER_CONVERSATION_LIST)).get_stranger_conversation_body}))}GetStrangerConversationMessage(e){return l(this,void 0,void 0,(function*(){const t=d.a.RequestBody.create({get_stranger_messages_body:{conversation_short_id:e.shortId,reset_unread_count:e.resetUnreadCount}});return(yield this.send(t,d.a.IMCMD.GET_STRANGER_MESSAGES_IN_CONVERSATION)).get_stranger_messages_body}))}DeleteStrangerMessage(e){return l(this,void 0,void 0,(function*(){const t=d.a.RequestBody.create({delete_stranger_message_body:{conversation_short_id:e.shortId,server_message_id:e.serverId}});return this.send(t,d.a.IMCMD.DELETE_STRANGER_MESSAGE)}))}DeleteStrangerConversation(e){return l(this,void 0,void 0,(function*(){const t=d.a.RequestBody.create({delete_stranger_conversation_body:{conversation_short_id:e.shortId}});return this.send(t,d.a.IMCMD.DELETE_STRANGER_CONVERSATION)}))}MarkStrangerConversationRead(e){return l(this,void 0,void 0,(function*(){const t=d.a.RequestBody.create({mark_stranger_conversation_read_body:{conversation_short_id:e.shortId}});return this.send(t,d.a.IMCMD.MARK_STRANGER_CONVERSATION_READ)}))}MarkAllStrangerConversationRead(){return l(this,void 0,void 0,(function*(){const e=d.a.RequestBody.create({mark_stranger_all_conversation_read_body:{}});return this.send(e,d.a.IMCMD.MARK_ALL_STRANGER_CONVERSATIONS_READ)}))}DeleteAllStrangerConversation(){return l(this,void 0,void 0,(function*(){const e=d.a.RequestBody.create({delete_stranger_all_conversation_body:{}});return this.send(e,d.a.IMCMD.DELETE_ALL_STRANGER_CONVERSATIONS)}))}}var g=n("r7qN");class v extends g.a{get unreadCount(){return this.internalUnreadCount}set unreadCount(e){this.internalUnreadCount=e}get mode(){const e=this.toParticipantUserId,t=this.id.split(":");return t[2]===e?1:t[3]===e?2:3}get ext(){return{}}}var p=n("4tOJ"),m=n("7af5"),I=function(e,t,n,r){return new(n||(n=Promise))((function(i,s){function o(e){try{c(r.next(e))}catch(t){s(t)}}function a(e){try{c(r.throw(e))}catch(t){s(t)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))};class y extends p.a{process(e){return I(this,void 0,void 0,(function*(){if(e.data.type===d.a.MessageType.MESSAGE_TYPE_MODE_CHANGE){const t=s.a.Instance.getRaw(e.data.conversationId);if(!t)return m.a.Instance.debug(`conversation ${e.data.conversationId} not exist, ignore upgrade`),e;if(!t.isStrangerConversation)return m.a.Instance.debug(`conversation ${e.data.conversationId} not stranger, ignore upgrade`),e;s.a.Instance.delete(e.data.conversationId);const n=yield s.a.Instance.getWithOnline(e.data.conversationId,e.data.conversationShortId,e.data.conversationType);n.readIndex=n.lastMessageIndex,m.a.Instance.debug("stranger upgrade,",n),u.a.Instance.emit(c.g.StrangerUpgrade,this,n),e.needContinue=!1}return e}))}}var C=function(e,t,n,r){return new(n||(n=Promise))((function(i,s){function o(e){try{c(r.next(e))}catch(t){s(t)}}function a(e){try{c(r.throw(e))}catch(t){s(t)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))};class S extends i.a{constructor(){super(...arguments),this.internalUnreadCount=0}getStrangerConversationList(e={}){var t,n,i,c,u,h;return C(this,void 0,void 0,(function*(){const l=yield this.api.GetStrangerConversationList({cursor:e.cursor?r.fromValue(e.cursor):r.ZERO,limit:null!==(t=e.limit)&&void 0!==t?t:10}),f=null===l||void 0===l?void 0:l.conversation_list;this.internalUnreadCount=null===l||void 0===l?void 0:l.total_unread;let g=!1;if("0"===(null===(n=e.cursor)||void 0===n?void 0:n.toString())&&1===e.limit){const e=yield this.getStrangerPreview({sync:!1});f&&1===f.length&&(null===(i=null===e||void 0===e?void 0:e.conversation)||void 0===i?void 0:i.id)===f[0].conversation_id&&(null===(c=null===e||void 0===e?void 0:e.message)||void 0===c?void 0:c.serverId)===(null===(h=null===(u=f[0].last_message)||void 0===u?void 0:u.server_message_id)||void 0===h?void 0:h.toString())&&(null===e||void 0===e?void 0:e.unreadCount)===(null===l||void 0===l?void 0:l.total_unread)&&(g=!0)}return{conversation:f.map(e=>{const t=new v;if(t.id=e.conversation_id,t.shortId=e.conversation_short_id.toString(),t.type=d.a.ConversationType.ONE_TO_ONE_CHAT,t.unreadCount=e.unread,t.isOffline=!1,t.firstPageParticipant=d.a.ParticipantsPage.create({participants:e.participants}),!g){s.a.Instance.upsert(t);const n=o.a.fromServerMessage(e.last_message);a.a.Instance.upsert(n)}return t}),unreadCount:null===l||void 0===l?void 0:l.total_unread,hasMore:null===l||void 0===l?void 0:l.has_more,cursor:null===l||void 0===l?void 0:l.next_cursor}}))}getStrangerConversationMessage(e){var t;return C(this,void 0,void 0,(function*(){const n=yield this.api.GetStrangerConversationMessage({shortId:r.fromString(e.conversation.shortId),resetUnreadCount:null!==(t=e.resetUnreadCount)&&void 0!==t&&t});return(null===n||void 0===n?void 0:n.messages).forEach(e=>a.a.Instance.upsert(o.a.fromServerMessage(e))),a.a.Instance.getList(e.conversation.id)}))}deleteStrangerMessage(e){return C(this,void 0,void 0,(function*(){yield this.api.DeleteStrangerMessage({serverId:r.fromString(e.message.serverId),shortId:r.fromString(e.conversation.shortId)}),a.a.Instance.delete(e.conversation.id,e.message.serverId)}))}deleteStrangerConversation(e){return C(this,void 0,void 0,(function*(){yield this.api.DeleteStrangerConversation({shortId:r.fromString(e.conversation.shortId)}),s.a.Instance.delete(e.conversation.id)}))}markStrangerConversationRead(e){return C(this,void 0,void 0,(function*(){yield this.api.MarkStrangerConversationRead({shortId:r.fromString(e.conversation.shortId)}),this.internalUnreadCount-=e.conversation.unreadCount,e.conversation.unreadCount=0,s.a.Instance.upsert(e.conversation)}))}markAllStrangerConversationRead(){return C(this,void 0,void 0,(function*(){yield this.api.MarkAllStrangerConversationRead();s.a.Instance.getConversationArray(e=>0!==e.mode).forEach(e=>{e.unreadCount=0,s.a.Instance.upsert(e)}),this.internalUnreadCount=0}))}deleteAllStrangerConversation(){return C(this,void 0,void 0,(function*(){yield this.api.DeleteAllStrangerConversation();s.a.Instance.getConversationArray(e=>0!==e.mode).forEach(e=>s.a.Instance.delete(e.id)),this.internalUnreadCount=0}))}getStrangetTotalUnread(){return this.internalUnreadCount}getStrangerPreview(e={}){var t;return C(this,void 0,void 0,(function*(){const n=yield this.refreshStrangerPreviewConversation(null!==(t=null===e||void 0===e?void 0:e.sync)&&void 0!==t&&t);return n?{conversation:n,message:n.lastVisibleMessage,unreadCount:this.internalUnreadCount}:null}))}getLocalStrangerConversation(){return s.a.Instance.getConversationArray(e=>0!==e.mode)}install(){this.api=new f(this.coreContext.netManager),this.instance.getStrangerConversationList=this.extendFunc(this.getStrangerConversationList),this.instance.getStrangerConversationMessage=this.extendFunc(this.getStrangerConversationMessage),this.instance.deleteStrangerMessage=this.extendFunc(this.deleteStrangerMessage),this.instance.deleteStrangerConversation=this.extendFunc(this.deleteStrangerConversation),this.instance.deleteAllStrangerConversation=this.extendFunc(this.deleteAllStrangerConversation),this.instance.markStrangerConversationRead=this.extendFunc(this.markStrangerConversationRead),this.instance.markAllStrangerConversationRead=this.extendFunc(this.markAllStrangerConversationRead),this.instance.getStrangerTotalUnread=this.extendFunc(this.getStrangetTotalUnread),this.instance.getStrangerPreview=this.extendFunc(this.getStrangerPreview),this.instance.getLocalStrangerConversation=this.extendFunc(this.getLocalStrangerConversation),a.a.Instance.injectProcessor(new y),this.coreContext.eventBus.subscribe(c.g.StrangerUpgrade,e=>C(this,void 0,void 0,(function*(){yield this.coreContext.instance.getMessagesByUser({inboxType:e.inboxType})})))}init(){return C(this,void 0,void 0,(function*(){yield this.getStrangerPreview({sync:!0})}))}receivePacket(e){var t;return C(this,void 0,void 0,(function*(){if(e.cmd===d.a.IMCMD.STRANGER_NEW_MSG_NOTIFY){const n=null===(t=e.body)||void 0===t?void 0:t.has_new_message_notify.message;if(!s.a.Instance.getRaw(n.conversation_id))return;const r=o.a.fromServerMessage(n);return a.a.Instance.upsert(r),this.internalUnreadCount++,void u.a.Instance.emit(c.g.ReceiveNewStrangerMessage,this,r)}}))}ticker(){return C(this,void 0,void 0,(function*(){yield this.refreshStrangerPreviewConversation(!0)}))}refreshStrangerPreviewConversation(e=!1){return C(this,void 0,void 0,(function*(){e&&(yield this.getStrangerConversationList({cursor:r.ZERO,limit:1}));const t=s.a.Instance.getConversationArray(e=>0!==e.mode);for(const e of t)if(e.lastVisibleMessage)return e;return null}))}}},"7af5":function(e,t,n){"use strict";n.d(t,"b",(function(){return r})),n.d(t,"a",(function(){return a}));var r,i=n("+ZTy"),s=n("EbSe");!function(e){e[e.debug=0]="debug",e[e.info=1]="info",e[e.warn=2]="warn",e[e.error=3]="error"}(r||(r={}));r.info,r.debug,r.warn,r.error;const o={debug:r.debug,info:r.info,warn:r.warn,error:r.error};class a{constructor(){this.level=r.debug}info(...e){this.log("info",...e)}log(e,...t){var n;s.a.Instance.emitLog(o[e],t),(null===(n=i.a.Instance.option)||void 0===n?void 0:n.debug)&&(this.level,r[e])}debug(...e){this.log("debug",...e)}warn(...e){this.log("warn",...e)}error(...e){this.log("error",...e)}}a.Instance=new a},EbSe:function(e,t,n){"use strict";n.d(t,"b",(function(){return r})),n.d(t,"a",(function(){return o}));var r,i=n("VXtF"),s=n("+ZTy");!function(e){e.NetworkTimeout="network.req.timeout",e.NetworkSuccess="network.req.success",e.NetworkError="network.req.error",e.FrontierOpen="network.frontier.open",e.FrontierClose="network.frontier.close",e.FrontierError="network.frontier.error",e.FrontierReceive="network.frontier.receive",e.FrontierLive="network.frontier.live",e.WebSocketDisconnect="network.ws.disconnect",e.WebSocketConnect="network.ws.connect",e.ReqSuccess="biz.req.success",e.ReqError="biz.req.error",e.BizSdkInit="biz.sdk.init",e.BizRefreshToken="biz.sdk.refresh_token",e.BizSdkError="biz.sdk.error",e.BizMessageLatency="biz.message.latency",e.BizProcessMessage="biz.message.process",e.BizMessageFromUser="biz.message.from_user_pull",e.BizMessageFromInit="biz.message.from_init",e.BizReceiveMessage="biz.message.receive",e.BizReceiveCmdMessage="biz.message.receive_cmd",e.BizReceiveTextMessage="biz.message.receive_text",e.BizConversationFromInit="biz.conversation.from_init",e.BizApiPrefix="biz.api.",e.BizApiSuccessSuffix=".success",e.BizApiErrorSuffix=".error"}(r||(r={}));class o{constructor(){this.memoryMetrics=new Map}static performanceNow(){return"object"===typeof performance?performance.now():Date.now()}invoke(e,...t){var n;if(void 0===(null===(n=s.a.Instance.option)||void 0===n?void 0:n.monitor))return!1;const r=s.a.Instance.option.monitor,i=r[e];return"function"===typeof i&&setTimeout(()=>{i.apply(r,t)},0)}fillKv(e){var t;const n=Object.assign(Object.assign({},e),{sdk_version:i.l.sdkVersion,build_number:i.l.buildNumber,app_id:s.a.Instance.option.appId.toString()});return(null===(t=s.a.Instance.option)||void 0===t?void 0:t.versionCode)&&(n.version_code=s.a.Instance.option.versionCode),n}emitCounter(e,t=1,n={}){if(0===t)return;const r=e+".counter";this.invoke("emitCounter",r,t,this.fillKv(n)),void 0===this.memoryMetrics.get(r)&&this.memoryMetrics.set(r,0),this.memoryMetrics.set(r,this.memoryMetrics.get(r)+t)}emitDuration(e,t,n={}){const r=o.performanceNow()-t,i=e+".duration";return this.invoke("emitDuration",i,r,this.fillKv(n)),void 0===this.memoryMetrics.get(i)?this.memoryMetrics.set(i,r):this.memoryMetrics.set(i,(this.memoryMetrics.get(i)+r)/2),r}emitLatencyDuration(e,t,n={}){const r=Date.now()-t,i=e+".duration";this.invoke("emitDuration",i,r,this.fillKv(n)),void 0===this.memoryMetrics.get(i)?this.memoryMetrics.set(i,r):this.memoryMetrics.set(i,(this.memoryMetrics.get(i)+r)/2)}emitError(e){this.invoke("emitError",e)}emitNetwork(e,t){this.invoke("emitNetwork",e,t)}emitEvent(e,t,n){this.invoke("emitEvent",e,t,n)}emitLog(e,...t){this.invoke("emitLog",e,t[0])}}o.Instance=new o},Fjbr:function(e,t,n){"use strict";n.d(t,"a",(function(){return v}));var r=n("1277"),i=n("ba9d"),s=n("VXtF"),o=n("+ZTy"),a=n("39GT"),c=n("YnhK"),u=n("7af5"),d=n("r7qN"),h=n("xIz2"),l=n("q8ia"),f=n("Hd7d"),g=function(e,t,n,r){return new(n||(n=Promise))((function(i,s){function o(e){try{c(r.next(e))}catch(t){s(t)}}function a(e){try{c(r.throw(e))}catch(t){s(t)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))};class v{constructor(){this.conversations=new Map}applyLocal(e){e.forEach(e=>{this.upsert(e)})}getWithCreateLocal(e,t,n){let r=v.Instance.getRaw(e);if(!r){const i=new d.a;i.id=e,i.shortId=t,i.type=n,i.inboxType=0,i.isOffline=!0,i.coreInfo=new h.a(i),i.settingInfo=new l.a(i),r=i,u.a.Instance.debug("create local conv:",i),v.Instance.upsert(r)}return r}upsert(e){var t;let n=this.conversations.get(e.id);if(n&&e.isOffline&&(u.a.Instance.warn(`local exist, try to use offline upsert, ignore, short id: ${n.shortId} with offline:${e.shortId}`),!n.isOffline))return u.a.Instance.warn("local is online, ignore update"),n;if(n){let t=n.coreInfo||new h.a(n),r=n.settingInfo||new l.a(n);n=Object.assign(n,e),e.coreInfo&&(t=Object.assign(t,e.coreInfo),n.coreInfo=t),e.settingInfo&&(r=Object.assign(r,e.settingInfo),n.settingInfo=r)}return this.conversations.set(e.id,null!==n&&void 0!==n?n:e),null===(t=o.a.Instance.dbProxy)||void 0===t||t.upsertConversation(null!==n&&void 0!==n?n:e),c.a.Instance.emit(s.g.ConversationUpsert,this,null!==n&&void 0!==n?n:e),o.a.Instance.initResult!==s.i.Start&&c.a.Instance.emitEmpty(s.g.ConversationChange,this),e}refreshLocal(){return g(this,void 0,void 0,(function*(){const e=this.getConversationArray().filter(e=>e.isOffline);if(0!==e.length)return this.refresh(e)}))}refresh(e){var t;return g(this,void 0,void 0,(function*(){u.a.Instance.debug("refresh conv: ",e);const n=(e,t)=>e.length>t?[e.slice(0,t),...n(e.slice(t),t)]:[e],i=n(e,5);for(const e of i){const n=(yield null===(t=o.a.Instance.api)||void 0===t?void 0:t.GetConversationInfoListV2({conversations:e.map(e=>({conversationId:e.id,conversationShortId:r.fromString(e.shortId),conversationType:e.type}))})).conversation_info_list;e.forEach(e=>{0===n.filter(t=>t.conversation_id===e.id).length&&(u.a.Instance.warn("delete local conv, may not exist online: ",e),v.Instance.delete(e.id))}),n.forEach(e=>{this.upsert(d.a.fromServerConversation(e))})}}))}upsertOnlineBroadcast(e){var t;return g(this,void 0,void 0,(function*(){const n=(yield null===(t=o.a.Instance.api)||void 0===t?void 0:t.GetConversationCoreInfo({conversationId:e.id,conversationShortId:r.fromString(e.shortId),conversationType:e.type})).get_conversation_core_info_body;if(!n||!n.conversation_core_info)throw new a.a({type:s.d.ConversationNotExistError,msg:`local conversation: ${e.id} not found online`,sender:this,args:{conversationId:e.id}});const i=d.a.fromServerBroadcast(n.conversation_core_info);return this.upsert(i)}))}upsertOnline(e){var t;return g(this,void 0,void 0,(function*(){const n=yield null===(t=o.a.Instance.api)||void 0===t?void 0:t.GetConversationInfoListV2({conversations:[{conversationId:e.id,conversationShortId:r.fromString(e.shortId),conversationType:e.type}],inboxType:e.inboxType});if(0===n.conversation_info_list.length)throw new a.a({type:s.d.ConversationNotExistError,msg:`local conversation: ${e.id} not found online`,sender:this,args:{conversationId:e.id}});const i=d.a.fromServerConversation(n.conversation_info_list[0]);return this.upsert(i)}))}get(e){const t=this.getRaw(e);if(!t)throw new a.a({msg:`conversation ${e} not exist in local`,type:s.d.ConversationNotExistError,sender:this,args:{conversationId:e}});return t}getWithShortIdRaw(e){for(const t of this.conversations.values())if(t.shortId===e)return t;return null}getWithOnline(e,t,n){return g(this,void 0,void 0,(function*(){let r=this.getRaw(e);if(!r||r.isOffline){if(t&&n)return r=this.getWithCreateLocal(e,t,n),n===i.a.ConversationType.BROADCAST_CHAT?yield this.upsertOnlineBroadcast(r):yield this.upsertOnline(r),this.get(e);throw new a.a({type:s.d.InvalidParam,msg:"no shortId and type provided",sender:this})}return r}))}getRaw(e){return this.conversations.get(e)}getConversationArray(e=v.conversationFilter){return Array.from(this.conversations.values()).filter(e).sort(v.conversationComparator())}withConversation(e){return t=>t(this.get(e))}delete(e,t=!1){var n;const r=this.getRaw(e);r&&(t||f.a.Instance.clearConversation(e),this.conversations.delete(e),null===(n=o.a.Instance.dbProxy)||void 0===n||n.deleteConversation(r),c.a.Instance.emitEmpty(s.g.ConversationChange,this),c.a.Instance.emit(s.g.ConversationDelete,this,r))}markRead(e,t){const n=this.get(e);return n.readIndex=t,this.upsert(n)}refreshTicket(e){var t;return g(this,void 0,void 0,(function*(){const n=this.get(e),s=yield null===(t=o.a.Instance.api)||void 0===t?void 0:t.GetTicket({conversationType:n.type,shortId:r.fromString(n.shortId),toId:r.fromString(n.type===i.a.ConversationType.ONE_TO_ONE_CHAT?n.toParticipantUserId:n.shortId)});n.ticket=null===s||void 0===s?void 0:s.ticket,this.upsert(n),u.a.Instance.debug("refresh ticket for conv:",n)}))}static conversationComparator(){return(e,t)=>t.rankScore-e.rankScore}static conversationFilter(e){return 0===e.mode&&e.isMember}dispose(){this.conversations.clear()}}v.Instance=new v},GSkw:function(e,t,n){"use strict";n.d(t,"b",(function(){return a})),n.d(t,"a",(function(){return o}));var r=n("ba9d"),i=n("+ZTy"),s=n("VYFf");class o{}class a{static fromOp(e,t){var n,r;const a=new o;return a.conversationId=e.conversationId,a.messageId=e.clientId,a.key=t.key,a.userId=i.a.Instance.userId,a.secUid=null===(n=i.a.Instance.option)||void 0===n?void 0:n.secUid,a.createTime=new Date(Date.now()),a.idempotentId=t.idempotentId,a.value=null!==(r=t.value)&&void 0!==r?r:"",a.version=e.version,a.status=s.b.Sending,a}static mergeOperationToCurrent(e,t){var n,i;const s={};for(const r of t)(null!==(n=s[r.key])&&void 0!==n?n:s[r.key]=[]).push(r);for(const o of Object.keys(s))for(const t of s[o]){e.property[o]||(e.property[o]=[]);const n=null===(i=e.property[o])||void 0===i?void 0:i.findIndex(e=>e.idempotentId===t.idempotentId);switch(t.operation){case r.a.OPERATION_TYPE.ADD_PROPERTY_ITEM:-1===n&&e.property[o].push(a.fromOp(e,t));break;case r.a.OPERATION_TYPE.REMOVE_PROPERTY_ITEM:-1!==n&&e.property[o].splice(n,1),0===e.property[o].length&&delete e.property[o];break;case r.a.OPERATION_TYPE.SET_PROPERTY:e.property[o]=[a.fromOp(e,t)];break;case r.a.OPERATION_TYPE.DEL_PROPERTY:delete e.property[o]}}}static mergeProperty(e,t){var n;const r={};if(void 0===t)return null!==e&&void 0!==e?e:{};if(void 0===e)return null!==t&&void 0!==t?t:{};for(const i of Object.keys(t))void 0!==e[i]&&(r[i]=null!==(n=t[i])&&void 0!==n?n:[]);for(const i of Object.keys(e))if(void 0===r[i])r[i]=e[i];else for(const t of e[i]){const e=r[i].findIndex(e=>e.idempotentId===t.idempotentId);-1!==e?r[i][e]=t:r[i].push(t)}return r}}},Hd7d:function(e,t,n){"use strict";n.d(t,"a",(function(){return w}));var r,i=n("VXtF"),s=n("+ZTy"),o=n("39GT"),a=n("YnhK"),c=n("VYFf"),u=n("Fjbr"),d=n("7af5"),h=n("z1lN");!function(e){e[e.MARK_CONVERSATION_AS_READ=1]="MARK_CONVERSATION_AS_READ",e[e.DELETE_MESSAGE_IN_CONVERSATION=2]="DELETE_MESSAGE_IN_CONVERSATION",e[e.DELETE_CONVERSATION=3]="DELETE_CONVERSATION",e[e.CONVERSATION_INFO_UPDATED=4]="CONVERSATION_INFO_UPDATED",e[e.CONVERSATION_INFO_BECOME_PER_USER=5]="CONVERSATION_INFO_BECOME_PER_USER",e[e.GROUP_INFO_UPDATED=6]="GROUP_INFO_UPDATED",e[e.PARTICIPANT_UPDATED=7]="PARTICIPANT_UPDATED",e[e.FIRST_MESSAGE=8]="FIRST_MESSAGE",e[e.CLEAR_MESSAGE=9]="CLEAR_MESSAGE"}(r||(r={}));class l extends c.a{static fromMessage(e){const t=e;return t.contentObj=h.parse(e.content),t}}var f=n("4tOJ"),g=n("1277"),v=function(e,t,n,r){return new(n||(n=Promise))((function(i,s){function o(e){try{c(r.next(e))}catch(t){s(t)}}function a(e){try{c(r.throw(e))}catch(t){s(t)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))};class p extends f.a{process(e){return v(this,void 0,void 0,(function*(){return e.data.isCommandMsg&&(e.needContinue=!1,d.a.Instance.debug("receive cmd: ",e.data),yield this.parseCommand(e.data)),e}))}parseCommand(e){return v(this,void 0,void 0,(function*(){const t=l.fromMessage(e);switch(t.contentObj.command_type){case r.DELETE_CONVERSATION:this.handleDeleteConversationCMD(t);break;case r.DELETE_MESSAGE_IN_CONVERSATION:this.handleDeleteMessageCMD(t);break;case r.MARK_CONVERSATION_AS_READ:this.handleMarkConversationRead(t);break;case r.CONVERSATION_INFO_UPDATED:case r.GROUP_INFO_UPDATED:yield this.handleUpdateConversation(t);break;case r.PARTICIPANT_UPDATED:a.a.Instance.emit(i.g.ParticipantUpdate,this,t),yield this.handleUpdateConversation(t)}}))}handleDeleteConversationCMD(e){const{conversation_id:t}=e.contentObj;u.a.Instance.delete(t)}handleDeleteMessageCMD(e){const{conversation_id:t,message_id:n}=e.contentObj;w.Instance.delete(t,n.toString())}handleMarkConversationRead(e){const{conversation_id:t,read_index:n}=e.contentObj;s.a.Instance.initResult!==i.i.Start?u.a.Instance.markRead(t,g.fromValue(n)):d.a.Instance.debug("ignore cmd markRead:",e)}handleUpdateConversation(e){return v(this,void 0,void 0,(function*(){if(s.a.Instance.initResult===i.i.Start)return void d.a.Instance.debug("ignore cmd update:",e);const t=u.a.Instance.getWithCreateLocal(e.conversationId,e.conversationShortId.toString(),e.conversationType);yield u.a.Instance.upsertOnline(t)}))}}var m=n("ba9d"),I=function(e,t,n,r){return new(n||(n=Promise))((function(i,s){function o(e){try{c(r.next(e))}catch(t){s(t)}}function a(e){try{c(r.throw(e))}catch(t){s(t)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))};class y extends f.a{process(e){return I(this,void 0,void 0,(function*(){const t=e.data.conversationId;if(!t)throw new o.a({type:i.d.ConversationNotExistError,msg:"no conversation id is provided in message",sender:this,args:{item:e}});const n=u.a.Instance.getRaw(t);if(e.data.type===m.a.MessageType.MESSAGE_TYPE_CONVERSATION_DESTROY&&n)return u.a.Instance.delete(t),a.a.Instance.emit(i.g.ConversationDissolve,this,n),a.a.Instance.emitEmpty(i.g.ConversationChange,this),e.needContinue=!1,e;if(!e.data.isNormalMsg&&void 0===n)return e.needContinue=!1,d.a.Instance.debug(`ignore process, conv: ${e.data.conversationId} not exist for cmd msg`,e.data),e;const r=e.data,s=u.a.Instance.getWithCreateLocal(r.conversationId,r.conversationShortId,r.conversationType);return e.conv=s,e}))}}var C=function(e,t,n,r){return new(n||(n=Promise))((function(i,s){function o(e){try{c(r.next(e))}catch(t){s(t)}}function a(e){try{c(r.throw(e))}catch(t){s(t)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))};class S extends f.a{process(e){var t;return C(this,void 0,void 0,(function*(){if(!e.data.isNormalMsg)return e;const n=w.Instance.getRaw(null===(t=e.conv)||void 0===t?void 0:t.id,e.data.clientId),r=e.data.ext[i.h.MessageSource]&&(e.data.ext[i.h.MessageSource]===i.j.Online.toString()||e.data.ext[i.h.MessageSource]===i.j.UserInbox.toString()),o=void 0!==(null===n||void 0===n?void 0:n.flightStatus)&&r;w.Instance.upsert(e.data);const c=w.Instance.getRaw(e.data.conversationId,e.data.clientId);return n?o&&c.flightStatus!==i.f.Received&&(c.flightStatus=i.f.Received,a.a.Instance.emit(i.g.ReceiveSelfMessage,this,c),w.Instance.upsert(c)):r&&!e.data.isStrangerMessage&&(e.data.sender!==s.a.Instance.userId?a.a.Instance.emit(i.g.ReceiveNewMessage,this,c):a.a.Instance.emit(i.g.ReceiveSelfMessage,this,c)),e}))}}var b=function(e,t,n,r){return new(n||(n=Promise))((function(i,s){function o(e){try{c(r.next(e))}catch(t){s(t)}}function a(e){try{c(r.throw(e))}catch(t){s(t)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))};class E extends f.a{process(e){return b(this,void 0,void 0,(function*(){return e.data.type===m.a.MessageType.MESSAGE_TYPE_UPDATE_MESSAGE_EXT&&(e.needContinue=!1,this.handleUpdateExt(e)),e}))}handleUpdateExt(e){var t,n;const r=null===(t=e.data)||void 0===t?void 0:t.ext[i.h.ServerMessageId];if(!r)throw new o.a({type:i.d.InvalidServerId,msg:`message ${e.data} has no s:server_message_id`,sender:this});const s=w.Instance.getByServerIdRaw(null===(n=e.conv)||void 0===n?void 0:n.id,r);s&&(s.version.gt(e.data.version)?d.a.Instance.warn(`local msg version: ${s.version.toString()} > online msg version: ${e.data.version.toString()}, ignore`):(s.ext=e.data.ext,s.version=e.data.version,w.Instance.upsert(s),a.a.Instance.emit(i.g.ReceiveNewUpdateExtMessage,this,e.data),"true"===e.data.ext[i.h.IsRecalled]&&a.a.Instance.emit(i.g.MessageRecall,this,s)))}}var _=n("EbSe"),x=function(e,t,n,r){return new(n||(n=Promise))((function(i,s){function o(e){try{c(r.next(e))}catch(t){s(t)}}function a(e){try{c(r.throw(e))}catch(t){s(t)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))};class w{constructor(){this.processors=[new y,new p,new E,new S],this.messages=new Map}applyLocal(e){e.forEach(e=>{this.upsert(e)})}get(e,t){const n=this.getRaw(e,t);if(!n)throw new o.a({type:i.d.MessageNotExistError,msg:`message ${t} @ ${e} not exist in local`,sender:this});return n}getRaw(e,t){return this.getConversationMap(e).get(t)}getByServerIdRaw(e,t){const n=this.getConversationMap(e),r=Array.from(n.values()).filter(e=>e.serverId===t);return 0===r.length?null:this.get(e,r[0].clientId)}getByServerId(e,t){const n=this.getConversationMap(e),r=Array.from(n.values()).filter(e=>e.serverId===t);if(0===r.length)throw new o.a({type:i.d.MessageNotExistError,msg:`message ${t} @ ${e} not exist in local`,sender:this});return this.get(e,r[0].clientId)}getList(e){const t=this.getConversationMap(e);return Array.from(t.values()).sort(w.messageComparator)}upsert(e){var t;const n=this.getConversationMap(e.conversationId),r=n.get(e.clientId);if(r&&r.type===e.type?e=r.merge(e):r&&r.type!==e.type&&d.a.Instance.warn("try to merge different msg:",r,e),n.set(e.clientId,e),null===(t=s.a.Instance.dbProxy)||void 0===t||t.upsertMessage(e),a.a.Instance.emit(i.g.MessageUpsert,this,e),s.a.Instance.initResult!==i.i.Start){a.a.Instance.emitEmpty(i.g.ConversationChange,this);const t=u.a.Instance.getRaw(e.conversationId);a.a.Instance.emit(i.g.ConversationUpsert,this,t),void 0!==r&&(null===t||void 0===t||t.forceRefreshUnreadCount())}}getConversationMap(e){let t=this.messages.get(e);return t||(t=new Map,this.messages.set(e,t)),t}processNewMessage(e,t){return x(this,void 0,void 0,(function*(){const n=_.a.performanceNow();if(e.ext||(e.ext={}),e.ext[i.h.MessageSource]=t.toString(),e.type>=0){const t=yield this.processMessage(e);return _.a.Instance.emitDuration(_.b.BizProcessMessage,n),t}throw new o.a({type:i.d.UnknownMessageType,msg:`unknown message type: ${e.type} for msg:${e}`,sender:this})}))}processNewMessagesFromPull(e,t){return x(this,void 0,void 0,(function*(){const n=e.map(e=>c.a.fromServerMessage(e));for(const e of n)e.ext||(e.ext={}),yield this.processNewMessage(e,t);return n}))}delete(e,t){var n;const r=this.getConversationMap(e),o=Array.from(r.values()).filter(e=>e.serverId===t);if(0===o.length)return void d.a.Instance.debug(`delete not exist msg: ${e}::${t}`);r.delete(o[0].clientId),null===(n=s.a.Instance.dbProxy)||void 0===n||n.deleteMessage(o[0]);const c=u.a.Instance.get(e);a.a.Instance.emitEmpty(i.g.ConversationChange,this),a.a.Instance.emit(i.g.ConversationUpsert,this,c),a.a.Instance.emit(i.g.MessageUpsert,this,o[0]),a.a.Instance.emit(i.g.MessageDelete,this,o[0])}markRecalled(e,t){const n=this.getByServerId(e,t);n.ext||(n.ext={}),n.ext[i.h.IsRecalled]="true",this.upsert(n);const r=u.a.Instance.get(e);a.a.Instance.emitEmpty(i.g.ConversationChange,this),a.a.Instance.emit(i.g.ConversationUpsert,this,r),a.a.Instance.emit(i.g.MessageUpsert,this,n),a.a.Instance.emit(i.g.MessageRecall,this,n)}clearConversation(e){var t;const n=u.a.Instance.get(e);this.messages.set(e,new Map),null===(t=s.a.Instance.dbProxy)||void 0===t||t.clearConversation(n),a.a.Instance.emitEmpty(i.g.ConversationChange,this),a.a.Instance.emit(i.g.ConversationUpsert,this,n)}injectProcessor(e){this.processors.push(e)}processMessage(e){return x(this,void 0,void 0,(function*(){let t={needContinue:!0,data:e};for(const e of this.processors)if(t=yield e.process(t),!t.needContinue)break;return t.data}))}dispose(){this.messages.clear(),this.processors=[]}}w.Instance=new w,w.messageComparator=(e,t)=>e.orderInConversation.gt(t.orderInConversation)?1:-1},Lmh7:function(e,t,n){"use strict";n.d(t,"a",(function(){return r}));const r={version:"0.0.39",branch:"master",commit:"b830084"}},UMnf:function(e,t,n){"use strict";n.d(t,"b",(function(){return r})),n.d(t,"a",(function(){return i}));class r{constructor(e,t,n){this.index=e,this.subject=t,this.handler=n}unsubscribe(){this.subject.unsubscribe(this)}}class i{constructor(){this.subscriptions=new Map,this.idx=0}subscribe(e){const t=this.subscriptions.values();for(const r of t)if(e===r.handler)return r;const n=new r(this.idx,this,e);return this.subscriptions.set(this.idx,n),this.idx++,n}nextEmpty(e){setTimeout(()=>{for(const t of this.subscriptions.values())t&&t.handler&&t.handler({},e)},0)}next(e,t){setTimeout(()=>{for(const n of this.subscriptions.values())n&&n.handler&&n.handler(e,t)},0)}unsubscribe(e){e&&this.subscriptions.delete(e.index)}unsubscribeAll(){this.subscriptions.clear()}}},VXtF:function(e,t,n){"use strict";n.d(t,"l",(function(){return s})),n.d(t,"q",(function(){return o})),n.d(t,"h",(function(){return a})),n.d(t,"n",(function(){return c})),n.d(t,"b",(function(){return u})),n.d(t,"a",(function(){return d})),n.d(t,"p",(function(){return h})),n.d(t,"k",(function(){return l})),n.d(t,"e",(function(){return f})),n.d(t,"i",(function(){return g})),n.d(t,"j",(function(){return v})),n.d(t,"g",(function(){return p})),n.d(t,"d",(function(){return m})),n.d(t,"f",(function(){return I})),n.d(t,"o",(function(){return y})),n.d(t,"m",(function(){return C})),n.d(t,"c",(function(){return S}));var r=n("ba9d"),i=n("Lmh7");const s={sdkVersion:i.a.version,refer:r.a.Refer.PC,buildNumber:`${i.a.branch}:${i.a.commit}`,wsProtocols:["binary","base64","pbbp2"],ticketType:r.a.TicketType.TICKET_TYPE_WEB,envKey:"X-Tt-Env",boeHeaderKey:"X-Use-Boe",ppeHeaderKey:"X-Use-Ppe"};var o,a,c,u,d,h,l,f,g,v,p,m,I;!function(e){e[e.Default=0]="Default",e[e.PushOnly=1]="PushOnly",e[e.All=2]="All",e[e.Disable=3]="Disable"}(o||(o={})),function(e){e.MessageMode="s:mode",e.SendResponseStatus="s:send_response_status",e.SendResponseExtraInfo="s:send_response_extra_info",e.SendResponseCheckCode="s:send_response_check_code",e.SendResponseCheckMessage="s:send_response_check_msg",e.ClientMessageId="s:client_message_id",e.MentionedUser="s:mentioned_users",e.DoNotIncreaseUnread="s:do_not_increase_unread",e.DoNotPopConversation="s:do_not_pop_conversation",e.IsRecalled="s:is_recalled",e.ServerMessageId="s:server_message_id",e.MessageSource="s:message_source",e.MessageLogid="s:message_logid",e.MessageStartTimestamp="s:message_start_timestamp",e.MessageVisible="s:visible",e.MessageInvisible="s:invisible",e.MessageOffline="s:message_offline",e.RelationIsMuted="s:relation_is_muted",e.RelationNormalOnly="s:relation_normal_only",e.RelationMuteTime="s:relation_mute_time",e.RelationMuteExt="s:relation_mute_ext",e.MessageSourceAppId="s:biz_aid",e.ConversationSourceAppId="s:s_aid"}(a||(a={})),function(e){e[e.Enable=0]="Enable",e[e.Disable=1]="Disable"}(c||(c={})),function(e){e[e.SingleChat=1]="SingleChat",e[e.GroupChat=2]="GroupChat",e[e.LiveChat=3]="LiveChat"}(u||(u={})),function(e){e[e.Normal=0]="Normal",e[e.Dissolved=1]="Dissolved"}(d||(d={})),function(e){e[e.Off=0]="Off",e[e.On=1]="On"}(h||(h={})),function(e){e[e.Off=0]="Off",e[e.On=1]="On"}(l||(l={})),function(e){e[e.Off=0]="Off",e[e.On=1]="On"}(f||(f={})),function(e){e[e.NotAvailable=0]="NotAvailable",e[e.Start=1]="Start",e[e.Error=2]="Error",e[e.Succeeded=3]="Succeeded"}(g||(g={})),function(e){e[e.Online=0]="Online",e[e.LoadMore=1]="LoadMore",e[e.Init=2]="Init",e[e.UserInbox=3]="UserInbox",e[e.Offline=4]="Offline"}(v||(v={})),function(e){e.Error="error",e.WebSocketConnected="websocket-connected",e.WebSocketDisconnected="websocket-disconnected",e.WebSocketReceiveUnexpectedFrame="websocket-receive-unexpected-frame",e.ReceiveNewMessage="receive-new-message",e.ReceiveSelfMessage="receive-self-message",e.ReceiveBroadcastNewMessage="receive-broadcast-new-message",e.ReceiveNewUpdateExtMessage="receive-new-update-ext-message",e.ReceiveNewP2PMessage="receive-new-p2p-message",e.MessageUpsert="message-upsert",e.ConversationChange="conversation-change",e.ConversationUpsert="conversation-upsert",e.ConversationDissolve="conversation-dissolve",e.ParticipantUpsert="participant-upsert",e.ParticipantUpdate="participant-update",e.ParticipantJoin="participant-join",e.ParticipantLeave="participant-leave",e.MessageSend="message-send",e.MessageRecall="message-recall",e.MessageDelete="message-delete",e.ConversationDelete="conversation-delete",e.ConversationLeave="conversation-leave",e.ConversationCreate="conversation-create",e.ConversationJoin="conversation-join",e.ReceiveNewStrangerMessage="receive-new-stranger-message",e.StrangerUpgrade="stranger-upgrade",e.MessagePropertyUpsert="message-property-upsert",e.InitLoadPage="init-load-page",e.InitFinish="init-finish"}(p||(p={})),function(e){e[e.InvalidInboxType=0]="InvalidInboxType",e[e.InvalidCommand=1]="InvalidCommand",e[e.ConversationNotExistError=2]="ConversationNotExistError",e[e.MessageNotExistError=3]="MessageNotExistError",e[e.MessageOffline=4]="MessageOffline",e[e.UnknownMessageType=5]="UnknownMessageType",e[e.InvalidServerId=6]="InvalidServerId",e[e.MessageNotReady=7]="MessageNotReady",e[e.InvalidParam=8]="InvalidParam",e[e.TokenFuncError=9]="TokenFuncError",e[e.NetworkError=10]="NetworkError",e[e.CheckCodeError=11]="CheckCodeError",e[e.InvalidToken=12]="InvalidToken",e[e.ExpiredToken=13]="ExpiredToken",e[e.InvalidTicket=14]="InvalidTicket",e[e.InvalidRequest=15]="InvalidRequest",e[e.ServerError=16]="ServerError",e[e.UserForbidden=17]="UserForbidden",e[e.InternalError=18]="InternalError",e[e.MessageTargetConversationNotExist=19]="MessageTargetConversationNotExist",e[e.DegradationError=20]="DegradationError",e[e.RecallTimeout=21]="RecallTimeout",e[e.AlreadyDispose=22]="AlreadyDispose",e[e.Unknown=23]="Unknown",e[e.MPInvalidArgument=10001]="MPInvalidArgument",e[e.MPServerUrlError=10002]="MPServerUrlError",e[e.MPNotFileMsg=10003]="MPNotFileMsg",e[e.MPUploadError=10004]="MPUploadError",e[e.MPNotSupportCipher=10005]="MPNotSupportCipher"}(m||(m={})),function(e){e[e.Created=0]="Created",e[e.Preparing=1]="Preparing",e[e.Inflight=2]="Inflight",e[e.Succeeded=3]="Succeeded",e[e.Received=4]="Received",e[e.Failed=-1]="Failed",e[e.Rejected=-2]="Rejected",e[e.SelfVisible=-3]="SelfVisible"}(I||(I={}));const y={[r.a.StatusCode.INVALID_TOKEN]:m.InvalidToken,[r.a.StatusCode.EXPIRED_TOKEN]:m.ExpiredToken,[r.a.StatusCode.INVALID_TICKET]:m.InvalidTicket,[r.a.StatusCode.INVALID_REQUEST]:m.InvalidRequest,[r.a.StatusCode.INVALID_CMD]:m.InvalidCommand,[r.a.StatusCode.SERVER_ERR]:m.ServerError,[r.a.StatusCode.INTERNAL_ERROR]:m.InternalError,[r.a.StatusCode.MESSAGE_TARGET_CONVERSATION_NOT_EXIST]:m.MessageTargetConversationNotExist,[r.a.StatusCode.DEGRADATION_ERROR]:m.DegradationError,[r.a.StatusCode.RECALL_TIMEOUT]:m.RecallTimeout};var C,S;!function(e){e[e.Succeeded=0]="Succeeded",e[e.UserNotInConversation=1]="UserNotInConversation",e[e.CheckConversationNotPass=2]="CheckConversationNotPass",e[e.CheckMessageNotPass=3]="CheckMessageNotPass",e[e.CheckMessageNotPassButSelfVisible=4]="CheckMessageNotPassButSelfVisible",e[e.UserHasBeenBlock=5]="UserHasBeenBlock"}(C||(C={})),function(e){e[e.Succeeded=0]="Succeeded",e[e.Rejected=1]="Rejected",e[e.PartialRejected=2]="PartialRejected"}(S||(S={}))},VYFf:function(e,t,n){"use strict";n.d(t,"b",(function(){return r})),n.d(t,"a",(function(){return u}));var r,i=n("1277"),s=n("GSkw"),o=n("VXtF"),a=n("+ZTy"),c=n("7af5");!function(e){e[e.Sending=0]="Sending",e[e.Success=1]="Success",e[e.Failed=2]="Failed"}(r||(r={}));class u{constructor(){this.property={}}get clientId(){return this.ext?this.ext[o.h.ClientMessageId]:""}set clientId(e){this.ext||(this.ext={}),this.ext[o.h.ClientMessageId]=e}static createClientMessage(e){var t;const n=new u;n.conversationId=e.conversationId,n.type=e.type,n.conversationType=e.conversationType,n.conversationShortId=e.conversationShortId,n.sender=a.a.Instance.userId,n.content=e.content,n.createdAt=new Date(Date.now());const r=Object.assign({},e.ext);for(const i of Object.keys(r))i.startsWith("s:")&&(c.a.Instance.debug(`delete s: prefix ext key: '${i}: ${r[i]}'`),delete r[i]);return n.ext=r,n.clientId=e.id,n.version=i.ZERO,n.serverStatus=o.n.Enable,n.isOffline=!0,(null===(t=a.a.Instance.option)||void 0===t?void 0:t.secUid)&&(n.secSender=a.a.Instance.option.secUid),n}static fromServerMessage(e){const t=new u;return t.serverId=e.server_message_id.toString(),t.type=e.message_type,t.ext=e.ext,t.conversationId=e.conversation_id,t.content=e.content,t.sender=e.sender.toString(),t.createdAt=new Date(e.create_time.toNumber()),t.indexInConversation=e.index_in_conversation,t.orderInConversation=e.order_in_conversation,t.serverStatus=e.status,t.conversationShortId=e.conversation_short_id.toString(),t.conversationType=e.conversation_type,t.version=e.version,t.secSender=e.sec_sender,t.isOffline=!1,t.property=u.fromServerProperty(e),t}static fromServerProperty(e){const t={};if(!e.property_list)return t;for(const n of Object.keys(e.property_list)){const i=e.property_list[n];i&&i.Items&&(t[n]=i.Items.map(t=>{var i,s,a,c,u;return{messageId:null!==(i=e.ext[o.h.ClientMessageId])&&void 0!==i?i:"",conversationId:e.conversation_id,key:n,userId:null===(s=t.uid)||void 0===s?void 0:s.toString(),secUid:null!==(a=t.sec_uid)&&void 0!==a?a:"",createTime:new Date(1e3*(null!==(u=null===(c=t.create_time)||void 0===c?void 0:c.toNumber())&&void 0!==u?u:0)),idempotentId:t.idempotent_id,value:t.value,version:e.version,status:r.Success}}))}return t}merge(e){return e&&this.type===e.type&&(e.ext=Object.assign(this.ext||{},e.ext),""===e.content&&this.content&&(c.a.Instance.debug("ignore empty content replace:",e),e.content=this.content),e.property=s.b.mergeProperty(e.property,this.property),Object.assign(this,e)),this}get isNormalMsg(){return this.type<5e4}get isCommandMsg(){return 50001===this.type}get isSpecialMessage(){return this.type>=5e4}get visible(){return this.serverStatus!==o.n.Disable&&(!this.isSpecialMessage&&(!a.a.Instance.userId||!this.ext||(this.ext[o.h.MessageVisible]&&this.ext[o.h.MessageVisible].length>0?-1!==this.ext[o.h.MessageVisible].split(",").indexOf(a.a.Instance.userId):!(this.ext[o.h.MessageInvisible]&&this.ext[o.h.MessageInvisible].length>0)||-1===this.ext[o.h.MessageInvisible].split(",").indexOf(a.a.Instance.userId))))}get unpop(){return!!this.ext&&!!(this.ext[o.h.DoNotPopConversation]&&"true"===this.ext[o.h.DoNotPopConversation]||"1"===this.ext[o.h.DoNotPopConversation])}get increaseUnread(){return!this.isSpecialMessage&&(!this.ext||!(this.ext[o.h.DoNotIncreaseUnread]&&"true"===this.ext[o.h.DoNotIncreaseUnread]||"1"===this.ext[o.h.DoNotIncreaseUnread]))}get isFromMe(){return this.sender===a.a.Instance.userId}get isRecalled(){return this.ext&&!!this.ext[o.h.IsRecalled]}get isMentioned(){return this.mentionedUsers.includes(a.a.Instance.userId)||this.mentionedUsers.includes("0")}get mentionedUsers(){return this.ext&&this.ext[o.h.MentionedUser]?this.ext[o.h.MentionedUser].split(","):[]}set mentionedUsers(e){this.ext||(this.ext={}),this.ext[o.h.MentionedUser]=e.join(",")}get isOffline(){return!!this.ext&&"true"===this.ext[o.h.MessageOffline]}set isOffline(e){this.ext||(this.ext={}),this.ext[o.h.MessageOffline]=e?"true":"false"}get isStrangerMessage(){return!this.ext||["1","2","3"].includes(this.ext[o.h.MessageMode])}}},"Wy+L":function(e,t,n){!function(e){"use strict";var t=Object.prototype.hasOwnProperty,n=function(e){for(var n,r=0;r<(arguments.length<=1?0:arguments.length-1);r++)if((n=r+1<1||arguments.length<=r+1?void 0:arguments[r+1])&&"object"==typeof n)for(var i in n)t.call(n,i)&&(e[i]=n[i]);return e},r=function(e){var t=e.length;if(!t)return[];if(1===t)return[e[0]];if(2===t)return[e[0],e[1]];if(3===t)return[e[0],e[1],e[2]];for(var n=new Array(t),r=0;r<t;r++)n[r]=e[r];return n},i=function(e,t){var n="function"==typeof t?t:function(e){return function(t,n){if(t.length!==n.length)return!1;for(var r=0,i=t.length;r<i;r++)if(!e(t[r],n[r]))return!1;return!0}}(e);return function(e,t){for(var r=0;r<e.length;r++)if(n(e[r],t))return r;return-1}},s=function(e,t){return e===t||e!=e&&t!=t},o=function(e,t,n){},a=function(e,t,n){for(var r=n;r--;)e[r+1]=e[r];e[0]=t};function c(e,t){if(e.isMemoized)return e;var c=t||{},u=c.isEqual,d=void 0===u?s:u,h=c.isMatchingKey,l=c.isPromise,f=void 0!==l&&l,g=c.maxSize,v=void 0===g?1:g,p=c.onCacheAdd,m=void 0===p?o:p,I=c.onCacheChange,y=void 0===I?o:I,C=c.onCacheHit,S=void 0===C?o:C,b=c.transformKey,E=function(e,t){if(null==e)return{};var n,r,i={},s=Object.keys(e);for(r=0;r<s.length;r++)n=s[r],0<=t.indexOf(n)||(i[n]=e[n]);return i}(c,["isEqual","isMatchingKey","isPromise","maxSize","onCacheAdd","onCacheChange","onCacheHit","transformKey"]),_=n({},E,{isEqual:d,isMatchingKey:h,isPromise:f,maxSize:v,onCacheAdd:m,onCacheChange:y,onCacheHit:S,transformKey:b}),x=i(d,h),w=function(e){var t=i(e.isEqual,e.isMatchingKey);return function(n,r){var i=n.keys[0];n.values[0]=n.values[0].then((function(t){return e.onCacheHit(n,e,r),e.onCacheChange(n,e,r),t})).catch((function(e){var r=t(n.keys,i);throw~r&&(n.keys.splice(r,1),n.values.splice(r,1)),e}))}}(_),M=!(!b&&!h),R={keys:[],get size(){return R.keys.length},values:[]},O=R.keys,T=R.values;function N(){var t=arguments,n=M?r(t):t,i=b?b(n):n,s=x(O,i);if(~s)S(R,_,N),s&&(a(O,O[s],s),a(T,T[s],s),y(R,_,N));else{O.length>=v&&(O.pop(),T.pop());var o=M?i:r(n),c=e.apply(this,t);a(O,o,O.length),a(T,c,T.length),f&&w(R,N),m(R,_,N),y(R,_,N)}return T[0]}return Object.defineProperties(N,{cache:{configurable:!0,get:function(){return R}},cacheSnapshot:{configurable:!0,get:function(){return{keys:r(R.keys),size:R.size,values:r(R.values)}}},isMemoized:{configurable:!0,get:function(){return!0}},options:{configurable:!0,get:function(){return _}}}),N}function u(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];if(t.length)return t.reduce((function(e,t){return"function"==typeof e?"function"==typeof t?function(){return e(t.apply(this,arguments))}:e:"function"==typeof t?t:void 0}))}function d(e,t){for(var n=0;n<e.length;n++)if(e[n].key===t)return n;return-1}function h(e,t){var n="function"==typeof t?t:function(t,n){for(var r=0;r<n.length;r++)if(!e(t[r],n[r]))return!1;return!0};return function(e,t){for(var r=0;r<e.length;r++)if(e[r].length===t.length&&n(e[r],t))return r;return-1}}function l(e){return Array.isArray(e)?e:[e]}function f(e,t,n){var r=d(e,t);~r&&(clearTimeout(e[r].timeoutId),n&&e.splice(r,1))}function g(e,t){var n=setTimeout(e,t);return"function"==typeof n.unref&&n.unref(),n}function v(){D.isCollectingStats=!0}function p(e,t){return e?(t/e*100).toFixed(4)+"%":"0%"}function m(e){if(D.isCollectingStats||U||(U=!0),e){if(!D.profiles[e])return{calls:0,hits:0,usage:"0%"};var t=D.profiles[e];return Object.assign({},t,{usage:p(t.calls,t.hits)})}var n=Object.keys(D.profiles).reduce((function(e,t){return e.calls+=D.profiles[t].calls,e.hits+=D.profiles[t].hits,e}),{calls:0,hits:0});return Object.assign({},n,{profiles:Object.keys(D.profiles).reduce((function(e,t){return e[t]=m(t),e}),{}),usage:p(n.calls,n.hits)})}function I(e,t){return e&&"object"==typeof e&&t.add(e)}function y(e,t,n,r){for(var i,s=0;s<e.length;s++)if(n((i=e[s])[0],t[0],r)&&n(i[1],t[1],r))return!0;return!1}function C(e,t,n,r){for(var i=0;i<e.length;i++)if(n(e[i],t,r))return!0;return!1}function S(e,t){return e===t||e!=e&&t!=t}function b(e){return e.constructor===Object}function E(e){return"function"==typeof e.then}function _(e){return!(!e.$$typeof||!e._store)}function x(e){return function(t){var n=e||t;return function(e,t,r){void 0===r&&(r=B?new WeakSet:Object.create({_values:[],add:function(e){this._values.push(e)},has:function(e){return!!~this._values.indexOf(e)}}));var i=r.has(e),s=r.has(t);return i||s?i&&s:(I(e,r),I(t,r),n(e,t,r))}}}function w(e){var t=[];return e.forEach((function(e,n){return t.push([n,e])})),t}function M(e){var t=[];return e.forEach((function(e){return t.push(e)})),t}function R(e,t,n,r){var i,s=V(e),o=V(t);if(s.length!==o.length)return!1;for(var a=0;a<s.length;a++){if(!C(o,i=s[a],S))return!1;if(("_owner"!==i||!_(e)||!_(t))&&!n(e[i],t[i],r))return!1}return!0}function O(e){var t="function"==typeof e?e(n):n;function n(e,n,r){if(S(e,n))return!0;var i=typeof e;if(i!=typeof n||"object"!=i||!e||!n)return!1;if(b(e)&&b(n))return R(e,n,t,r);var s=G(e),o=G(n);if(s||o)return s===o&&function(e,t,n,r){if(e.length!==t.length)return!1;for(var i=0;i<e.length;i++)if(!n(e[i],t[i],r))return!1;return!0}(e,n,t,r);var a=e instanceof Date,c=n instanceof Date;if(a||c)return a==c&&S(e.getTime(),n.getTime());var u=e instanceof RegExp,d=n instanceof RegExp;if(u||d)return u==d&&function(e,t){return e.source===t.source&&e.global===t.global&&e.ignoreCase===t.ignoreCase&&e.multiline===t.multiline&&e.unicode===t.unicode&&e.sticky===t.sticky&&e.lastIndex===t.lastIndex}(e,n);if(E(e)||E(n))return e===n;if(F){var h=e instanceof Map,l=n instanceof Map;if(h||l)return h==l&&function(e,t,n,r){if(e.size!==t.size)return!1;for(var i=w(e),s=w(t),o=0;o<i.length;o++)if(!y(s,i[o],n,r)||!y(i,s[o],n,r))return!1;return!0}(e,n,t,r)}if(q){var f=e instanceof Set,g=n instanceof Set;if(f||g)return f==g&&function(e,t,n,r){if(e.size!==t.size)return!1;for(var i=M(e),s=M(t),o=0;o<i.length;o++)if(!C(s,i[o],n,r)||!C(i,s[o],n,r))return!1;return!0}(e,n,t,r)}return R(e,n,t,r)}return n}function T(e){return function(t){if(e>=t.length)return t;switch(e){case 0:return[];case 1:return[t[0]];case 2:return[t[0],t[1]];case 3:return[t[0],t[1],t[2]];case 4:return[t[0],t[1],t[2],t[3]];case 5:return[t[0],t[1],t[2],t[3],t[4]]}return Array.prototype.slice.call(t,0,e)}}var N={equals:void 0,isDeepEqual:!1,isPromise:!1,isReact:!1,isSerialized:!1,matchesKey:void 0,maxAge:void 0,maxArgs:void 0,maxSize:1/0,onExpire:void 0,profileName:void 0,serializer:void 0,shouldSerializeFunctions:!1,transformArgs:void 0,updateExpire:!1},k=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];if(t.length)return t.reduce((function(e,t){return"function"==typeof e?"function"==typeof t?function(){t.apply(this,arguments),e.apply(this,arguments)}:e:"function"==typeof t?t:void 0}))},A=function(e,t){return t===N?e:Object.assign({},e,t,{onCacheAdd:k(e.onCacheAdd,t.onCacheAdd),onCacheChange:k(e.onCacheChange,t.onCacheChange),onCacheHit:k(e.onCacheHit,t.onCacheHit),transformArgs:u(e.transformArgs,t.transformArgs)})},P=function(e,t,n,r){var i=t.maxAge,s=t.updateExpire,o="number"==typeof i&&isFinite(i)?function e(t,n,r,i){var s=n.maxAge,o=n.onCacheChange,a=n.onExpire,c=h(r,i);return function(i,u,h){var l=i.keys[0];if(!~d(t,l)){var v=function(){var s=c(i.keys,l),d=i.values[s];~s&&(i.keys.splice(s,1),i.values.splice(s,1),"function"==typeof o&&o(i,u,h)),f(t,l,!0),"function"==typeof a&&!1===a(l)&&(i.keys.unshift(l),i.values.unshift(d),e(t,n,r)(i,u,h),"function"==typeof o&&o(i,u,h))};t.push({expirationMethod:v,key:l,timeoutId:g(v,s)})}}}(e,t,n,r):void 0;return{onCacheAdd:o,onCacheHit:o&&s?function(e,t){var n=t.maxAge;return function(t){var r=t.keys[0],i=d(e,r);~i&&(f(e,r,!1),e[i].timeoutId=g(e[i].expirationMethod,n))}}(e,t):void 0}},D={anonymousProfileNameCounter:1,isCollectingStats:!1,profiles:{}},U=!1,L=function(e){var t=(new Error).stack,n=e.displayName||e.name||"Anonymous "+D.anonymousProfileNameCounter++;if(!t)return n;for(var r,i,s=t.split("\n").slice(3),o=0;o<s.length;o++)if(!~(r=s[o]).indexOf("/moize/")&&!~r.indexOf(" (native)")&&!~r.indexOf(" Function.")){i=r.replace(/\n/g,"\\n").trim();break}return i?n+" "+i:n},z=function(e){return D.isCollectingStats?{onCacheAdd:function(e){var t=e.profileName;return D.profiles[t]||(D.profiles[t]={calls:0,hits:0}),function(){D.profiles[t].calls++}}(e),onCacheHit:function(e){var t=e.profileName;return function(){D.profiles[t].calls++,D.profiles[t].hits++}}(e)}:{}},j=function(e,t){return function(e,t){var n=t.expirations,r=e.options,i=r.isEqual,s=r.isMatchingKey,o=r.onCacheAdd,c=r.onCacheChange,u=r.transformKey,d=h(i,s);e.add=function(t,n){var r=u?u(t):t;~d(e.cache.keys,r)||(e.cache.size>=e.options.maxSize&&(e.cache.keys.pop(),e.cache.values.pop()),e.cache.keys.unshift(r),e.cache.values.unshift(n),o(e.cache,e.options,e),c(e.cache,e.options,e))},e.clear=function(){e.cache.keys.length=0,e.cache.values.length=0,c(e.cache,e.options,e)},e.get=function(t){var n=d(e.cache.keys,u?u(t):t);return~n?e.apply(this,e.cache.keys[n]):void 0},e.getStats=function(){return m(e.options.profileName)},e.has=function(t){return!!~d(e.cache.keys,u?u(t):t)},e.keys=function(){return e.cacheSnapshot.keys},e.remove=function(t){var r=d(e.cache.keys,u?u(t):t);if(~r){var i=e.cache.keys[r];e.cache.keys.splice(r,1),e.cache.values.splice(r,1),c(e.cache,e.options,e),f(n,i,!0)}},e.update=function(t,n){var r=d(e.cache.keys,u?u(t):t);if(~r){var i=e.cache.keys[r];a(e.cache.keys,i,r),a(e.cache.values,n,r),c(e.cache,e.options,e)}},e.values=function(){return e.cacheSnapshot.values}}(e,t),function(e,t){var n=t.expirations,r=t.options,i=t.originalFunction,s=e.options;Object.defineProperties(e,{_microMemoizeOptions:{configurable:!0,get:function(){return s}},expirations:{configurable:!0,get:function(){return n}},expirationsSnapshot:{configurable:!0,get:function(){return n.slice(0)}},isCollectingStats:{configurable:!0,get:function(){return D.isCollectingStats}},isMoized:{configurable:!0,get:function(){return!0}},options:{configurable:!0,get:function(){return r}},originalFunction:{configurable:!0,get:function(){return i}}}),r.isReact&&(e.contextTypes=i.contextTypes,e.defaultProps=i.defaultProps,e.displayName="Moized("+(i.displayName||i.name||"Component")+")",e.propTypes=i.propTypes)}(e,t),e},F="function"==typeof Map,q="function"==typeof Set,B="function"==typeof WeakSet,V=Object.keys,G=Array.isArray,K=(O(x()),O(x(S)),O()),H=O((function(){return S}));function $(e,t,n){return"[ref-"+n+"]"}var Z=function(e,t){if(e[0]===t)return 0;for(var n=e.length,r=1;r<n;r++)if(e[r]===t)return r;return-1};function Y(e,t){return"function"==typeof t?""+t:t}function W(t,n){try{return JSON.stringify(t,n)}catch(e){return function(e,t,n,r){return JSON.stringify(e,function(e,t){var n=t||$,r="function"==typeof e,i=[];return function(t,s){if("object"==typeof s)if(i.length){var o=Z(i,this)+1;o?i=function(e,t){for(var n=new Array(t),r=0;r<t;r++)n[r]=e[r];return n}(i,o):i[i.length]=this;var a=Z(i,s);if(~a)return n.call(this,t,s,a)}else i[0]=s;return r?e.call(this,t,s):s}}(t,void 0),void 0)}(t,n)}}function X(e,t){return e[0]===t[0]}var J=function(e){if("function"==typeof e)return function(t,n,r){return e(r.cache,r.options,r)}},Q=function(e){var t=e.maxArgs,n=e.isReact,r=e.isSerialized,i=e.transformArgs;return u(r&&function(e){return"function"==typeof e.serializer?u(l,e.serializer):function(e){var t=e.shouldSerializeFunctions?Y:null;return function(e){for(var n,r,i="|",s=0;s<e.length;s++)i+=(r=typeof(n=e[s]),(!n||"object"!=r&&"function"!=r?n:W(n,t))+"|");return[i]}}(e)}(e),"function"==typeof i&&u(l,i),n&&T(2),"number"==typeof t&&T(t))};function ee(e,t){if(void 0===t&&(t=N),e.isMoized)return ee(e.originalFunction,A(e.options,t));if("object"==typeof e)return function(t,n){return void 0===n&&(n={}),"function"==typeof t?ee(t,A(e,n)):ee(A(e,t))};var n=Object.assign({},N,t,{maxArgs:"number"==typeof t.maxArgs&&0<=t.maxArgs?t.maxArgs:N.maxArgs,maxSize:"number"==typeof t.maxSize&&0<=t.maxSize?t.maxSize:N.maxSize,profileName:t.profileName||L(e)}),r=[],i=(n.equals,n.isDeepEqual,n.isPromise),s=(n.isReact,n.isSerialized,n.matchesKey,n.maxAge,n.maxArgs,n.maxSize),o=n.onCacheAdd,a=n.onCacheChange,u=n.onCacheHit,d=(n.onExpire,n.profileName,n.shouldSerializeFunctions,n.serializer,n.transformArgs,n.updateExpire,function(e,t){if(null==e)return{};var n,r,i={},s=Object.keys(e);for(r=0;r<s.length;r++)n=s[r],0<=t.indexOf(n)||(i[n]=e[n]);return i}(n,["equals","isDeepEqual","isPromise","isReact","isSerialized","matchesKey","maxAge","maxArgs","maxSize","onCacheAdd","onCacheChange","onCacheHit","onExpire","profileName","shouldSerializeFunctions","serializer","transformArgs","updateExpire"])),h=function(e){var t=e.equals,n=e.isDeepEqual,r=e.isReact;return t||n&&K||r&&H||S}(n),l=function(e){var t=e.isSerialized;return e.matchesKey||t&&X||void 0}(n),f=P(r,n,h,l),g=z(n),v=Q(n),p=Object.assign({},d,{isEqual:h,isMatchingKey:l,isPromise:i,maxSize:s,onCacheAdd:J(k(o,f.onCacheAdd,g.onCacheAdd)),onCacheChange:J(a),onCacheHit:J(k(u,f.onCacheHit,g.onCacheHit)),transformKey:v});return j(c(e,p),{expirations:r,options:n,originalFunction:e})}ee.collectStats=v,ee.compose=function(){return u.apply(null,arguments)||ee},ee.deep=ee({isDeepEqual:!0}),ee.getStats=m,ee.isCollectingStats=function(){return D.isCollectingStats},ee.isMoized=function(e){return"function"==typeof e&&!!e.isMoized},ee.maxAge=function(e){return ee({maxAge:e})},ee.maxArgs=function(e){return ee({maxArgs:e})},ee.maxSize=function(e){return ee({maxSize:e})},ee.promise=ee({isPromise:!0,updateExpire:!0}),ee.react=ee({isReact:!0}),ee.reactSimple=ee({isReact:!0,maxSize:1}),ee.serialize=ee({isSerialized:!0}),ee.simple=ee({maxSize:1}),e.collectStats=v,e.default=ee,Object.defineProperty(e,"__esModule",{value:!0})}(t)},YnhK:function(e,t,n){"use strict";n.d(t,"a",(function(){return h}));var r,i=n("VXtF"),s=n("7af5"),o=n("UMnf"),a=n("EbSe"),c=n("39GT"),u=n("+ZTy");!function(e){e[e.None=0]="None",e[e.Throttle=1]="Throttle",e[e.Debounce=2]="Debounce"}(r||(r={}));const d={[r.Throttle]:[],[r.Debounce]:[i.g.ConversationChange,i.g.MessageUpsert,i.g.ConversationUpsert]};class h{constructor(){this.subscriptions=new Map}subscribe(e,t){var n,s;if(!Object.values(i.g).includes(e))throw new c.a({type:i.d.InvalidParam,msg:"unknown event: "+e,sender:this});this.subscriptions.has(e)||this.subscriptions.set(e,new o.a);const a=this.subscriptions.get(e),h="number"===typeof(null===(n=u.a.Instance.option)||void 0===n?void 0:n.throttle)?u.a.Instance.option.throttle:1e3;if(!1===(null===(s=u.a.Instance.option)||void 0===s?void 0:s.throttle))return a.subscribe(t);if(d[r.Throttle].includes(e)){const e=this.throttle(t,h,h);return a.subscribe(e)}if(d[r.Debounce].includes(e)){const e=this.debounce(t,h,!0);return a.subscribe(e)}return a.subscribe(t)}unsubscribe(e,t){this.subscriptions.has(e)&&this.subscriptions.get(e).unsubscribe(t)}unsubscribeAll(){for(const e of Object.values(this.subscriptions))e.unsubscribeAll();this.subscriptions.clear()}emitEmpty(e,t){return this.emit(e,t,void 0)}emit(e,t,n){a.a.Instance.emitEvent(e,t,n);const r=this.subscriptions.get(e);r&&(n?s.a.Instance.debug(`emit event "${e}" with sender:`,t,", eventArgs:",n):s.a.Instance.debug(`emit event "${e}" with sender:`,t),r.next(n,t))}throttle(e,t,n){let r,i;return function(){const s=this,o=+new Date,a=arguments;clearTimeout(r),i||(i=o),o-i>=n?(e.apply(s,a),i=o):r=setTimeout(()=>{e.apply(s,a)},t)}}debounce(e,t,n=!1){let r,i,s,o=0;const a=function(){e.apply(i,s),o=Date.now()};return function(){const e=Date.now();if(i=this,s=arguments,r&&(clearTimeout(r),r=null),n&&0===o)return r=setTimeout(()=>{a()},t),a();const c=e-o,u=t-c;if(u>0)r=setTimeout(()=>{a()},u);else{if(n)return a();r=setTimeout(()=>{a()},t)}}}}h.Instance=new h},g98E:function(e,t,n){"use strict";n.d(t,"a",(function(){return d}));var r=n("+ZTy"),i=n("YnhK"),s=n("7af5"),o=n("Fjbr"),a=n("Hd7d"),c=n("EbSe"),u=function(e,t,n,r){return new(n||(n=Promise))((function(i,s){function o(e){try{c(r.next(e))}catch(t){s(t)}}function a(e){try{c(r.throw(e))}catch(t){s(t)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))};class d{preInstall(e,t){this.instance=e,this.coreContext=t,o.a.Instance=t.convManager,a.a.Instance=t.msgManager,i.a.Instance=t.eventBus,r.a.Instance=t.context,s.a.Instance=t.logger,c.a.Instance=t.montior}init(){return u(this,void 0,void 0,(function*(){}))}sendPacket(e){return u(this,void 0,void 0,(function*(){return e}))}receivePacket(e){return u(this,void 0,void 0,(function*(){}))}ticker(){return u(this,void 0,void 0,(function*(){}))}extendFunc(e){return e.bind(this)}dispose(){return u(this,void 0,void 0,(function*(){}))}}},q8ia:function(e,t,n){"use strict";n.d(t,"a",(function(){return r}));class r{constructor(e){this.parent=e}get conversationId(){return this.parent.id}get ext(){return this.innerExt||(this.innerExt={}),this.innerExt}set ext(e){this.innerExt=e}}},r7qN:function(e,t,n){"use strict";n.d(t,"a",(function(){return l}));var r=n("1277"),i=n("ba9d"),s=n("VXtF"),o=n("+ZTy"),a=n("Hd7d"),c=n("xIz2"),u=n("q8ia"),d=n("Wy+L"),h=n.n(d);class l{constructor(){this.isMember=!0,this.minIndex=r.ZERO,this._readIndex=r.ZERO,this.cacheUnreadCountCalc=void 0}get readIndex(){return this._readIndex}set readIndex(e){if(void 0===e)return;const t=r.fromValue(e);void 0!==this._readIndex?t.gt(this._readIndex)&&(this._readIndex=t):this._readIndex=t}get mode(){return 0}get isStrangerConversation(){return 0!==this.mode}get isMuted(){return void 0!==this.settingInfo&&this.settingInfo.mute===s.k.On}get isStickOnTop(){return void 0!==this.settingInfo&&this.settingInfo.stickTop===s.p.On}get isFavorite(){return void 0!==this.settingInfo&&this.settingInfo.favor===s.e.On}get ext(){let e={};return this.coreInfo&&this.coreInfo.ext&&(e=Object.assign(e,this.coreInfo.ext)),this.settingInfo&&this.settingInfo.ext&&(e=Object.assign(e,this.settingInfo.ext)),e}get rankScore(){const e=this.lastPopVisibleMessage;if(this.isStickOnTop){const t=8e15;return e?t+e.createdAt.getTime():t}return e?e.createdAt.getTime():-1}get lastMessage(){return this.filterLastMessage()}get lastVisibleMessage(){return this.filterLastMessage(e=>e.visible)}get lastPopVisibleMessage(){return this.filterLastMessage(e=>e.visible&&!e.unpop)}get firstMessage(){return this.filterFirstMessage()}get unreadCount(){var e,t;return void 0===this.cacheUnreadCountCalc&&(this.cacheUnreadCountCalc=h()((e=>this.unreadMessageList.length).bind(this),{maxSize:1})),this.cacheUnreadCountCalc(`${null===(e=this.updatedAt)||void 0===e?void 0:e.getTime()}:${null===(t=this.readIndex)||void 0===t?void 0:t.toString()}`)}forceRefreshUnreadCount(){const e=this.readIndex,t=this.unreadMessageList.length;if(e&&t!==this.unreadCount){this.readIndex=this.readIndex?this.readIndex.add(1):r.ZERO;this.unreadCount;this.readIndex=e}}get unreadMessageList(){if(!this.readIndex)return[];return a.a.Instance.getList(this.id).filter(e=>e.isNormalMsg&&!e.isFromMe&&e.indexInConversation.gt(this.readIndex)&&e.indexInConversation.gt(this.minIndex)&&e.increaseUnread&&e.visible)}get updatedAt(){return this.lastMessage?this.lastMessage.createdAt:new Date(0)}get firstMessageIndex(){var e,t;return null!==(t=null===(e=this.filterFirstMessage(e=>e.indexInConversation&&e.indexInConversation.gt(0)))||void 0===e?void 0:e.indexInConversation)&&void 0!==t?t:r.ZERO}get lastMessageIndex(){var e,t;return null!==(t=null===(e=this.filterLastMessage(e=>e.indexInConversation&&e.indexInConversation.gt(0)))||void 0===e?void 0:e.indexInConversation)&&void 0!==t?t:r.ZERO}get lastMessageOrder(){var e,t;return null!==(t=null===(e=this.filterLastMessage(e=>e.orderInConversation&&e.orderInConversation.gt(0)))||void 0===e?void 0:e.orderInConversation)&&void 0!==t?t:r.ZERO}getMessageList(e=(e=>e.visible)){return a.a.Instance.getList(this.id).filter(e)}get toParticipantUserId(){if(this.type===i.a.ConversationType.GROUP_CHAT)return;const e=this.id.split(":");return e[2]===o.a.Instance.userId?e[3]:e[2]}static fromServerConversation(e){const t=new l;t.id=e.conversation_id,t.shortId=e.conversation_short_id.toString(),t.type=e.conversation_type,t.ticket=e.ticket,t.participantCount=e.participants_count,t.isMember=e.is_participant,t.isOffline=!1,t.firstPageParticipant=e.first_page_participants,t.coreInfo=l.convertServerCoreInfo(t,e.conversation_core_info);const n=new u.a(t);return t.settingInfo=n,n.ext=e.conversation_setting_info.ext,n.favor=e.conversation_setting_info.favorite,n.mute=e.conversation_setting_info.mute,n.stickTop=e.conversation_setting_info.stick_on_top,n.version=e.conversation_setting_info.setting_version,t.readIndex=e.conversation_setting_info.read_index,t.minIndex=e.conversation_setting_info.min_index,t}static fromServerBroadcast(e){const t=new l;return t.id=e.conversation_id,t.shortId=e.conversation_short_id.toString(),t.type=e.conversation_type,t.isOffline=!1,t.coreInfo=l.convertServerCoreInfo(t,e),t}static convertServerCoreInfo(e,t){const n=new c.a(e);return t&&(n.desc=t.desc,n.ext=t.ext,n.icon=t.icon,n.name=t.name,n.notice=t.notice,n.owner=t.owner.toString(),n.version=t.info_version,n.secOwner=t.sec_owner,e.inboxType=t.inbox_type),n}filterLastMessage(e){const t=this.getMessageList(()=>!0);let n=null;if(0===t.length)return null;if(void 0===e)return t[t.length-1];for(let r=t.length-1;r>=0;r--)if(e(t[r])){n=t[r];break}return n}filterFirstMessage(e){const t=this.getMessageList(()=>!0);let n=null;if(0===t.length)return null;if(void 0===e)return t[0];for(const r of t)if(e(r)){n=r;break}return n}}},te6i:function(e,t,n){var r=null;e.exports=function(e){"use strict";var t,i,s,o,a={'"':'"',"\\":"\\","/":"/",b:"\b",f:"\f",n:"\n",r:"\r",t:"\t"},c=function(e){throw{name:"SyntaxError",message:e,at:t,text:s}},u=function(e){return e&&e!==i&&c("Expected '"+e+"' instead of '"+i+"'"),i=s.charAt(t),t+=1,i},d=function(){var e,t=!1,s="";for("-"===i&&(s="-",u("-"));i>="0"&&i<="9";)s+=i,u();if("."===i)for(t=!0,s+=".";u()&&i>="0"&&i<="9";)s+=i;if("e"===i||"E"===i)for(t=!0,s+=i,u(),"-"!==i&&"+"!==i||(s+=i,u());i>="0"&&i<="9";)s+=i,u();if(e=+s,isFinite(e))return t||Number(s).toString()===s?e:(null==r&&(r=n("1277")),r.fromString(s));c("Bad number")},h=function(){var e,t,n,r="";if('"'===i)for(;u();){if('"'===i)return u(),r;if("\\"===i)if(u(),"u"===i){for(n=0,t=0;t<4&&(e=parseInt(u(),16),isFinite(e));t+=1)n=16*n+e;r+=String.fromCharCode(n)}else{if("string"!==typeof a[i])break;r+=a[i]}else r+=i}c("Bad string")},l=function(){for(;i&&i<=" ";)u()};return o=function(){switch(l(),i){case"{":return function(){var e,t={};if("{"===i){if(u("{"),l(),"}"===i)return u("}"),t;for(;i;){if(e=h(),l(),u(":"),Object.hasOwnProperty.call(t,e)&&c('Duplicate key "'+e+'"'),t[e]=o(),l(),"}"===i)return u("}"),t;u(","),l()}}c("Bad object")}();case"[":return function(){var e=[];if("["===i){if(u("["),l(),"]"===i)return u("]"),e;for(;i;){if(e.push(o()),l(),"]"===i)return u("]"),e;u(","),l()}}c("Bad array")}();case'"':return h();case"-":return d();default:return i>="0"&&i<="9"?d():function(){switch(i){case"t":return u("t"),u("r"),u("u"),u("e"),!0;case"f":return u("f"),u("a"),u("l"),u("s"),u("e"),!1;case"n":return u("n"),u("u"),u("l"),u("l"),null}c("Unexpected '"+i+"'")}()}},function(e,n){var r;return s=e+"",t=0,i=" ",r=o(),l(),i&&c("Syntax error"),"function"===typeof n?function e(t,r){var i,s=t[r];return s&&"object"===typeof s&&Object.keys(s).forEach((function(t){void 0!==(i=e(s,t))?s[t]=i:delete s[t]})),n.call(t,r,s)}({"":r},""):r}}},twed:function(e,t,n){var r=n("1277"),i=e.exports;!function(){"use strict";var e,t,n,s=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,o={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"};function a(e){return s.lastIndex=0,s.test(e)?'"'+e.replace(s,(function(e){var t=o[e];return"string"===typeof t?t:"\\u"+("0000"+e.charCodeAt(0).toString(16)).slice(-4)}))+'"':'"'+e+'"'}"function"!==typeof i.stringify&&(i.stringify=function(i,s,o){var c;if(e="",t="","number"===typeof o)for(c=0;c<o;c+=1)t+=" ";else"string"===typeof o&&(t=o);if(n=s,s&&"function"!==typeof s&&("object"!==typeof s||"number"!==typeof s.length))throw new Error("JSON.stringify");return function i(s,o){var c,u,d,h,l,f=e,g=o[s],v=null!=g&&(g instanceof r||r.isLong(g));switch(g&&"object"===typeof g&&"function"===typeof g.toJSON&&(g=g.toJSON(s)),"function"===typeof n&&(g=n.call(o,s,g)),typeof g){case"string":return a(g);case"number":return isFinite(g)?String(g):"null";case"boolean":case"null":return String(g);case"object":if(!g)return"null";if(v)return g.toString();if(e+=t,l=[],"[object Array]"===Object.prototype.toString.apply(g)){for(h=g.length,c=0;c<h;c+=1)l[c]=i(c,g)||"null";return d=0===l.length?"[]":e?"[\n"+e+l.join(",\n"+e)+"\n"+f+"]":"["+l.join(",")+"]",e=f,d}if(n&&"object"===typeof n)for(h=n.length,c=0;c<h;c+=1)"string"===typeof n[c]&&(d=i(u=n[c],g))&&l.push(a(u)+(e?": ":":")+d);else Object.keys(g).forEach((function(t){var n=i(t,g);n&&l.push(a(t)+(e?": ":":")+n)}));return d=0===l.length?"{}":e?"{\n"+e+l.join(",\n"+e)+"\n"+f+"}":"{"+l.join(",")+"}",e=f,d}}("",{"":i})})}()},xIz2:function(e,t,n){"use strict";n.d(t,"a",(function(){return r}));class r{constructor(e){this.parent=e}get conversationId(){return this.parent.id}get ext(){return this.innerExt||(this.innerExt={}),this.innerExt}set ext(e){this.innerExt=e}}},xQJc:function(e,t,n){"use strict";n.d(t,"a",(function(){return h}));var r=n("ba9d"),i=n("VXtF"),s=n("+ZTy"),o=n("39GT"),a=n("7af5"),c=n("Fjbr"),u=n("EbSe"),d=function(e,t,n,r){return new(n||(n=Promise))((function(i,s){function o(e){try{c(r.next(e))}catch(t){s(t)}}function a(e){try{c(r.throw(e))}catch(t){s(t)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))};class h{constructor(e){this.manager=e}send(e,t,n={}){var h,l;return d(this,void 0,void 0,(function*(){const d=u.a.performanceNow();try{(null===(h=s.a.Instance.option)||void 0===h?void 0:h.webSocketLevel)===i.q.PushOnly&&(n.forceHttp=!0),(null===(l=s.a.Instance.option)||void 0===l?void 0:l.webSocketLevel)===i.q.All&&(n.forceHttp=!1);const g=yield this.manager.send(e,t,{inboxType:n.inboxType,maxHttpRetryTimes:n.forceHttp?n.maxRetryTimes:1,maxWsRetryTimes:n.forceHttp?0:n.maxRetryTimes,useBeacon:n.useBeacon});if(n.useBeacon)return u.a.Instance.emitCounter(u.b.ReqSuccess,1,{cmd:r.a.IMCMD[t]}),u.a.Instance.emitDuration(u.b.ReqSuccess,d,{cmd:r.a.IMCMD[t]}),r.a.ResponseBody.create({});if(0!==g.status_code){u.a.Instance.emitCounter(u.b.ReqError,1,{cmd:r.a.IMCMD[t],status:g.status_code.toString()}),u.a.Instance.emitDuration(u.b.ReqError,d,{cmd:r.a.IMCMD[t]});const h=i.o[g.status_code];if(!h)throw new o.a({msg:"unknown server error, status code: "+g.status_code,type:i.d.Unknown,sender:this});switch(h){case i.d.DegradationError:throw new o.a({msg:"server degradation",type:i.d.DegradationError,sender:this});case i.d.InvalidTicket:if(t===r.a.IMCMD.SEND_MESSAGE){const r=e.send_message_body.conversation_id,s=c.a.Instance.get(r),a=s.ticket;yield c.a.Instance.refreshTicket(s.id);if(a!==s.ticket||n.isRetryReq)return this.send(e,t,Object.assign(Object.assign({},n),{isRetryReq:!0}));throw new o.a({msg:"invalid ticket for conv: "+r,type:i.d.InvalidTicket,sender:this})}break;case i.d.ExpiredToken:const u=s.a.Instance.cachedToken;try{yield this.manager.refreshToken();const r=s.a.Instance.cachedToken;if(u===r||n.isRetryReq)throw new o.a({msg:"token refresh fail: "+r,type:i.d.TokenFuncError,sender:this});return a.a.Instance.debug("refresh token due to invalid"),this.manager.closeWs(!0),this.send(e,t,Object.assign(Object.assign({},n),{isRetryReq:!0}))}catch(f){throw f.type?f:new o.a({msg:"token refresh func error: ",type:i.d.TokenFuncError,innerError:f,sender:this})}default:throw new o.a({msg:i.d[h]+":"+g.error_desc,type:h,sender:this})}}if(g.body)return u.a.Instance.emitCounter(u.b.ReqSuccess,1,{cmd:r.a.IMCMD[t]}),u.a.Instance.emitDuration(u.b.ReqSuccess,d,{cmd:r.a.IMCMD[t]}),g.body;throw new o.a({msg:"no response body",type:i.d.Unknown,sender:this})}catch(g){if(void 0===g)throw new o.a({msg:"unknown error",type:i.d.Unknown,sender:this});throw g.type?g:new o.a({msg:"request error",type:i.d.Unknown,innerError:g,sender:this})}}))}}},z1lN:function(e,t,n){var r=n("twed").stringify,i=n("te6i");e.exports=function(e){return{parse:i(e),stringify:r}},e.exports.parse=i(),e.exports.stringify=r}}]);